<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=x-ua-compatible content="ie=edge"><title>A real life use-case for generics in Go: API for client-side pagination - Vladimir Varankin</title><link rel=canonical href=https://vladimir.varank.in/notes/2022/05/a-real-life-use-case-for-generics-in-go-api-for-client-side-pagination/><meta property="og:title" content="A real life use-case for generics in Go: API for client-side pagination"><meta property="og:description" content="Let&rsquo;s say we have a RESTful API for a general ledger, with the endpoints, that return a paginated collection of resources:

GET /accounts, retrieves a list of accounts, filtered and sorted by some query parameters;
GET /accounts/:uuid/transactions, retrieves a list of transactions for account;
GET /postings, retrieves a list of postings stored in the ledger.
"><meta property="og:type" content="article"><meta property="og:url" content="https://vladimir.varank.in/notes/2022/05/a-real-life-use-case-for-generics-in-go-api-for-client-side-pagination/"><meta property="article:section" content="notes"><meta property="article:published_time" content="2022-05-17T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-17T00:00:00+00:00"><style>:root{--background-color:#fff;--text-color:rgb(19, 19, 19);--text-underline-color:rgba(19, 19, 19, 0.5);--header-color:#111;--hr-color:rgb(143, 150, 163);--link-color:rgb(0, 16, 161);--link-underline-color:rgba(0, 16, 161, 0.3);--link-active-color:rgb(231, 19, 19);--link-active-underline-color:rgba(231, 19, 19, 0.7);--tag-color:rgb(85, 63, 63);--tag-underline-color:rgba(85, 63, 63, 0.5)}html{font-size:16px;height:100%;margin:0;padding:0}body{background:var(--background-color);color:var(--text-color);display:grid;grid-template-rows:auto 1fr auto;font-family:Charter,Georgia,serif;font-size:1.1rem;line-height:1.3;margin:5px 1%;margin:5px max(7px,1%);margin:5px clamp(7px,1.5vw,14px);min-height:calc(100vh - 10px)}h1,h2,h3,h4,h5,h6{color:var(--header-color);font-family:Athelas,Georgia,serif;line-height:1;margin:1.5em 0 .7em}h1{font-size:40px;margin:.5em 0 .2em}a{color:#0010a1;color:var(--link-color);text-decoration-color:var(--link-underline-color);text-decoration-thickness:.04em;text-underline-offset:.1em}a:hover,a:active{color:#be0000;color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}ul,ol{box-sizing:border-box;max-width:760px;padding:0}ol{padding-left:1.2em}ul>li{list-style:none;margin:.5em 0}figure{margin:0;margin-block-start:1em;margin-block-end:1em;padding:0}figcaption{font-size:16px;font-style:italic}pre{line-height:1.1;margin:2em 1em}code{font-family:sf mono,Menlo,Consolas,monospace;font-size:16px}pre code{font-size:15px;tab-size:4}hr{color:var(--hr-color);border:none;border-bottom:1px solid;margin:.5em 0;width:76%}.site-nav{display:flex;flex-wrap:wrap;letter-spacing:.3em;padding-bottom:16px}.site-nav a,.site-nav span{margin-right:.6em;letter-spacing:0}.site-nav-item-active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}.site-content{font-size:19px;max-width:940px}.site-content img{max-width:100%;max-width:calc(100vw - 15px)}.site-content pre{max-width:calc(100vw - 2em);overflow-x:visible}.site-footer{font-size:14px;margin:50px 0 0}.site-footer a{color:var(--text-color);text-decoration-color:inherit;text-decoration-color:var(--text-underline-color)}.main-head{display:flex;align-items:baseline;gap:8px}.main-head-meta{font-size:16px;margin:0;padding:0}.main-head-meta a{color:var(--text-color);text-decoration-color:inherit;text-decoration-color:var(--text-underline-color);margin:0 5px 0 0}.main-head-meta a:hover,.main-head-meta a:active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}.article{margin:0 0 50px}.article:last-child{margin-bottom:0}.section-head{font-size:28px}.section-head h1,.section-head h2{font-size:1em;margin-top:1em}.section-head h2{margin-bottom:0}.snippet{margin:0 0 40px}.snippet:last-of-type{margin:0}.snippet p{margin:0 0 .3em}.snippet-head h2{font-size:21px;margin:1em 0 .2em}.meta{font-size:14px;line-height:1;padding:5px 0 0}.tag{color:var(--tag-color);text-decoration-color:var(--tag-underline-color);margin:0 0 0 7px;text-transform:lowercase}.meta-topics-list{line-height:1.4;padding:34px 0 0}.meta-topics-list .tag{display:inline-block;margin:0 1ex 0 0}.glitch:before{background:var(--background-color);position:absolute;content:attr(data-text);clip:rect(0,900px,0,0);animation:glitch-anim 2s infinite linear alternate-reverse;margin-left:-5px;text-shadow:1px 0 red}@media(prefers-reduced-motion){.glitch:before{display:none}}@keyframes glitch-anim{0%{clip:rect(3px,9999px,93px,0)}5%{clip:rect(53px,9999px,78px,0)}10%{clip:rect(10px,9999px,75px,0)}15%{clip:rect(32px,9999px,40px,0)}20%{clip:rect(65px,9999px,62px,0)}25%{clip:rect(31px,9999px,14px,0)}30%{clip:rect(94px,9999px,87px,0)}35%{clip:rect(81px,9999px,41px,0)}40%{clip:rect(45px,9999px,50px,0)}45%{clip:rect(82px,9999px,41px,0)}50%{clip:rect(71px,9999px,3px,0)}55%{clip:rect(75px,9999px,60px,0)}60%{clip:rect(20px,9999px,49px,0)}65%{clip:rect(67px,9999px,92px,0)}70%{clip:rect(47px,9999px,55px,0)}75%{clip:rect(63px,9999px,90px,0)}80%{clip:rect(70px,9999px,92px,0)}85%{clip:rect(41px,9999px,60px,0)}90%{clip:rect(56px,9999px,79px,0)}95%{clip:rect(21px,9999px,68px,0)}100%{clip:rect(15px,9999px,72px,0)}}</style></head><body><nav class=site-nav><a href=/ class=glitch data-text="Vladimir Varankin">Vladimir Varankin</a>
<a href=/notes/ class=site-nav-item-active>Notes</a>
<a href=/publications/>Publications</a>
<span>·</span>
<a href=https://github.com/narqo>GitHub</a>
<a href=https://twitter.com/tvii>Twitter</a>
<a href=https://t.me/varankinv>Telegram</a>
<a href=https://keybase.io/varankinv>Keybase</a></nav><main class=site-content><header class=section-head><h1>A real life use-case for generics in Go: API for client-side pagination</h1></header><p>Let&rsquo;s say we have a RESTful API for a general ledger, with the endpoints, that return a paginated collection of resources:</p><ol><li><code>GET /accounts</code>, retrieves a list of accounts, filtered and sorted by some query parameters;</li><li><code>GET /accounts/:uuid/transactions</code>, retrieves a list of transactions for account;</li><li><code>GET /postings</code>, retrieves a list of <a href=https://en.wikipedia.org/wiki/Double-entry_bookkeeping>postings</a> stored in the ledger.</li></ol><p><em>The actual structure and the response body are the implementation details, and aren&rsquo;t important here.</em></p><p>With Go 1.18 we may spec out the methods of a client for this API as a corresponding <code>List*</code> methods, that return a generic type <code>Pager[T any]</code>:</p><pre tabindex=0><code>type LedgerAPIClient struct {
    // unexported fields
}

func (c *LedgerAPIClient) ListAccounts(context.Context, ListAccountsInput) *Pager[Account] { ··· }

func (c *LedgerAPIClient) ListAccountTransactions(context.Context, ListAccountTransactionsInput) *Pager[Transaction] { ··· }

func (c *LedgerAPIClient) ListPostings(context.Context, ListPostingsInput) *Pager[Posting] { ··· }
</code></pre><p>The API of the generic type <code>Pager[T any]</code> can look as following:</p><pre tabindex=0><code>// PagerDone is a sentinel error, which pager&#39;s NextPage and PrevPage methods return,
// when there aren&#39;t any more pages to iterate over.
var PagerDone = errors.New(&#34;no more pages to iterate&#34;)

type Pager[T any] struct {
    // unexported fields
}

// NextPage retrieves the next page in the collection of T.
// It returns PagerDone error after it reaches the last page.
func (p *Pager[T]) NextPage() ([]T, error) { ··· }

// PrevPage retrieves the previous page in the collection of T.
// It returns PagerDone error after it reaches the first page.
func (p *Pager[T]) PrevPage() ([]T, error) { ··· }

type PageInfo struct {
    Token   string
    HasNext bool
    HasPrev bool
}

// PageInfo returns a metadata about the current page.
func (p *Pager[T]) PageInfo() PageInfo { ··· }
</code></pre><p>In order to traverse through the collection of the resources, the users of our <code>LedgerAPIClient</code> call the <code>List*</code> method of the relevant API resource, and iterate through the returned pager, until the latter is exhausted, or the user is satisfied with the results at hands:</p><pre tabindex=0><code>c := api.NewLedgerAPIClient()

pager := c.ListAccounts(ctx, input)
for {
    accs, err := pager.NextPage()
    if errors.Is(err, api.PagerDone) {
        break
    }
    if err != nil { ··· }

    for _, acc := range accs {
        // do something with this page&#39;s list of accounts
    }
}
</code></pre><p>Let&rsquo;s say, for a certain use-case it&rsquo;s more convenient to work with the collection as if it wasn&rsquo;t a paginated list of resources, but as if it was a continuous stream of individual recourses.</p><p>What is nice about this implementation is that a generic type <code>Pager[T]</code> implements a generic interface:</p><pre tabindex=0><code>type pageIterator[T any] interface {
    NextPage() ([]T, error)
}
</code></pre><p>We can implement <em>another</em> generic helper, that accepts a <code>pageIterator[T any]</code> interface, and uses it to scan through the whole collection, returning the items one after another. Thanks to generics, we can implement that once, and it will work with any type of resource in our API client, while providing a user a strongly typed API to work with:</p><pre tabindex=0><code>type PageScanner[T any] struct {
    Pager pageIterator[T]
    // a buffer of items yet to be conumed by the user
    list [T]
}

// Next returns next item from the underlying pager.
func (s *PageScanner[T any]) Next() (item T, err error) {
    for len(s.list) == 0 {
        s.list, err = s.Pager.NextPage()
        if err != nil {
            return item, err
        }
    }

    item = s.list[0]
    s.list = s.list[1:]

    return item, nil
}
</code></pre><p>That&rsquo;s how the user will apply that to their code:</p><pre tabindex=0><code>c := api.NewLedgerAPIClient()

pager := c.ListAccountTransactions(ctx, input)

// (caveat) it seems that, in Go 1.18 the compiler can&#39;t figure out the underlying type
// of the pager&#39;s list, so we have to specify the type explicitely, when create PageScanner[T]
scanner := &amp;api.PageScaner[Transaction]{
    Pager: pager,
}
for {
    trx, err := scanner.Next()
    if errors.Is(err, api.PagerDone) {
        break
    }
    if err != nil { ··· }

    // do something with an individual transaction
}
</code></pre><footer class=meta><time datetime=2022-05-17T12:00:00Z>May 17, 2022</time><a class=tag href=/notes/go/>Go</a></footer><section class="meta meta-topics-list"><header class=meta-topics-list-title><h3>All topics</h3></header><a class=tag href=https://vladimir.varank.in/notes/aarch64/>aarch64</a><a class=tag href=https://vladimir.varank.in/notes/arduino/>arduino</a><a class=tag href=https://vladimir.varank.in/notes/arm64/>arm64</a><a class=tag href=https://vladimir.varank.in/notes/askme/>askme</a><a class=tag href=https://vladimir.varank.in/notes/aws/>aws</a><a class=tag href=https://vladimir.varank.in/notes/berlin/>berlin</a><a class=tag href=https://vladimir.varank.in/notes/bookmarks/>bookmarks</a><a class=tag href=https://vladimir.varank.in/notes/buildkit/>buildkit</a><a class=tag href=https://vladimir.varank.in/notes/cgo/>cgo</a><a class=tag href=https://vladimir.varank.in/notes/coffee/>coffee</a><a class=tag href=https://vladimir.varank.in/notes/continuous-profiling/>continuous profiling</a><a class=tag href=https://vladimir.varank.in/notes/covid-19/>COVID-19</a><a class=tag href=https://vladimir.varank.in/notes/design/>design</a><a class=tag href=https://vladimir.varank.in/notes/docker/>docker</a><a class=tag href=https://vladimir.varank.in/notes/e-paper/>e-paper</a><a class=tag href=https://vladimir.varank.in/notes/english/>english</a><a class=tag href=https://vladimir.varank.in/notes/esp8266/>esp8266</a><a class=tag href=https://vladimir.varank.in/notes/firefox/>firefox</a><a class=tag href=https://vladimir.varank.in/notes/github-actions/>github actions</a><a class=tag href=https://vladimir.varank.in/notes/go/>Go</a><a class=tag href=https://vladimir.varank.in/notes/go-time-fm/>go time fm</a><a class=tag href=https://vladimir.varank.in/notes/graphql/>graphql</a><a class=tag href=https://vladimir.varank.in/notes/homelab/>homelab</a><a class=tag href=https://vladimir.varank.in/notes/ipv6/>IPv6</a><a class=tag href=https://vladimir.varank.in/notes/k3s/>k3s</a><a class=tag href=https://vladimir.varank.in/notes/kubernetes/>kubernetes</a><a class=tag href=https://vladimir.varank.in/notes/macos/>macos</a><a class=tag href=https://vladimir.varank.in/notes/material-design/>material design</a><a class=tag href=https://vladimir.varank.in/notes/mdns/>mDNS</a><a class=tag href=https://vladimir.varank.in/notes/ndppd/>ndppd</a><a class=tag href=https://vladimir.varank.in/notes/objective-c/>objective-c</a><a class=tag href=https://vladimir.varank.in/notes/postgresql/>postgresql</a><a class=tag href=https://vladimir.varank.in/notes/pprof/>pprof</a><a class=tag href=https://vladimir.varank.in/notes/profefe/>profefe</a><a class=tag href=https://vladimir.varank.in/notes/random/>random</a><a class=tag href=https://vladimir.varank.in/notes/raspberry-pi/>raspberry pi</a><a class=tag href=https://vladimir.varank.in/notes/travis-ci/>travis ci</a><a class=tag href=https://vladimir.varank.in/notes/vs-code/>vs code</a><a class=tag href=https://vladimir.varank.in/notes/waveshare/>waveshare</a><a class=tag href=https://vladimir.varank.in/notes/%C2%B5-benchmarks/>µ-benchmarks</a></section></main><footer class=site-footer>#НетВойне<br><a href=mailto:vladimir@varank.in>vladimir@varank.in</a></footer><img src=https://c.varank.in/hello/*https://vladimir.varank.in/notes/2022/05/a-real-life-use-case-for-generics-in-go-api-for-client-side-pagination/ style=position:absolute;left:-9999px decoding=async alt></body></html>