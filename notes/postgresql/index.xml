<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PostgreSQL on Vladimir Varankin</title><link>https://vladimir.varank.in/notes/postgresql/</link><description>Recent content in PostgreSQL on Vladimir Varankin</description><generator>Hugo</generator><language>en</language><lastBuildDate>Mon, 31 Oct 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://vladimir.varank.in/notes/postgresql/index.xml" rel="self" type="application/rss+xml"/><item><title>Bookmarks (issue 8)</title><link>https://vladimir.varank.in/notes/2022/10/bookmarks-8/</link><pubDate>Mon, 31 Oct 2022 00:00:00 +0000</pubDate><guid>https://vladimir.varank.in/notes/2022/10/bookmarks-8/</guid><description>&lt;p&gt;&lt;a href="https://changelog.com/podcast/510"&gt;Taking Postgres serverless&lt;/a&gt; (Changelog). &lt;a href="https://www.youtube.com/watch?v=rES0yzeERns"&gt;Neon: Serverless PostgreSQL&lt;/a&gt; (Heikki Linnakangas @ Carnegie Mellon University).&lt;/p&gt;
&lt;p&gt;&lt;a href="https://brooker.co.za/blog/2022/04/11/simulation.html"&gt;Simple simulations for system builders&lt;/a&gt; (&lt;a href="https://twitter.com/MarcJBrooker"&gt;Marc Brooker&lt;/a&gt;). System designers care about questions like &amp;ldquo;How will the system behave under overload?&amp;rdquo; or &amp;ldquo;How sensitive is the design to latency?&amp;rdquo;. By &amp;ldquo;writing small simulators that simulate the behaviour of simple models&amp;rdquo;, Marc shows an approach to explore and reason about the possible answers to such questions.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://fasterthanli.me/articles/the-http-crash-course-nobody-asked-for"&gt;The HTTP crash course nobody asked for&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://www.industrialempathy.com/posts/design-docs-at-google/"&gt;Design docs at Google&lt;/a&gt;. When not to write a design doc: A clear indicator that a doc might &lt;em&gt;not&lt;/em&gt; be necessary is when a design doc is an implementation manual, that doesn&amp;rsquo;t go into trade-offs, alternatives, and explanation of the decision-making; — write the actual application instead.&lt;/p&gt;</description></item><item><title>Bookmarks (issue 7)</title><link>https://vladimir.varank.in/notes/2022/09/bookmarks-7/</link><pubDate>Fri, 30 Sep 2022 00:00:00 +0000</pubDate><guid>https://vladimir.varank.in/notes/2022/09/bookmarks-7/</guid><description>&lt;p&gt;&lt;a href="https://www.acquired.fm/episodes/amazon-com"&gt;The complete history and strategy of Amazon.com&lt;/a&gt; and &lt;a href="https://www.acquired.fm/episodes/amazon-web-services"&gt;The complete history and strategy of AWS&lt;/a&gt; (Acquired podcast).
In the world, where the growth of storages is massively outpacing the improvements in the speed of the Internet, a database is the most sticky technology. That&amp;rsquo;s how AWS locks the enterprises in: it’s impossible to migrate the enterprise-grade of data out of AWS (&amp;ldquo;It took thirty years for Amazon to migrate off Oracle to AWS&amp;rdquo;).&lt;/p&gt;
&lt;p&gt;&lt;a href="https://www.youtube.com/playlist?list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf"&gt;CMU Intro to Database systems / Fall 2022&lt;/a&gt; (Carnegie Mellon University); &lt;a href="https://www.qwertee.io/blog/postgresql-b-tree-index-explained-part-1/"&gt;PostgreSQL B-Tree index explained, pt. 1&lt;/a&gt; (Qwertee).&lt;/p&gt;
&lt;p&gt;&lt;a href="https://aws.amazon.com/blogs/database/build-a-cqrs-event-store-with-amazon-dynamodb/"&gt;Build a CQRS event store with Amazon DynamoDB&lt;/a&gt; (AWS).&lt;/p&gt;</description></item><item><title>Bookmarks (issue 6)</title><link>https://vladimir.varank.in/notes/2022/08/bookmarks-6/</link><pubDate>Wed, 31 Aug 2022 00:00:00 +0000</pubDate><guid>https://vladimir.varank.in/notes/2022/08/bookmarks-6/</guid><description>&lt;p&gt;&lt;a href="https://www.youtube.com/watch?v=x9_9iaVszpM"&gt;Kubernetes antipatterns: CPU Limits&lt;/a&gt;. Always define CPU requests; never define CPU limits.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://www.depesz.com/2021/06/20/explaining-the-unexplainable-part-6-buffers/"&gt;Explaining the unexplainable: buffers in PostgreSQL&lt;/a&gt;. Shared buffers are those, which&amp;rsquo;re&amp;rsquo; &amp;ldquo;shared&amp;rdquo; between several DB sessions, i.e. data pages, indices, etc; local buffers, are &amp;ldquo;local&amp;rdquo; to a session, i.e. for temporal tables; temp buffers are for intermediate objects, i.e. when the DBMS does hashing and sorting.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://www.geekabyte.io/2022/08/rust-iterator-pattern-with-iter.html"&gt;Rust Iterator pattern with &lt;code&gt;iter()&lt;/code&gt;, &lt;code&gt;into_iter()&lt;/code&gt; and &lt;code&gt;iter_mut()&lt;/code&gt; methods&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/golang/go/discussions/54245"&gt;Standard iterator interface in Go&lt;/a&gt; (Ian Lance Taylor via GitHub Discussions).&lt;/p&gt;</description></item><item><title>Bookmarks (issue 3)</title><link>https://vladimir.varank.in/notes/2022/05/bookmarks-3/</link><pubDate>Tue, 31 May 2022 00:00:00 +0000</pubDate><guid>https://vladimir.varank.in/notes/2022/05/bookmarks-3/</guid><description>&lt;p&gt;&lt;a href="https://exercism.org/tracks/rust"&gt;Rust tracks on Exercism&lt;/a&gt;. More than 100 coding exercises to learn &lt;a href="https://www.rust-lang.org/"&gt;Rust&lt;/a&gt; through practice.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://www.postgresql.org/about/news/postgresql-anonymizer-10-privacy-by-design-for-postgres-2452/"&gt;PostgreSQL Anonymizer 1.0&lt;/a&gt;. A PostgreSQL extension for declarative data masking (&lt;a href="https://postgresql-anonymizer.readthedocs.io/en/latest/"&gt;docs and examples&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;&lt;a href="https://postgrespro.com/blog/pgsql/5969493"&gt;Queries in PostgreSQL: 4. Index scan&lt;/a&gt; (Postgres Pro). An in-depth overview of how PostgreSQL decides if it will use an index.
One particular thing I had no idea about before I read the article was that &amp;ldquo;The Index Scan cost is highly dependent on the &lt;em&gt;correlation&lt;/em&gt; between the physical order of the tuples on disk and the order in which the access method returns the IDs&amp;rdquo;. That explains several cases from my own experience, where postgres kept using &amp;ldquo;unexpected&amp;rdquo; sequential scans, after we added &amp;ldquo;another index&amp;rdquo; to the database.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://www.micahlerner.com/2022/04/24/monarch-googles-planet-scale-in-memory-time-series-database.html"&gt;Monarch: Google’s planet-scale in-memory time series database&lt;/a&gt; (&lt;a href="https://twitter.com/micahlerner"&gt;Micah Lerner&lt;/a&gt;). A review of the paper (&lt;a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/d84ab6c93881af998de877d0070a706de7bec6d8.pdf"&gt;PDF&lt;/a&gt;), which describes the latest iteration of Google&amp;rsquo;s in-house metrics system.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://google.aip.dev/"&gt;Google’s API Improvement Proposals (AIP)&lt;/a&gt;. A collection of design documents that summarize Google&amp;rsquo;s API design decisions.&lt;/p&gt;</description></item><item><title>Bookmarks (issue 1)</title><link>https://vladimir.varank.in/notes/2022/03/bookmarks-1/</link><pubDate>Thu, 31 Mar 2022 00:00:00 +0000</pubDate><guid>https://vladimir.varank.in/notes/2022/03/bookmarks-1/</guid><description>&lt;p&gt;&lt;a href="https://planetscale.com/blog/generics-can-make-your-go-code-slower"&gt;Generics can make your Go code slower&lt;/a&gt; (PlanetScale):&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;boxing vs monomorphization vs partial monomorphization (&amp;ldquo;GCShape stenciling with Dictionaries&amp;rdquo;)&lt;/li&gt;
&lt;li&gt;interface inlining doesn&amp;rsquo;t work well with the 1.18&amp;rsquo;s compiler&lt;/li&gt;
&lt;li&gt;generics work well for byte sequences (&lt;code&gt;string | []byte&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;in simple cases, generics can be useful for function callbacks.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;a href="https://engineering.fb.com/2022/03/30/security/de-identified-authentication-at-scale/"&gt;How Meta enables de-identified authentication at scale&lt;/a&gt;. The rational, the use-cases, and a high-level architecture of Meta&amp;rsquo;s Anonymous Credential Service (ACS).&lt;/p&gt;
&lt;p&gt;&lt;a href="https://aws.amazon.com/blogs/database/hidden-dangers-of-duplicate-key-violations-in-postgresql-and-how-to-avoid-them/"&gt;Hidden dangers of duplicate key violations in PostgreSQL&lt;/a&gt; (AWS). &lt;code&gt;INSERT … ON CONFLICT&lt;/code&gt; has additional benefits, if compared to relying on PostgreSQL&amp;rsquo;s &amp;ldquo;duplicate key violation&amp;rdquo; error:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;no additional space needed for dead tuples&lt;/li&gt;
&lt;li&gt;less autovacuum required&lt;/li&gt;
&lt;li&gt;transaction IDs aren&amp;rsquo;t used for nothing, preventing (postponing) the potential trx-id wraparound.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;a href="https://aws.amazon.com/blogs/containers/diving-into-iam-roles-for-service-accounts/"&gt;Diving into AWS IAM Roles for (Kubernetes) Service Accounts (IRSA)&lt;/a&gt;.&lt;/p&gt;</description></item><item><title>(You don't) Insert unicode NULL character as Postgres jsonb</title><link>https://vladimir.varank.in/notes/2021/01/you-dont-insert-unicode-null-character-as-postgres-jsonb/</link><pubDate>Thu, 14 Jan 2021 00:00:00 +0000</pubDate><guid>https://vladimir.varank.in/notes/2021/01/you-dont-insert-unicode-null-character-as-postgres-jsonb/</guid><description>&lt;p&gt;With JSON data type it’s easy to treat Postgres as a document database, which doesn’t need strong schema. One can define a table, that has a field of a type &lt;code&gt;jsonb&lt;/code&gt; and insert any valid JSON string (a “document”).&lt;/p&gt;
&lt;p&gt;I’ve learned lately, that Postgres’s &lt;code&gt;jsonb&lt;/code&gt; prohibits insertion of a valid JSON string if the string contains NULL (&lt;code&gt;U+0000&lt;/code&gt;) character. Postgres’s own &lt;a href="https://www.postgresql.org/docs/10/datatype-json.html"&gt;docs on JSON Types&lt;/a&gt; says:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;RFC 7159 permits JSON strings to contain Unicode escape sequences denoted by \uXXXX. In the input function for the json type, Unicode escapes are allowed regardless of the database encoding, and are checked only for syntactic correctness. However, the input function for &lt;code&gt;jsonb&lt;/code&gt; is stricter: it disallows Unicode escapes for non-ASCII characters (those above U+007F) unless the database encoding is UTF8. The &lt;code&gt;jsonb&lt;/code&gt; type also rejects \u0000 (because that cannot be represented in PostgreSQL&amp;rsquo;s text type), and it insists that any use of Unicode surrogate pairs to designate characters outside the Unicode Basic Multilingual Plane be correct.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;In my case, a Go backend inserts tracing logs to Postgres. A trace consists of multiple “spans”, some of which can contain the reply from an external API. As we found out, sometimes, in the event of a failure, the API replies with an empty GIF &amp;lt;&lt;em&gt;facepalm/&lt;/em&gt;&amp;gt;. Our backend converts the response to a string, marshals it to a JSON and later tries to insert the JSON into a Postgres table.&lt;/p&gt;
&lt;p&gt;Consider the following Go code:&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;// data is an empty GIF
var data = []byte{
 0x47, 0x49, 0x46, 0x38, 0x39, 0x61, 0x01, 0x00,
 0x01, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
 0xff, 0xff, 0xff, 0x21, 0xf9, 0x04, 0x01, 0x00,
 0x00, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x00,
 0x01, 0x00, 0x01, 0x00, 0x00, 0x02, 0x01, 0x44,
 0x00, 0x3b,
}

func main() {
 v, _ := json.Marshal(struct {
 Resp interface{} `json:&amp;#34;resp,omitempty&amp;#34;`
 }{
 Resp: string(data),
 })
 fmt.Printf(&amp;#34;%s\n&amp;#34;, v)
 // Output (truncated for readability):
 // {&amp;#34;resp&amp;#34;:&amp;#34;GIF89a\u0001\u0000\u0001\u0000\ufffd\···\u0001D\u0000;&amp;#34;}
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Above, &lt;code&gt;json.Marshal&lt;/code&gt; produces a perfectly valid JSON. But if I try to insert it into a Postgres table as &lt;code&gt;jsonb&lt;/code&gt;, the insert fails with “unsupported Unicode escape sequence”:&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;= CREATE TABLE logs (data jsonb);
= INSERT INTO logs VALUES (&amp;#39;{&amp;#34;resp&amp;#34;:&amp;#34;GIF89a\u0001\u0000\u0001\u0000\ufffd\···\u0001D\u0000;&amp;#34;}&amp;#39;);

ERROR: unsupported Unicode escape sequence
LINE 1: insert into logs values (&amp;#39;{&amp;#34;resp&amp;#34;:&amp;#34;GIF89a\u0001\u0000\u0001\...
 ^
DETAIL: \u0000 cannot be converted to text.
CONTEXT: JSON data, line 1: {&amp;#34;resp&amp;#34;:...
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Because in my code, there were only a couple of places where I didn&amp;rsquo;t control the actual data, that went into a span, the way I’ve chosen to handle that was by introducing a wrapper type, that implements &lt;code&gt;json.Marshaller&lt;/code&gt;. The wrapper checks the value is a valid UTF-8 sequence and doesn’t contain &lt;code&gt;NULL&lt;/code&gt; character before it marshals the value into a JSON string. If the value is not a valid UTF-8, the marshaller sees it as a binary data and base64-encodes it.&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;// RawText handles invalid UTF-8 and NULL-bytes, encoding them as base64-string.
// Because we have to make sure the resulting JSON will be compatible with Postgres&amp;#39;s jsonb,
// we must use RawText when we don&amp;#39;t control the data, e.g. when log the error from an external API.
// Refer to https://www.postgresql.org/docs/10/datatype-json.html
type RawText []byte

func (v RawText) MarshalEasyJSON(w *Writer) {
 if utf8.Valid(v) &amp;amp;&amp;amp; !bytes.ContainsRune(v, &amp;#39;\u0000&amp;#39;) {
 // &amp;#34;valid&amp;#34; text is marshalled as string
 w.String(string(v))
 } else {
 // &amp;#34;invalid&amp;#34; text is marshalled as binary data
 w.Raw(json.Marshal([]byte(v)))
 }
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Note, the code above is a marshaller for &lt;a href="https://github.com/mailru/easyjson"&gt;github.com/mailru/easyjson&lt;/a&gt;, which we use in the project.&lt;/p&gt;
&lt;p&gt;Here is how it looks in practice:&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;func main() {
 v, _ := json.Marshal(struct {
 Resp1 interface{} `json:&amp;#34;resp1,omitempty&amp;#34;`
 Resp2 interface{} `json:&amp;#34;resp2,omitempty&amp;#34;`
 }{
 Resp1: RawText(bin), // wrap the bin data into RawText
 Rest2: RawText(&amp;#34;normal string&amp;#34;), // wrap (copy) a string into RawText
 })
 fmt.Printf(&amp;#34;%s\n&amp;#34;, v)
 // Output:
 // {
 // &amp;#34;resp1&amp;#34;:&amp;#34;R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7&amp;#34;,
 // &amp;#34;resp2&amp;#34;:&amp;#34;normal string&amp;#34;
 // }
}
&lt;/code&gt;&lt;/pre&gt;</description></item></channel></rss>