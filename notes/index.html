<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Notes - Vladimir Varankin</title><link rel=canonical href=https://vladimir.varank.in/notes/><link rel=alternate type=application/rss+xml href=https://vladimir.varank.in/notes/index.xml title="Notes from Vladimir Varankin"><meta property="og:title" content="Notes"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://vladimir.varank.in/notes/"><meta property="og:updated_time" content="2020-12-29T00:00:00+00:00"><style>:root{--background-color: #fff;--text-color: #131313;--header-color: #111;--link-color: rgb(0, 16, 161);--link-underline-color: rgba(0, 16, 161, 0.3);--link-active-color: rgb(231, 19, 19);--link-active-underline-color: rgba(231, 19, 19, 0.7)}html{font-size:16px;height:100%;margin:0;padding:0}body{background:var(--background-color);color:var(--text-color);display:grid;grid-template-rows:auto 1fr auto;font-family:Charter,Georgia,serif;font-size:1.1rem;line-height:1.4;margin:5px 1%;min-height:calc(100vh - 10px)}h1,h2,h3,h4,h5,h6{color:var(--header-color);font-family:Athelas,Georgia,serif;line-height:1;margin:1.5em 0 .7em}h1{font-size:40px;margin:.5em 0 .2em}a{color:#0010a1;color:var(--link-color);text-decoration-color:var(--link-underline-color)}a:hover,a:active{color:#be0000;color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}ul,ol{box-sizing:border-box;max-width:760px;padding:0}ol{padding-left:1.2em}ul>li{list-style:none;margin:.5em 0}pre{line-height:1.4;margin:1em 1.5em}code{font-family:Menlo,Consolas,monospace;font-size:15px}pre code{font-size:14px}hr{border:none;border-bottom:1px solid;width:90%}.main-nav{display:flex;letter-spacing:.3em;padding-bottom:16px}.main-nav a,.main-nav span{margin-right:.6em;letter-spacing:0}.main-nav-item-active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}.main-content{max-width:940px}.main-footer{font-size:14px;margin:0}.article{margin:0 0 50px}.article-head{font-size:28px}.article-head h1,.article-head h2{font-size:1em;margin-top:1em}.article-head h2{margin-bottom:0}.article-meta{font-size:14px;line-height:1;padding:5px 0 0}.tag{margin:0 0 0 7px}</style></head><body><nav class=main-nav><a href=/>Vladimir Varankin</a>
<a href=/notes/ class=main-nav-item-active>Notes</a>
<a href=/publications/>Publications</a>
<a href=https://github.com/narqo>GitHub</a>
<a href=https://twitter.com/tvii>Twitter</a>
<a href=https://keybase.io/varankinv>Keybase</a></nav><main class=main-content><header class=main-head><h1>Notes</h1></header><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/12/2020-what-a-year/>2020, what a year</a></h2></header><p>2020 was (technically, still is) an extraordinary year. For many people, this was the worse, the weirdest, the most depressing year; the year we wish was a bad dream. With all the respect for the terrible things, lots of people went through, for me, it was a year to remember.</p><p>In 2020 I learned how to work from home. It’s still not super fun, but it’s possible. As I look at that now, there are obvious benefits: I can start and end my day much more freely; I currently don’t feel much pressure when willing to go for a walk or a run at 11:00, or when I finish my workday at 16:00 (I tend to start around 8:30 while at home). But that being said, I still don’t consider staying full-remote and want to go back to the office, co-working, or a random coffee bar.</p><p>In 2020 I bought a bicycle. After tree years in Berlin, I’m now &ldquo;one of those people&rdquo; :) Can’t say I’m super excited about the acquisition, generally because I live in the walking distance from the office. With the bicycle, the “trip” is less than ten minutes shorter. I have to wait at the traffic lights a lot; plus have to spend extra minutes to lock/unlock the bicycle.</p><p>In 2020 we adopted a cat. The CAT, who’s now called Gagarin! He came from the middle of &ldquo;nowhere-Russia&rdquo; as a frightened little kitten and spent the first month under the bed, avoiding walking under the light. And now, after four months he comes to have a nap on our pillow (and on my head) at 7:00, as a way to signal that it’s time to feed him.</p><p>In 2020 I walked, on average, one kilometre per day more, than in the previous year (5 km vs 4 km currently; winter isn’t much of a walking season for me). A bit of surprise but, overall, I walked 1000 km less this year, than I made in 2019. I bet that’s because we didn’t travel much (obviously) and didn’t have a chance to explore a new city, neither in later Spring, nor on Christmas.</p><p>In 2020 I assembled my four nodes Raspberry Pi Kubernetes cluster, but I haven’t made much use of it yet. As promised to my self in December 2019, during the year I learned and touched some new Kubernetes details, and I have tons of things I still want to delve into and understand on a more in-depth level of details.</p><p>In 2020 I started to learn Rust. I tried that in 2018 and in 2019. But this year, I actually spent a month or two writing code, not only reading/watching/listening to/following the content. It feels refreshing. Programming for embedded devices and game-dev are the most attractive fields, which I want to explore further with Rust.</p><p>In 2020 I had two job interviews. None of them was successful for me, although I tend to believe that I’ve passed both. I have plans to draft a note about the essential questions one must ask the HR during the first call.</p><p>In 2020 I did and learned, and read, and listen to, and watched, and thought about a bunch of things.</p><p>In 2021 I will do even better.</p><footer class=article-meta><time datetime=2020-12-29T12:00:00Z>December 29, 2020</time></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/12/on-code-reviews/>On code-reviews</a></h2></header><p><em>This is another thought experiment, this time on the importance of my feedback in the code-reviews.</em></p><p>Providing you’re working on a project maintained by a set team of N people. What would happen with the codebase if, for six months, in code-reviews, you started to accept changes for which, you generally leave feedback?</p><p>&ldquo;Variables, struct or function names are named poorly&rdquo; — accept. &ldquo;We already have a package, that solves a similar problem&rdquo; — accept. &ldquo;A change brings inconsistency to the codebase&rdquo; — accept. &ldquo;The pattern doesn’t belong here&rdquo; — accept.</p><p>Go is a famously opinionated programming language. But does being opinionated help and scale outside of the language and its standard library?</p><p><em>Do you have the answer? Discuss this note on <a href=https://www.reddit.com/r/golang/comments/k7aqxw/a_thought_experiment_on_importance_of_your/>r/golang Reddit</a> or share your thoughts on <a href=https://twitter.com/tvii/status/1335303528064094210>Twitter</a>.</em></p><footer class=article-meta><time datetime=2020-12-05T12:00:00Z>December 5, 2020</time><span class=tag>thought experiment</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/11/a-thought-experiment-on-apple-m1/>A thought experiment on Apple M1</a></h2></header><p>With Apple&rsquo;s new M1 Macs showing (<em>reportedly</em>) huge performance improvement, compared to &ldquo;old&rdquo;, Intel-based Macs, I wonder what would hold Qualcomm (Snapdragon CPU) and others from doing &ldquo;the same&rdquo; and moving into laptop/desktop territory?</p><p>Microsoft already has Surface Pro X — an ARM-based Windows computer. They also have a version of Win10 for ARM, that one can even run on Raspberry Pi (still beta quality, I believe). Could 2021 become the year of ARM on desktop?</p><p>Even more interesting, Amazon&rsquo;s Graviton is showing (<em>again, reportedly</em>) an excellent performance, while staying at reasonably low cost. What would stop Google/Microsoft from moving into ARM-based CPU territory for their clouds?</p><footer class=article-meta><time datetime=2020-11-24T12:00:00Z>November 24, 2020</time></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/09/vscode-font-variant/>Alternative font-variant in VS Code</a></h2></header><p>I&rsquo;m not a big fun of the aesthetics of <a href=https://code.visualstudio.com/>VS Code</a>, at least not on macOS. In particular, I don&rsquo;t like the way how its code editor renders fonts. But today I learned!</p><p>To make the fonts look better — I&rsquo;m on macOS — set an alternative font-variant, e.g. &ldquo;Comic Code Ligatures Medium&rdquo; instead of &ldquo;Regular&rdquo;, in the editor&rsquo;s settings. To specify font-variant, remove spaces in between the name of the font and pass the variant after the hyphen. That is, instead of <code>'Comic Code Ligatures'</code>, set the following:</p><pre><code>&quot;editor.fontFamily&quot;: &quot;'ComicCodeLigatures-Medium', monospace&quot;
</code></pre><hr><p><em>Full disclosure, my IDE of choice is <a href=https://www.jetbrains.com/go/>GoLand</a>, and it has been so since it was only a plugin for IntelliJ IDEA. Even though I can comfortably use VS Code or Vim when I need to make a small change or look something up in the code, I need the IDE to effectively work on a large codebase.</em></p><p>The backstory for this note is that I&rsquo;m working on a small TypeScript/React application in my spare time this month. For something that small, VS Code works <del>great</del> fine. In fact, I&rsquo;m writing this particular note in VS Code too ;)</p><footer class=article-meta><time datetime=2020-09-09T12:00:00Z>September 9, 2020</time><span class=tag>vs code</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/09/one-year-in-production/>One year in production</a></h2></header><p>It&rsquo;s one year since I posted the very first note here. Unbelivable! Despite my own concerns I did published random posts over the course of the previous twelve months.</p><p>For the next round I came up with some personal goals:</p><ol><li>Keep posting.</li><li>Work on your grammar.</li><li>Add &ldquo;Archive&rdquo; and &ldquo;Tags&rdquo; sections.</li><li>Find a better approach for managing drafts.</li><li>Bring back the dark theme but figure out what to do with the illustrations.</li><li>Keep posting ;)</li></ol><footer class=article-meta><time datetime=2020-09-01T12:00:00Z>September 1, 2020</time></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/08/does-profefe-prefers-push-over-pull/>Does profefe prefers "push" over "pull"?</a></h2></header><p>The main component of <a href=https://github.com/profefe/profefe>profefe, a system for continuous profiling</a>, is <em>profefe-collector</em> — a service that receives profiling data, taken from an application and persists the data in collector’s storage (<a href=https://github.com/profefe/profefe/blob/master/DESIGN.md>design document</a> describes it in more details). Receiving data from an external source (for example, <em>profefe-agent</em>), indicates that profefe, as an observability system, prefers &ldquo;push&rdquo; model. Why not &ldquo;pulling&rdquo; the profiles directly from the application?</p><p>Both push and pull models have their benefits and drawbacks.</p><p>A collector that pulls profiling data from running applications could simplify integration into existing infrastructure because there would be no need in making changes in the applications that already exposed pprof HTTP endpoint. Making sure that every application integrated and configured profefe-agent would be a challenging job in a large organisation.</p><p>On the other hand, pull model requires pprof servers to be exposed and available for the collector, so it could fetch (<em>pull</em>) profiling data. That can also be challenging in the deployments, where applications are collocated on the bare-metal machines. Every application (application&rsquo;s instance) would have to communicate a unique TCP port for its pprof server.</p><p>To work as a pull-system, the collector must be able to discover the pprof servers, thus it requires a mechanism for service discovery (SD), to be usable at scale. Unfortunately, there isn&rsquo;t a universal SD protocol or a provider, an observability system could be built upon.</p><p>Prometheus, the best example of an open-source system, which uses pull model for data collection, have to support several different SD systems in their code base. At some point they <a href=https://prometheus.io/blog/2018/07/05/implementing-custom-sd/>ended up introducing their own general protocol</a>, that expects a &ldquo;middle-man-service&rdquo;, which translates the data from a SD system into a list of Prometheus targets (<em>Update, <a href="https://www.reddit.com/r/golang/comments/idwi4d/does_profefe_a_system_for_continuous_profiling/g2by237/?utm_source=reddit&utm_medium=web2x&context=3">this comment from u/bbrazil</a> does a better job explaining the state of SD in Prometheus</em>). There is no clear way for an open-source system to be both flexible and don&rsquo;t end up being a pile of &ldquo;plugins&rdquo;, that no one is willing to maintain or break.</p><p>From the start of profefe project, several years ago, I had the idea that translating push into pull would be easier for an end-user. That is if a small deployment already exposes a pprof server, writing an external job that pulls the profiles from the applications, annotates them with meta-data, and pushes the data into the collector, can be as easy as spawning a cronjob in a sidecar. <a href=https://github.com/profefe/kube-profefe>kube-profefe</a> solves that nicely for deployments running in Kubernetes. At some point, I hoped to come up with something similar for Nomad+Consul if the experiments ended successfully.</p><p>Translating pull into push is a similarly possible but because profefe didn’t have to support any SD mechanisms from the start, that simplified the overall code base and allowed us to focus on the collector and the <a href=https://github.com/profefe/profefe#http-api>API for profiles quering</a>.</p><p>profefe-collector does uses push model. But one can deploy profefe so it reflected the use cases your organisation has.</p><p>Do you use continuous profiling? Let me know about your experience. Share your thoughts <a href=https://twitter.com/tvii/status/1296796503781122049>on Twitter</a> or <a href=https://www.reddit.com/r/golang/comments/idwi4d/does_profefe_a_system_for_continuous_profiling/>discuss on r/golang</a>.</p><footer class=article-meta><time datetime=2020-08-21T12:00:00Z>August 21, 2020</time><span class=tag>profefe</span><span class=tag>continuous profiling</span><span class=tag>go</span><span class=tag>pprof</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/08/how-to-design-a-good-api/>How to design a good API</a></h2></header><p>A good API is designed around the use-case. A poorly designed, around the API&rsquo;s implementation details.</p><footer class=article-meta><time datetime=2020-08-14T12:00:00Z>August 14, 2020</time></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/07/whats-in-your-main-dot-go/>What's in your main-dot-go? (aka New Go Project Boilerplate)</a></h2></header><p>Sometimes I write small services in Go from scratch. And every time <code>main.go</code> ends up looking almost the same:</p><pre><code>func main() {
	ctx, cancel := context.WithCancel(context.Background())
	defer cancel()

	sigs := make(chan os.Signal, 2)
	signal.Notify(sigs, os.Interrupt, syscall.SIGTERM)

	go func() {
		&lt;-sigs
		signal.Stop(sigs)
		cancel()
	}()

	if err := run(ctx, os.Args[1:]); err != nil {
		log.Fatalln(err)
	}
}

type Config struct {
	HTTPAddr            string
	HTTPShutdownTimeout time.Duration
}

func run(ctx context.Context, args []string) error {
	flags := flag.NewFlagSet(&quot;&quot;, flag.ExitOnError)

	var conf Config
	flags.StringVar(&amp;conf.HTTPAddr, &quot;http-addr&quot;, &quot;127.0.0.1:10080&quot;, &quot;address to listen on&quot;)
	flags.DurationVar(&amp;conf.HTTPShutdownTimeout, &quot;http-shutdown-timeout&quot;, 5*time.Second, &quot;server shutdown timeout&quot;)

	if err := flags.Parse(args); err != nil {
		return err
	}

	// TODO: define the handler, the routing, and wire the dependencies with the main context
	mux := http.NewServeMux()
	server := &amp;http.Server{
			Addr:    conf.HTTPAddr,
			Handler: mux,
	}

	errs := make(chan error, 1)
	go func() {
			log.Printf(&quot;starting: addr %s&quot;, server.Addr)
			errs &lt;- server.ListenAndServe()
	}()

	select {
	case &lt;-ctx.Done():
			log.Println(&quot;exiting...&quot;)
	case err := &lt;-errs:
			return err
	}

	// create new context because top-most one is already canceled
	ctx, cancel := context.WithTimeout(context.Background(), conf.HTTPShutdownTimeout)
	defer cancel()

	return server.Shutdown(ctx)
}
</code></pre><p>Of course, not every service requires an HTTP server, but the general idea stands.</p><hr><p>When Go will introduce <a href=https://github.com/golang/go/issues/37255><code>signal.NotifyContext()</code></a>, the signals handling in <code>main()</code> function will be much smaller (we&rsquo;re at go1.15rc1 as I&rsquo;m writing that and the change hasn&rsquo;t landed into the release yet).</p><hr><p>I love how transparent is the flow here and how everything is scoped inside <code>run()</code> function. This structure forces you to eliminate global state, making unit or integration testing <em>almost trivial</em> — at least, in theory ;)</p><p>It might feel like too much of boilerplate code for a &ldquo;small&rdquo; service. In practice, though, I don&rsquo;t recall any time this caused any real troubles to me. The beauty of Go is in explicitness.</p><footer class=article-meta><time datetime=2020-07-31T12:00:00Z>July 31, 2020</time><span class=tag>go</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/07/waveshare-esp8266-driver-board-pins-mapping/>Waveshare ESP8266 Driver Board Pins Mapping</a></h2></header><p>I&rsquo;ve been playing with an <a href=https://www.waveshare.com/product/iot-communication/short-range-wireless/wifi/e-paper-esp8266-driver-board.htm>e-paper ESP866 Driver Board</a>, and a <a href=https://www.waveshare.com/2.7inch-e-Paper.htm>2.7" E-Ink display</a> from Waveshare. Arduino C++ looks manageable. One strange thing, though. In both board’s documentation and <a href=https://github.com/ZinggJM/GxEPD2>GxEPD2</a> library’s examples, they say the display is connected to pins as BUSY → GPIO16, RST → GPIO5, DC → GPIO4, CS → GPIO15. This mapping seems wrong.</p><p>After digging through the code examples from <a href=https://github.com/ZinggJM/GxEPD2>Waveshare’s Wiki</a>, the correct mapping is the following:</p><p>BUSY → GPIO5,
RST → GPIO2,
DC → GPIO4,
CS → GPIO15</p><p>That&rsquo;s how the initialisation of the main <code>GxEPD2</code> class for my 2.7" display looks like now:</p><pre><code>#define ENABLE_GxEPD2_GFX 0
#include &lt;GxEPD2_BW.h&gt;

// mapping of Waveshare e-Paper ESP8266 Driver Board
GxEPD2_BW&lt;GxEPD2_270, GxEPD2_270::HEIGHT&gt; display(GxEPD2_270(/*CS=15*/ SS, /*DC=4*/ 4, /*RST=2*/ 2, /*BUSY=5*/ 5));
</code></pre><footer class=article-meta><time datetime=2020-07-14T12:00:00Z>July 14, 2020</time><span class=tag>waveshare</span><span class=tag>esp8266</span><span class=tag>e-paper</span><span class=tag>arduino</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/06/sticky-headers/>Sticky headers. Please don't</a></h2></header><p>Sticky (or &ldquo;<em>fixed</em>") headers are everywhere. It feels that every web designer’s first attempt to site&rsquo;s navigation starts with a sticky header. I hate it.</p><p>Interestingly, even Apple uses sticky headers on their website. On the main page of apple.com the navigation is the same dumb bar, that hangs at the top all the time and eats a good chunk of the screen.</p><p><img src=/images/2020/0617-apple-1-1100.jpg alt="main page on apple.com"></p><p>But let&rsquo;s go one page down:</p><p><img src=/images/2020/0617-apple-2-1100.jpg alt="product page on apple.com"></p><p>The navigation bar still floats around but it blends with the page. It’s contextual. It doesn’t distract you from looking at the product.</p><p>When the purpose of the page is to provide you with reading materials and doesn&rsquo;t require any actions from you, the bar just disapears from the design:</p><p><img src=/images/2020/0617-apple-3-1100.jpg alt="text page on apple.com"></p><p>Now, it’s only you and the text.</p><hr><p>For contrast, this is how Google does it:</p><p><img src=/images/2020/0617-google-1-1100.jpg alt="somewhere on cloud.google.com"></p><p>Yes, these are <em>three</em> sticky bars; one under another. No, I can’t believe there is a need for them to be on the screen all the time.</p><p>Or, this is the current design of <a href=https://pkg.go.dev>pkg.go.dev</a> (Google again), whose goal is to become the default documentation portal for Go modules and packages:</p><p><img src=/images/2020/0617-pkgsite-1-1100.jpg alt=pkg.go.dev></p><p>I’m sure these two bars at the page’s top are very important but I doubt they are more important than the content of this page.</p><footer class=article-meta><time datetime=2020-06-17T12:00:00Z>June 17, 2020</time><span class=tag>webdesign</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/04/owner-of-logging-context/>Owner of Logging Context</a></h2></header><p>There’s the late-night dilemma&mldr;</p><p><strong>Who should be in charge of logging context: a component&rsquo;s owner or the component itself?</strong></p><pre><code>type Logger interface {
	With(...kvpairs) Logger
}

type Storage struct {
	logger Logger
}

// OPTION 1: component's owner defines the context of component's logger
func main() {
	_ = NewStorage(logger.With(&quot;component&quot;, &quot;storage&quot;))
}

// OPTION 2: component itself is in charge of its logging context
func NewStorage(logger Logger) (st *Storage) {
	return &amp;Storage{
		logger: logger.With(&quot;component&quot;, &quot;storage&quot;),
	}
}
</code></pre><p>Fun fact: a couple months back, we ruined the team&rsquo;s Friday, by debating about a similar topic in the context of (Graphite) metrics namespaces. It has become even more intricate since then :/</p><p><strong>Update (2020-04-15)</strong></p><p>Many people <a href=https://twitter.com/tvii/status/1250166077235048449>on Twitter</a> suggest that <em>Option 1</em> is an obvious choice because only application knows how to name the components. I totally agree with that.</p><p>As I <a href=https://twitter.com/tvii/status/1250298527814529026>wrote later</a>, the <em>real</em> dilemma is not about &ldquo;application and component&rdquo; but about &ldquo;owner of the component&rdquo;. Function <code>main</code>, in the example above, was a silly example, that tried (and failed) to illustrate the question in a code.</p><p>Let&rsquo;s try another (<em>silly</em>) example:</p><pre><code>// there are buch of different handlers (maybe ten) in this application
type Handler1 struct { logger Logger }

func (h *Handler1) ServeHTTP(w http.ResponseWriter, r *http.Request) {
	// OPTION 1
	req := NewRequst(h.logger.With(&quot;component&quot;, &quot;request&quot;), r)
}

type Handler2 struct { logger Logger }

func (h *Handler2) ServeHTTP(w http.ResponseWriter, r *http.Request) {
	// OPTION 1, still
	req := NewRequst(h.logger.With(&quot;component&quot;, &quot;request&quot;), r)
}

type Request struct {
	logger Logger
}

// OPTION 2
func NewRequst(logger Logger, *r http.Request) *Request {
	return &amp;Request{
		logger: logger.With(&quot;component&quot;, &quot;request&quot;),
	}
}
</code></pre><p>We want to have a consistent nomenclature across the application&rsquo;s logs.</p><p>Is the choice still obvious? ;)</p><p><em>Do you have an opinion? Share it with me <a href=https://twitter.com/tvii/status/1250166077235048449>on Twitter</a></em>.</p><footer class=article-meta><time datetime=2020-04-14T12:00:00Z>April 14, 2020</time></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/03/go-osx-core-location/>Retrieve Location of macOS Device from Go</a></h2></header><p>Participating in self-isolation is more fun when you have toys to play. As a fun weekend project, I wanted to look at how one accesses macOS Location Services and get the geographic location of the device from Go.</p><p>To obtain the geographic location of a device on macOS, we use <a href="https://developer.apple.com/documentation/corelocation?language=objc">Apple’s Core Location</a> framework. The framework is part of the OS, but it requires writting Objective-C (<em>or Swift</em>). Thanks to Go&rsquo;s cgo and because Objective-C is from the family of C languages, we can write a bridge between Objective-C and Go.</p><p><em><strong>Full disclosure</strong>, I haven’t written a line in C for more than 15 years. And more to that, it’s the first time I actually wrote something in Objective-C. The code is for illustrative purposes only. If you can help making it better, please, file an issue or a PR to <a href=https://github.com/narqo/playground-go/tree/master/osx-core-location>the example repo</a>, or write me <a href=https://twitter.com/tvii/status/1244545676622680069>on Twitter</a>.</em></p><p><em>The code might illustrate the example better than my English ;) Feel free to jump right into <a href=https://github.com/narqo/playground-go/tree/master/osx-core-location>the repo on GitHub</a>.</em></p><h2 id=part-1-go>Part 1. Go</h2><p>Let’s start with the Go code</p><pre><code>// File location_manager_darwin.go

/* #import &quot;location_manager_darwin.h&quot; */
import &quot;C&quot;

// CurrentLocation retrives location of the device and returns it to the caller.
func CurrentLocation() (Location, error) {
    var cloc C.Location
    if ret := C.get_current_location(&amp;cloc); ret != 0 {
        return Location{}, fmt.Errorf(&quot;failed to get location, code %d&quot;, ret)
    }

    loc := Location{
        // convert C Location to Go Location...
    }
    return loc, nil
}
</code></pre><p>Function <code>CurrentLocation</code> calls C function <code>get_current_location</code>, expecting it to either populate the C structure <code>C.Location</code> or return a non-zero error code.</p><p><code>get_current_location</code> is a plain-C function, that acts as a glue layer between Objective-C and Go. The function and the <code>C.Location</code> type are described in the header file, which we import with <code>#import "location_manager_darwin.h"</code> in the cgo directive. We will implement the function later in this note. For now, the definition of the function from the header:</p><pre><code>// File location_manager_darwin.h

// Location struct represents the location data
// from Apple's CLLocation object.
typedef struct _Location {
    CLLocationCoordinate2D coordinate;
    double altitude;
    double horizontalAccuracy;
    double verticalAccuracy;
} Location;

int get_current_location(Location *loc);
</code></pre><p><em>To compile the code we need two more cgo directives:</em></p><pre><code>// File location_manager_darwin.go

/*
#cgo CFLAGS: -x objective-c -mmacosx-version-min=10.14
#cgo LDFLAGS: -framework CoreLocation -mmacosx-version-min=10.14

#import &quot;location_manager_darwin.h&quot;
import &quot;C&quot;
*/
</code></pre><p><em><code>cgo CFLAGS</code> and <code>cgo LDFLAGS</code> define the behaviour of the compiler. Refer to <a href=https://golang.org/cmd/cgo/>Go’s documentation about cgo</a> to learn more.</em></p><h2 id=part-2-objective-c>Part 2. Objective-C</h2><p>As I said earlier, getting the user’s location requires writing some Objective-C.</p><p>To get the actual location we need an instance of <a href="https://developer.apple.com/documentation/corelocation/cllocationmanager?language=objc">Apple&rsquo;s <code>CLLocationManager</code> class</a>, whose delegate (<code>CLLocationManagerDelegate</code>) will receive the location events. For some degree, delegates in Objective-C are similar to interfaces in Go. That is, delegate is a class that must implement some methods, that will be invoked by the delegate’s owner.</p><p>To keep things simple, I implemented a class, <code>LocationManager</code>, that&rsquo;s responsible for instantiating <code>CLLocationManager</code> and, at the same time, is the implementation of the delegate protocol:</p><pre><code>// File location_manager_darwin.m

@interface LocationManager : NSObject &lt;CLLocationManagerDelegate&gt;
{
    CLLocationManager *manager;
}
@end

@implementation LocationManager

- (id)init {
    self = [super init];

    // create an instance of CLLocationManager
    manager = [[CLLocationManager alloc] init];
    // assign ourself as the delegate of the created instance
    manager.delegate = self;

    return self;
}

- (void)locationManager:(CLLocationManager *)manager didUpdateLocations:(NSArray&lt;CLLocation *&gt; *)locations {
    // implement CLLocationManagerDelegate protocol
}

- (void)locationManager:(CLLocationManager *)manager didFailWithError:(NSError *)error {
    // implement CLLocationManagerDelegate protocol
}
</code></pre><p><code>CLLocationManager</code> provides <a href><code>requestLocation</code></a> method, that, <em>as the name suggests</em>, requests the user’s geolocation. The method is asynchronous; on the first call, the OS’s location service will fire a macOS&rsquo;s modal dialogue, asking the user if they allow the application to access their location.</p><p>Below, method <code>getCurrentLocation</code> requests the geolocation and stops the invocation, waiting for events from OS’s location services to reach the delegate. The method then returns the location object (<a href="https://developer.apple.com/documentation/corelocation/cllocation?language=objc"><code>CLLocation</code></a>) to the caller:</p><pre><code>// File location_manager_darwin.m

@implementation LocationManager

- (id)init { ··· }

- (CLLocation *)getCurrentLocation {
    // request user’s current location
    [manager requestLocation];

    // start the run loop, waiting for the results from the delegate
    CFRunLoopRun();

    if (_errorCode != 0) {
        return nil;
    }
    // return the most recently retrieved user location
    return manager.location;
}

- (void)locationManager:(CLLocationManager *)manager didUpdateLocations:(NSArray&lt;CLLocation *&gt; *)locations {
    // we got the location: stop the run loop to give back the control to getCurrentLocation
    CFRunLoopStop(CFRunLoopGetCurrent());
}

- (void)locationManager:(CLLocationManager *)manager didFailWithError:(NSError *)error {
    // we failed to get the location: store the error code and
    // stop the run loop to give back the control to getCurrentLocation
    _errorCode = error.code;
    CFRunLoopStop(CFRunLoopGetCurrent());
}

@end
</code></pre><p><em>In the comments to the code above, I mentioned “run loop”. This is a fairly big topic, and I’m definitely not an expert to discuss it. Refer to Apple’s documentation about <a href="https://developer.apple.com/documentation/corefoundation/1542011-cfrunlooprun?language=objc"><code>CFRunLoopRun</code></a> function and related topics to get the idea about asynchronous programming with Apple’s Foundation framework.</em></p><h2 id=part-3-c>Part 3. C</h2><p>Because we can’t instantiate and use Objective-C classes from cgo, we need a plain C function to be a bridge between Objective-C and Go. It’s time to look at the implementation of <code>get_current_location</code> function, we discussed in Part 1:</p><pre><code>// File location_manager_darwin.m

int get_current_location(Location *loc) {
    // create an instance of our LocationManager class
    LocationManager *lm = [[LocationManager alloc] init];
    // obtain user’s location; the call blocks the thread
    CLLocation *clloc = [lm getCurrentLocation];

    if (lm.errorCode != 0) {
        return lm.errorCode;
    }

    // populate the resulting Location struct from Objective-C object
    loc-&gt;coordinate = clloc.coordinate;
    loc-&gt;altitude = clloc.altitude;

    return 0;
}
</code></pre><p>After days of browsing Apple’s documentation, SO and GitHub, I got the results I wanted.
That&rsquo;s how we use it in a Go code:</p><pre><code>package main

func main() {
    loc, _ := CurrentLocation()
    fmt.Printf(&quot;got location: latitude %f, logitude %f\n&quot;, loc.Coordinate.Latitude, loc.Coordinate.Longitude)
}
</code></pre><p>When running the program in the terminal, macOS shows a popup window with the request to access the device’s location. The program then prints the obtained coordinates to the console (<em>I redacted the real coordinates below with &ldquo;xxxxxx&rdquo;</em>):</p><pre><code>$ go run ./
got location: latitude 52.xxxxxx, logitude 13.xxxxxx
</code></pre><p>As I mentioned in the beginning, the code example is on GitHub <a href=https://github.com/narqo/playground-go/tree/master/osx-core-location>https://github.com/narqo/playground-go/tree/master/osx-core-location</a>.</p><p>If you have any comments or suggestions, reach out to me on <a href=https://twitter.com/tvii/status/1244545676622680069>Twitter</a>.</p><p>Have fun and stay safe.</p><footer class=article-meta><time datetime=2020-03-30T12:00:00Z>March 30, 2020</time><span class=tag>go</span><span class=tag>cgo</span><span class=tag>objective-c</span><span class=tag>macos</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/01/buildkit-multi-platform-travis-ci/>Building Multi-Platform Docker Images with Travis CI and BuildKit</a></h2></header><p><em>This is a lengthy note. If you don&rsquo;t quite feel reading and only need the working example, go directly to <a href=https://github.com/profefe/profefe/blob/09ff03be6561a7ef88fba7b96d923abd6a413931/.travis.yml>the Travis CI build file</a>.</em></p><p>The more I delve into the world of Raspberry Pi, the more I notice that &ldquo;regular and boring&rdquo; things on ARM are harder than I expected.</p><p>People build and distribute software exclusively for amd64. You read another &ldquo;<em>Kubernetes something</em>&rdquo; tutorial, that went viral on Twitter, and is fancy to try it out. Still, all helm charts, or whatever the author prefered, use Docker images built exclusively for amd64.</p><p>Docker toolchain has added the support for building multi-platform images in 19.x. However, it&rsquo;s available only under the &ldquo;experimental&rdquo; mode. The topic of building multi-platform Docker images yet feels underrepresented.</p><h2 id=but-first-what-are-multi-platform-docker-images>But first, what are multi-platform Docker images?</h2><p>When a client, e.g. Docker client, tries to pull an image, it must negotiate the details about what exactly to pull with the registry. The registry provides a manifest that describes the digest of the requested image, the volumes the image consists of, the platform this image can run on, etc. Optionally, the registry can provide a manifests list, which, as the name suggests, is a list of several manifests bundled into one. With the manifests list in hands, the client can figure out the particular digest of the image it needs to pull.</p><p>So multi-platform Docker images are just several images, whose manifests are bundled into the manifests list.</p><p>Imagine we want to pull the image <a href=https://hub.docker.com/_/golang><code>golang:1.13.6-alpine3.10</code></a>. Docker client will get the manifests list from Dockerhub. This list includes digests of several images, each built for the particular platform. If we&rsquo;re on Raspberry Pi, running the current Raspbian Linux, which is <code>arm/v7</code>, the client will pick the corresponding image&rsquo;s digest. Alternatively, we could choose to pull the image <a href=https://hub.docker.com/r/arm32v7/golang/><code>arm32v7/golang:1.13.6-alpine3.10</code></a> instead, and we ended up with the same image with the <a href=https://hub.docker.com/layers/arm32v7/golang/alpine3.10/images/sha256-d72fa60fb5b9ffc12db9c87340bc9d9f55852570f1efc7d7656f081749a7f0aa>digest <code>d72fa60fb5b9</code></a>. Of course, to use a single universal image name, i.e. <code>golang</code>, on every platform is way more convenient.</p><p>You can read more about manifests <a href=https://docs.docker.com/registry/spec/manifest-v2-2/>in Docker registry documentation</a>.</p><h2 id=does-it-mean-i-need-to-build-different-docker-images-for-each-platform-i-want-to-support>Does it mean I need to build different Docker images, for each platform I want to support?</h2><p>Well, yes. This is how, official images are built.</p><p>For every platform, the image is built and pushed to the registry under the name <code>&lt;platform>/&lt;image>:&lt;tag></code>, e.g. <a href=https://hub.docker.com/r/amd64/golang/><code>amd64/golang:1-alpine</code></a>. And next, a manifests list, that combines all those platform-specific images, is built and pushed with the simple name <code>&lt;image>:&lt;tag></code>.</p><p><a href=https://github.com/moby/buildkit>Docker&rsquo;s BuildKit</a> provides a toolkit that, among other nice things, allows building multi-platform images on a single host. BuildKit is used inside <a href=https://github.com/docker/buildx>Docker' buildx project</a>, that is part of the recent Docker version.</p><p>One can use buildx, but, for this post, I wanted to try out, what would it look like to use BuildKit directly. For <a href=https://github.com/profefe/profefe>profefe</a>, the system for continuous profiling of Go services, I set up <a href=https://travis-ci.com/>Travis CI</a>, that builds a multi-platform Docker image and pushes them to Dockerhub.</p><p>profefe is written in Go. That simplifies things, because, thanks to Go compiler, I don&rsquo;t have to think about how to compile code for different platforms. <a href=https://github.com/profefe/profefe/blob/09ff03be6561a7ef88fba7b96d923abd6a413931/contrib/docker/Dockerfile>The same Dockerfile</a> will work fine on every platform.</p><p>Here&rsquo;s how &ldquo;deploy&rdquo; stage of the build job looks like (<a href=https://github.com/profefe/profefe/blob/09ff03be6561a7ef88fba7b96d923abd6a413931/.travis.yml>see <code>travis.yml</code> on profefe&rsquo;s GitHub</a>).</p><pre><code>dist: bionic

language: go
go:
  - 1.x

jobs:
  include:
    - stage: deploy docker
      services: docker
      env:
        - PLATFORMS=&quot;linux/amd64,linux/arm64,linux/arm/v7&quot;
      install:
        - docker container run --rm --privileged multiarch/qemu-user-static --reset -p yes
        - docker container run -d --rm --name buildkitd --privileged moby/buildkit:latest
        - sudo docker container cp buildkitd:/usr/bin/buildctl /usr/local/bin/
        - export BUILDKIT_HOST=&quot;docker-container://buildkitd&quot;
      script: skip
      deploy:
        - provider: script
          script: |
            buildctl build \
              --progress=plain \
              --frontend=dockerfile.v0 \
              --local context=. --local dockerfile=. \
              --opt filename=contrib/docker/Dockerfile \
              --opt platform=$PLATFORMS \
              --opt build-arg:VERSION=\&quot;master\&quot; \
              --opt build-arg:GITSHA=\&quot;$TRAVIS_COMMIT\&quot; \
              --output type=image,\&quot;name=profefe/profefe:git-master\&quot;,push=true
          on:
            repo: profefe/profefe
            branch: master
      before_deploy:
        - echo &quot;$DOCKER_PASSWORD&quot; | docker login --username &quot;$DOCKER_USERNAME&quot; --password-stdin
      after_failure:
        - buildctl debug workers ls
        - docker container logs buildkitd
</code></pre><p>It&rsquo;s a lot happening here, but I&rsquo;ll describe the most critical parts.</p><p>Let&rsquo;s start with <code>dist: bionic</code>.</p><p>We run the builds under Ubuntu 18.04 (Bionic Beaver). To be able to build multi-platform images on a single amd64 host, BuildKit uses QEMU to emulate other platforms. That requires Linux kernel 4.8, so even Ubuntu 16.04 (Xenial Xerus) should work.</p><p>The top-level details on how the emulation works are very well described in <a href=https://www.kernel.org/doc/html/latest/admin-guide/binfmt-misc.html>https://www.kernel.org/doc/html/latest/admin-guide/binfmt-misc.html</a></p><p>In short, we tell the component of the kernel (<code>binfmt_misc</code>) to use QEMU when the system executes a binaries built for a different platform. The following call in the &ldquo;install&rdquo; step is what&rsquo;s doing that:</p><pre><code>- docker container run --rm --privileged multiarch/qemu-user-static --reset -p yes
</code></pre><p>Under the hood, the container runs a <a href=https://raw.githubusercontent.com/qemu/qemu/master/scripts/qemu-binfmt-conf.sh>shell script from QEMU project</a>, that registers the emulator as an executor of binaries from the external platforms.</p><blockquote><p>If you think, that running a docker container to do the manipulations with the host&rsquo;s OS looks weird, well&mldr; I can&rsquo;t agree more. Probably, a better approach would be to install <a href=https://packages.ubuntu.com/bionic/qemu-user-static>qemu-user-static</a>, which would do the proper setup. Unfortunately, the current package&rsquo;s version for Ubuntu Bionic doesn&rsquo;t do the registration as we need it. I.e. its post-install doesn&rsquo;t add the <code>"F"</code> flag (&ldquo;fix binaries&rdquo;), which is crucial for our goal. Let&rsquo;s just agree,that docker-run will do ok for the demonstrational purpose.</p></blockquote><pre><code>- docker container run -d --rm --name buildkitd --privileged moby/buildkit:latest
- sudo docker container cp buildkitd:/usr/bin/buildctl /usr/local/bin/
- export BUILDKIT_HOST=&quot;docker-container://buildkitd&quot;
</code></pre><p>This is another &ldquo;docker-run&rsquo;ism&rdquo;. We start BuildKit&rsquo;s <code>buildkitd</code> daemon inside the container, attaching it to the Docker daemon that runs on the host (&ldquo;privileged&rdquo; mode). Next, we copy <code>buildctl</code> binary from the container to the host system and set <code>BUILDKIT_HOST</code> environment variable, so <code>buildctl</code> knew where its daemon runs.</p><blockquote><p>Alternatively, we could install BuildKit from GitHub and run the daemon directly on the build host. YOLO.</p></blockquote><pre><code>before_deploy:
  - echo &quot;$DOCKER_PASSWORD&quot; | docker login --username &quot;$DOCKER_USERNAME&quot; --password-stdin
</code></pre><p>To be able to push the images to the registry, we need to log in providing Docker credentials to host&rsquo;s Docker daemon. The credentials are set as Travis CI&rsquo;s encrypted environment variables ([refer to Travis CI docs])](<a href=https://docs.travis-ci.com/user/environment-variables/))>https://docs.travis-ci.com/user/environment-variables/))</a>.</p><pre><code>buildctl build \
  --progress=plain \
  --frontend=dockerfile.v0 \
  --local context=. --local dockerfile=. \
  --opt filename=contrib/docker/Dockerfile \
  --opt platform=$PLATFORMS \
  --opt build-arg:VERSION=\&quot;master\&quot; \
  --opt build-arg:GITSHA=\&quot;$TRAVIS_COMMIT\&quot; \
  --output type=image,\&quot;name=profefe/profefe:git-master\&quot;,push=true
</code></pre><p>This is the <em>black box</em> where everything happens. Magically!</p><p>We run <code>buildctl</code> stating that it must use the specified Dockerfile; it must build the images for defined platforms (I specified <code>linux/amd64,linux/arm64,linux/arm/v7</code>), create a manifests list tagged as the desired image (<code>profefe/profefe:&lt;version></code>), and push all the images to the registry.</p><p><code>buildctl debug workers ls</code> shows what platforms does BuildKit on this host support. I listed only those I&rsquo;m currently intrested with.</p><p>And that&rsquo;s all. This setup automatically builds and pushes multi-platform Docker images for profefe (<a href=https://hub.docker.com/p/profefe/profefe>https://hub.docker.com/p/profefe/profefe</a>) on a commit to project&rsquo;s &ldquo;master&rdquo; branch on GitHub.</p><hr><p>As I hope you&rsquo;ve seen, support for multi-platform is getting easier and things that were hard a year ago are only mildly annoying now :)</p><p>If you have any comments or suggestions, reach out to me on <a href=https://twitter.com/tvii/status/1221858810006065154>Twitter</a> or discuss this note on <a href=https://www.reddit.com/r/docker/comments/eutrkg/building_multiplatform_docker_images_with_travis/>r/docker Reddit</a>.</p><p>Some more reading on the topic:</p><ul><li><a href=https://github.com/moby/buildkit>Documentation for BuildKit project</a></li><li><a href=https://github.com/docker/buildx#building-multi-platform-images>Building multi-platform images with docker and buildx</a></li><li><a href=https://www.docker.com/blog/docker-official-images-now-multi-platform/>Docker Official Images are now Multi-platform, Docker official announcement</a></li></ul><footer class=article-meta><time datetime=2020-01-27T12:00:00Z>January 27, 2020</time><span class=tag>docker</span><span class=tag>buildkit</span><span class=tag>travis ci</span><span class=tag>raspberry pi</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2020/01/raspi-ubuntu-arm64-k3s/>k3s with Ubuntu Server (arm64) on Raspberry Pi 4</a></h2></header><p>As I&rsquo;ve <a href="https://twitter.com/tvii/status/1215927299557797893?s=20">twitted</a> recently, I&rsquo;m updating one of my Raspberry Pis to <a href=https://ubuntu.com/download/raspberry-pi>Ubuntu Server 19.10 (arm64)</a>.</p><h2 id=one-of-raspberry-pis>&ldquo;One of Raspberry Pis&rdquo;?</h2><p>My home cluster is four <a href="https://www.raspberrypi.org/products/raspberry-pi-4-model-b/?variant=raspberry-pi-4-model-b-2gb">Raspberry Pis 4 (2GB)</a>; all connected to my internet router through ethernet and
powered with <a href="https://www.amazon.de/gp/product/B00PTLSH9G/ref=ppx_yo_dt_b_asin_title_o03_s00?ie=UTF8&psc=1">60W 6 USB-ports charger</a>. All Pis build a small kubernetes cluster that runs with <a href=https://k3s.io/>k3s</a>.</p><p>All by one Pis run on <a href=https://www.raspberrypi.org/downloads/raspbian/>Raspbian Buster Lite</a> and this setup&rsquo;s been working pretty well until I&rsquo;ve found out,
<a href=https://www.aerospike.com/>Aerospike</a>, a database I required to run for a testing lab, only works on a 64-bit OS.</p><p>Luckily, <a href=https://ubuntu.com/download/raspberry-pi>Ubuntu Server has an arm64 version</a> built for Raspberry Pi. Thus, my working plan is to switch one Pi
to Ubuntu, compile and run a single-instance Aerospike server (<em>and any other components, that require a 64-bit OS</em>) on this Pi, and provide a kubernetes service in front of the DB, so other components in the cluster could access it as if it was
fully managed by kubernetes.</p><h2 id=the-setup>The Setup</h2><p>Setting up Ubuntu Server on a Pi was smooth. All I did was flushing the image with 19.10 OS to an SD card, as described in <a href=https://ubuntu.com/download/iot/installation-media>Ubuntu wiki</a>. That is, the headless setup worked out of the box, and after I inserted the card into the PI and connected it to the router, I managed to SSH into the system:</p><pre><code>$ ssh ubuntu@192.168.10.18
</code></pre><p>The default password for <code>ubuntu</code> user is <code>ubuntu</code>. The system asks to change the password on the first login.</p><p>The first thing to do after installing the system:</p><pre><code>$ sudo apt-get update
$ sudo apt-get upgrade -y
</code></pre><p>Disable &ldquo;message of the day&rdquo; (<code>motd</code>) to speed SSH login.
For that I commented out the following lines in <code>/etc/pam.d/login</code> and <code>/etc/pam.d/sshd</code>:</p><pre><code>#session    optional     pam_motd.so  motd=/run/motd.dynamic
#session    optional     pam_motd.so noupdate
</code></pre><p>Reduce GPU memory split. <em>I truly don&rsquo;t know if that even makes sense, tbh; read about memory split on <a href=https://www.raspberrypi.org/documentation/configuration/config-txt/memory.md>Raspberry PI config-txt wiki</a>.</em> I added the following to <code>/boot/firmware/usercfg.txt</code>:</p><pre><code>gpu_mem=16
</code></pre><p>To run Kubernetes or Docker, the kernel needs some cgroup options. On Ubuntu Server, the configuration is in <code>/boot/firmware/nobtcmd.txt</code> (<em>refer to <code>cmdline=nobtcmd.txt</code> in <code>/boot/firmware/nobtcfg.txt</code></em>). Add the following to the end of the file:</p><pre><code>cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1
</code></pre><p>Reboot the Pi, re-login, and all is ready to <a href=https://rancher.com/docs/k3s/latest/en/installation/>install k3s-agent</a>:</p><pre><code>$ curl -sfL https://get.k3s.io  | K3S_URL=&quot;https://&lt;k3s-master-pi&gt;:6443&quot; K3S_TOKEN=&quot;&lt;k3s-token&gt;&quot; sh -
</code></pre><p>After the agent installed and running, check the Pi was added to kubernetes cluster:</p><pre><code>pi@pi-1:~ $ sudo kubectl get node -o wide
NAME   ROLES    AGE   VERSION         INTERNAL-IP     OS-IMAGE                         KERNEL-VERSION      CONTAINER-RUNTIME
pi-1   master   30d   v1.17.0+k3s.1   192.168.10.16   Raspbian GNU/Linux 10 (buster)   4.19.75-v7l+        containerd://1.3.0-k3s.5
pi-2   &lt;none&gt;   47h   v1.17.0+k3s.1   192.168.10.14   Raspbian GNU/Linux 10 (buster)   4.19.75-v7l+        containerd://1.3.0-k3s.5
pi-3   &lt;none&gt;   47h   v1.17.0+k3s.1   192.168.10.15   Raspbian GNU/Linux 10 (buster)   4.19.75-v7l+        containerd://1.3.0-k3s.5
pi-4   &lt;none&gt;   10h   v1.17.0+k3s.1   192.168.10.18   Ubuntu 19.10                     5.3.0-1014-raspi2   containerd://1.3.0-k3s.5
</code></pre><p>That is for today. The next steps are to figure out how to <a href=https://github.com/aerospike/aerospike-server/pull/6>build Aerospike on arm64</a>, but this is a story for another day.</p><h3 id=update-2020-01-15>Update (2020-01-15)</h3><p>I&rsquo;ve managed to build and run Aerospike server for arm64! See <a href=https://github.com/narqo/aerospike-server/tree/make-arm64v8>make-arm64v8 branch</a>
in my fork of aerospike-server and <a href=https://gist.github.com/narqo/98e95760852cee9a64c3557026b3fe4a>the gist</a> with my systemd services and configs.</p><h3 id=update-2020-02-13>Update (2020-02-13)</h3><p>A week ago I tried to install Ubuntu Server 18.04.3 on Pi 4 and didn&rsquo;t even get to the login shell in the headless mode.
Now <a href=https://ubuntu.com/download/raspberry-pi>Ubuntu Server 18.04.4 LTS</a> is out and it works exactly as described in this note:</p><pre><code>$ kubectl get node -o wide
NAME   ROLES    AGE     VERSION        INTERNAL-IP     OS-IMAGE                         KERNEL-VERSION      CONTAINER-RUNTIME
pi-1   master   63d     v1.17.2+k3s1   192.168.10.16   Raspbian GNU/Linux 10 (buster)   4.19.93-v7l+        containerd://1.3.3-k3s1
pi-2   &lt;none&gt;   35d     v1.17.2+k3s1   192.168.10.14   Raspbian GNU/Linux 10 (buster)   4.19.93-v7l+        containerd://1.3.3-k3s1
pi-3   &lt;none&gt;   14m     v1.17.2+k3s1   192.168.10.20   Ubuntu 18.04.4 LTS               5.3.0-1017-raspi2   containerd://1.3.3-k3s1
pi-4   &lt;none&gt;   4d23h   v1.17.2+k3s1   192.168.10.19   Ubuntu 19.10                     5.3.0-1017-raspi2   containerd://1.3.3-k3s1
</code></pre><h3 id=update-2020-06-01>Update (2020-06-01)</h3><p>Ubuntu Server 20.04 is the recommended version of Ubuntu for Ri 4. It works perfectly fine:</p><pre><code>$ kubectl get node -o wide
NAME   ROLES    AGE     VERSION        INTERNAL-IP     OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME
pi-1   master   172d    v1.18.2+k3s1   192.168.10.41   Raspbian GNU/Linux 10 (buster)   4.19.118-v7l+      containerd://1.3.3-k3s2
pi-2   &lt;none&gt;   57d     v1.17.4+k3s1   192.168.10.42   Raspbian GNU/Linux 10 (buster)   4.19.118-v7l+      containerd://1.3.3-k3s2
pi-3   &lt;none&gt;   38d     v1.17.4+k3s1   192.168.10.43   Ubuntu 20.04 LTS                 5.4.0-1011-raspi   containerd://1.3.3-k3s2
pi-4   &lt;none&gt;   3d19h   v1.18.2+k3s1   192.168.10.44   Ubuntu 20.04 LTS                 5.4.0-1011-raspi   containerd://1.3.3-k3s2
</code></pre><p>Also Raspberry Pi OS (<em>ex-Raspbian</em>) for arm64 is currently in beta.</p><footer class=article-meta><time datetime=2020-01-11T12:00:00Z>January 11, 2020</time><span class=tag>raspberry pi</span><span class=tag>arm64</span><span class=tag>aarch64</span><span class=tag>k3s</span><span class=tag>kubernetes</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2019/12/the-fireside-edition/>The Fireside Edition</a></h2></header><p>After listening to the &ldquo;Fireside edition&rdquo; of <a href=https://changelog.com/gotime/110>Go Time FM</a>, I questioned myself, how would I answered the questions the hosts discussed.</p><p>Because no one has asked, you are very welcome:</p><h2 id=1-if-you-had-two-weeks-to-spend-on-a-personal-go-project-what-would-you-work-on>1. If you had two weeks to spend on a personal Go project, what would you work on?</h2><p>I really want to invest more time for <a href=https://github.com/profefe/profefe>profefe</a>. Specifically,
on implementing an analyser of stored profiles: the thing that would help to make sense of the data,
showing how the performance of an instance, a node, or a cluster had changed over the period of time;
how different parts of the codebase had influenced the performance of the application.</p><p>Recently Amazon has announced CodeGuru profiler (currently Java-only). From <a href=https://aws.amazon.com/codeguru/faqs/#Amazon_CodeGuru_Profiler>the description</a> it feels
exactly what I pictured in my head when I started the project.</p><p>Another topic that I would like to invest more time on is the understanding of the ecosystem around/inside Kubernetes.
During the past two years, I slowed down the consumption of the DevOps/SRE topics, mostly due to the specific
state of the infrastructure in our company. But, &ldquo;<em>k8s is the new linux</em>&rdquo;, regardless of what one&rsquo;s opinion on that.
Even profefe recently has ended up having a <a href=https://github.com/profefe/kube-profefe>kube-profefe</a> (<em>a bridge between profefe and Kubernetes</em>), contributed and maintained by other people.</p><h2 id=2-what-annoys-you-about-go-of-2019>2. What annoys you about Go of 2019?</h2><p>The same small things that annoyed me in Go 1.4: <code>var</code>, <code>new</code>, <code>make</code> and &ldquo;naked return&rdquo;. Sure, I understand that they all ended up in the language for a reason. But I simply don&rsquo;t like the &ldquo;magic&rdquo; of <code>make</code>, which works only with particular types;
the two ways of defining a variable (<code>var</code> or <code>:=</code>), or a pointer to an instance of a type (<code>new</code> or <code>&T{}</code>).</p><p>One new thing, though. Go modules' semver imports. But I can&rsquo;t say anything new about that. Probably, I just need to embrase them. Go 1.14 looks like a version where I might completely switch to modules, thanks to better handling of vendored dependencies.</p><h2 id=3-whats-your-ideal-working-environment>3. What&rsquo;s your ideal working environment?</h2><p>That always surprises me. Lots of people keep saying that working from home is their ideal environment or even a factor
that influence their job offers choice. I don&rsquo;t like to work at home. The only time when I feel productive when stay home is in the nights. A cafe or a co-working works sometimes. But I like working in a big office space. I don&rsquo;t know why.</p><p>Of course, open-plan offices can be very different. Yandex&rsquo;s &ldquo;Red Rose&rdquo; is still the best space I ever worked in. I heard they do excursions around the Moscow&rsquo;s office now.</p><h3 id=31-something-on-pair-programming>3.1. Something on pair-programming?</h3><p><em>Since I wrote about Yandex.</em></p><p>Some people thing pair-programming is a sort of a super-power. It&rsquo;s, and it&rsquo;s not.
You can&rsquo;t just put yourself in an environment, where someone is watching how you write the code while trying to hold a conversation about the code architecture. Pair-programming is a skill to master. But it pays off.</p><p>The pair-(trio actually)-programming sessions we did in Yandex, when we worked on <a href=https://github.com/bem/bem-core>bem-core</a>, was the most significant skill boost I had during the five+ years their.</p><p>Of course, the positive experience comes from your peers. In my case, they were people with a huge baggage of knowledge and practice of working, talking, debating with each other. Like, out of nowhere, you get the understanding of what
types of questions you must ask; when it is important to spend more time on thinking and when you can make a small hack.</p><h2 id=4-your-advice-to-you-junior-developer-self>4. Your advice to you junior-developer self?</h2><p>Don&rsquo;t overthink and afraid of starting anything. Trying something by making a raw, dirty, barely-working prototype will give you way more knowledge than thinking about how to do that.</p><footer class=article-meta><time datetime=2019-12-23T12:00:00Z>December 23, 2019</time><span class=tag>go</span><span class=tag>go time fm</span><span class=tag>askme</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2019/10/go-bytes-string-conversion/>[]byte to string conversion</a></h2></header><p>Go has an old wiki page, titled &ldquo;<a href=https://github.com/golang/go/wiki/CompilerOptimizations>Compiler And Runtime Optimizations</a>&rdquo;.</p><p>The part I like most there is different cases where compiler doesn&rsquo;t allocate memory for <code>string</code> to <code>[]byte</code> conversions:</p><blockquote><p>For a map m of type <code>map[string]T</code> and <code>[]byte b</code>, <code>m[string(b)]</code> doesn&rsquo;t allocate (the temporary string copy of the byte slice isn&rsquo;t made)</p></blockquote><p>Turned out, since this wiki page was written, more similar optimisations were added to the compiler.</p><p>As it&rsquo;s in Go 1.12+ the following cases are also listed in <a href=https://github.com/golang/go/blob/release-branch.go1.12/src/runtime/string.go#L128-L153><code>runtime/string.go</code></a>:</p><ul><li>Strings comcatenation</li></ul><p>For the case <code>"&lt;" + string(b) + ">"</code>, where <code>b</code> is <code>[]byte</code> no extra copying of <code>b</code> is needed.</p><ul><li>Comparison</li></ul><pre><code>if string(b) == &quot;foo&quot; { ··· }
</code></pre><p>In the code above, <code>b []byte</code> also won&rsquo;t be copied.</p><hr><p>There are still cases where compiler can&rsquo;t optimise the code for us. In some of those cases
it&rsquo;s fine to do string to bytes conversion using a so called &ldquo;<code>unsafe</code> trick&rdquo; (accessing string&rsquo;s underling
data directly, with out copying the data from string to bytes and vice versa). One can find several
ways of performing the trick, but none of them seems &ldquo;the one that must be used&rdquo;.</p><p>After years of episodic discussions, a collegue of mine assembled the list of different conserns and about
the proper way of doing it (<em>see &ldquo;<a href=https://groups.google.com/d/topic/golang-nuts/Zsfk-VMd_fU/discussion>unsafe conversion between string &lt;-> []byte</a>&rdquo; topic on golang-nuts forum</em>).
Thanks to replies from Go team, our most valid way of doing it is following:</p><pre><code>// Refer to github.com/fmstephe/unsafeutil

type stringHeader struct {
	data      unsafe.Pointer
	stringLen int
}

type sliceHeader struct {
	data     unsafe.Pointer
	sliceLen int
	sliceCap int
}

func StringToBytes(s string) (b []byte) {
	stringHeader := (*stringHeader)(unsafe.Pointer(&amp;s))
	sliceHeader := (*sliceHeader)(unsafe.Pointer(&amp;b))
	sliceHeader.data = stringHeader.data
	sliceHeader.sliceLen = len(s)
	sliceHeader.sliceCap = len(s)
	return b
}

func BytesToString(b []byte) (s string) {
	sliceHeader := (*sliceHeader)(unsafe.Pointer(&amp;b))
	stringHeader := (*stringHeader)(unsafe.Pointer(&amp;s))
	stringHeader.data = sliceHeader.data
	stringHeader.stringLen = len(b)
	return s
}
</code></pre><footer class=article-meta><time datetime=2019-10-08T12:00:00Z>October 8, 2019</time><span class=tag>go</span><span class=tag>µ-benchmarks</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2019/09/github-actions-and-gopath/>Github Actions and GOPATH</a></h2></header><p>The other day I received my beta access to <a href=https://github.com/features/actions>GitHub Actions</a>. To try them out I picked an existing pet project and created a <em>workflow</em> using a Go project template provided by GitHub. As it&rsquo;s in <em>September 2019</em>, their template defines the sequence of steps: setup Go, checkout code, get dependencies, build. This is not exactly how I used to do it.</p><p>My project is a <em>classic Go service</em> ;) meaning: it uses vendoring and doesn&rsquo;t use Go modules. So no need for &ldquo;get dependencies&rdquo; step. And it requires to be inside the <code>GOPATH</code>. With that, the provided workflow needed some adjustment.</p><p>After some trials and errors, I&rsquo;ve managed to make <code>checkout</code> step to clone the repo into the correct destination inside the <code>GOPATH</code>. Here is the final workflow:</p><pre><code>name: Run Go test
on: [pull_request]
jobs:
  test:
    strategy:
      matrix:
        go-version: [1.12.9]

    runs-on: ubuntu-latest

    steps:
      - uses: actions/setup-go@v1
        with:
          go-version: ${{ matrix.go-version }}

      - uses: actions/checkout@v1
        with:
          path: ./src/github.com/${{ github.repository }}
          fetch-depth: 5

      - run: make test
        env:
          GOPATH: ${{ runner.workspace }}
</code></pre><p>Note, how <code>actions/checkout@v1</code> above uses custom <code>path</code> input parameter. I set the path to <code>./src/github.com/${{ github.repository }}</code>, so the project is checked out to <code>src</code> directory in the runners&rsquo;s workspace, which I later pass as the value of <code>GOPATH</code> to the &ldquo;make test&rdquo; step. The leading dot in <code>./src</code> seems very important — I&rsquo;ve spent the majority of the time trying to figure out that part — refer to <a href=https://github.com/actions/checkout/issues/41>this issue</a>.</p><p><a href=https://github.com/profefe/profefe/actions>See the workflow in action</a>.</p><p>To learn more about those <code>${{ ··· }}</code> &ldquo;macroses&rdquo; I suggest looking at the Actions' &ldquo;<a href=https://help.github.com/en/articles/contexts-and-expression-syntax-for-github-actions>Contexts and expression syntax</a>&rdquo; documentation.</p><footer class=article-meta><time datetime=2019-09-19T12:00:00Z>September 19, 2019</time><span class=tag>go</span><span class=tag>github actions</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2019/09/go-http-headers/>Go's net/http.Headers</a></h2></header><p>One probably knows that <code>net/http.Headers</code> is no more than <code>map[string][]string</code> with extra specific methods. A usual way to initialise and populate such data-structure from an external representation is something like that:</p><pre><code>type Header map[string][]string

func (h Header) Add(key, val string) {
    if val == &quot;&quot; {
        return
    }
    h[key] = append(h[key], val)
}

func main() {
    h := make(Header)
    h.Add(&quot;Host&quot;, &quot;example.com&quot;)
    h.Add(&quot;Via&quot;, &quot;a.example.com&quot;)
    h.Add(&quot;Via&quot;, &quot;b.example.com&quot;)
}
</code></pre><p>From the code above, one can notice that we allocated a new slice of strings for every unique key that we added to headers. For things like HTTP headers, that&rsquo;re automatically parsed for every incoming request, this bunch of tiny allocations is something we&rsquo;d like to avoid.</p><p>I was curious to know if Go&rsquo;s standard library cares about that.</p><p>Looking at the implementation of <a href=https://golang.org/pkg/net/textproto/#Reader.ReadMIMEHeader><code>net/textproto.Reader.ReadMIMEHeader()</code></a>, which&rsquo;s used in the standard
HTTP server, or Go 1.13’s new <a href=https://golang.org/pkg/net/http/#Header.Clone><code>net/http.Header.Copy()</code></a>, it turned out they solve the problem quit elegantly.</p><p>We know that for a majority of cases, HTTP headers are an immutable key-value pair, where most of the keys have a single value. Instead of allocating a separate slice for a unique key, Go pre-allocates a continues slice for values and refers to a sub-slice of this slice for all keys.</p><p>Knowing that, we can refactor the initial <code>Header.Add</code> as the following:</p><pre><code>type Header map[string][]string

func (h Header) add(vv []string, key, val string) []string {
    if val == &quot;&quot; { ··· }

    // fast path for KV pair of a single value
    if h[key] == nil {
        vv = append(vv, value)
        h[key] = vv[:1:1]
        return vv[1:]
    }

    // slow path, when KV pair has two or more values
    h[key] = append(h[key], val)
    return vv
}

func main() {
    h := make(Header)
    // net/textprotocol pre-counts total number of request's headers
    // to allocate the slice of known capacity
    vv := make([]string, 0)

    vv = h.add(vv, &quot;Host&quot;, &quot;example.com&quot;)
    vv = h.add(vv, &quot;Via&quot;, &quot;a.example.com&quot;)
}
</code></pre><p>Note that we use <code>vv[:1:1]</code> to create a <a href=https://golang.org/ref/spec#Slice_expressions>subslice of the fixed capacity</a> (length 1, capacity 1).</p><p>If there is a KV-pair that has several values, e.g. &ldquo;Via&rdquo; header, <code>Add</code> will allocate a separate slice for that key, doubling its capacity.</p><footer class=article-meta><time datetime=2019-09-04T12:00:00Z>September 4, 2019</time><span class=tag>go</span><span class=tag>µ-benchmarks</span></footer></article><article class=article data-weight=0><header class=article-head><h2><a href=/notes/2019/09/hello-world/>Hello World</a></h2></header><p>Let&rsquo;s create a blog. But let&rsquo;s call them &ldquo;notes&rdquo;.</p><p>Because sometimes there are thoughts I want to share with you. Some of them might even be larger than a tweet.</p><footer class=article-meta><time datetime=2019-09-01T12:00:00Z>September 1, 2019</time></footer></article></main><footer class=main-footer>© 2020 #SocialDistancing</footer><div><img src=https://raw.githubusercontent.com/narqo/narqo.github.io/master/1.gif style=position:absolute;left:-9999px alt></div></body></html>