<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>[]byte to string conversion - Vladimir Varankin</title>
<link rel=canonical href=https://vladimir.varank.in/notes/2019/10/go-bytes-string-conversion/><meta property="og:url" content="https://vladimir.varank.in/notes/2019/10/go-bytes-string-conversion/"><meta property="og:site_name" content="Vladimir Varankin"><meta property="og:title" content="[]byte to string conversion"><meta property="og:description" content='Go has an old wiki page, titled “Compiler And Runtime Optimizations”.
The part I like most there is different cases where compiler doesn’t allocate memory for string to []byte conversions:
For a map m of type map[string]T and []byte b, m[string(b)] doesn’t allocate (the temporary string copy of the byte slice isn’t made)
Turned out, since this wiki page was written, more similar optimisations were added to the compiler.
As it’s in Go 1.12+ the following cases are also listed in runtime/string.go:
Strings comcatenation For the case "<" + string(b) + ">", where b is []byte no extra copying of b is needed.
Comparison if string(b) == "foo" { ··· } In the code above, b []byte also won’t be copied.
There are still cases where compiler can’t optimise the code for us. In some of those cases it’s fine to do string to bytes conversion using a so called “unsafe trick” (accessing string’s underling data directly, with out copying the data from string to bytes and vice versa). One can find several ways of performing the trick, but none of them seems “the one that must be used”.
After years of episodic discussions, a collegue of mine assembled the list of different conserns and about the proper way of doing it (see “unsafe conversion between string <-> []byte” topic on golang-nuts forum). Thanks to replies from Go team, our most valid way of doing it is following:
// Refer to github.com/fmstephe/unsafeutil type stringHeader struct { data unsafe.Pointer stringLen int } type sliceHeader struct { data unsafe.Pointer sliceLen int sliceCap int } func StringToBytes(s string) (b []byte) { stringHeader := (*stringHeader)(unsafe.Pointer(&amp;s)) sliceHeader := (*sliceHeader)(unsafe.Pointer(&amp;b)) sliceHeader.data = stringHeader.data sliceHeader.sliceLen = len(s) sliceHeader.sliceCap = len(s) return b } func BytesToString(b []byte) (s string) { sliceHeader := (*sliceHeader)(unsafe.Pointer(&amp;b)) stringHeader := (*stringHeader)(unsafe.Pointer(&amp;s)) stringHeader.data = sliceHeader.data stringHeader.stringLen = len(b) return s }'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2019-10-08T00:00:00+00:00"><meta property="article:modified_time" content="2019-10-08T00:00:00+00:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="Μ-Benchmarks"><style>:root{--background-color:#fff;--text-color:rgb(19, 19, 19);--text-underline-color:rgba(19, 19, 19, 0.5);--header-color:#111;--hr-color:rgb(143, 150, 163);--link-color:rgb(0, 16, 161);--link-underline-color:rgba(0, 16, 161, 0.3);--link-active-color:rgb(231, 19, 19);--link-active-underline-color:rgba(231, 19, 19, 0.7);--tag-color:rgb(85, 63, 63);--tag-underline-color:rgba(85, 63, 63, 0.5)}html{font-size:16px;height:100%;margin:0;padding:0}body{background:var(--background-color);color:var(--text-color);display:grid;grid-template-rows:auto 1fr auto;font-family:Charter,Georgia,serif;font-size:1.1rem;line-height:1.3;margin:5px 2%;margin:5px clamp(7px,1.5vw,25px);min-height:calc(100vh - 10px)}h1,h2,h3,h4,h5,h6{color:var(--header-color);font-family:Athelas,Georgia,serif;line-height:1.1;margin:1.5em 0 .7em}h1{font-size:40px;margin:.5em 0 .2em}a{color:#0010a1;color:var(--link-color);text-decoration-color:var(--link-underline-color);text-decoration-thickness:.04em;text-underline-offset:.1em}a:hover,a:active{color:#be0000;color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}ul,ol{box-sizing:border-box;max-width:760px;padding:0}ol{padding-left:1.2em}ul>li{list-style:none;margin:.5em 0}figure{margin:0;margin-block-start:1em;margin-block-end:1em;padding:0}figcaption{font-size:16px;font-style:italic}pre{line-height:1.1}code{font-family:sf mono,Menlo,Consolas,monospace;font-size:16px}pre code{font-size:14px;tab-size:2}@media screen and (min-width:900px){pre{margin:2em 1em}pre code{font-size:15px;tab-size:4}}hr{color:var(--hr-color);border:none;margin:.5em 0;width:90%}hr::after{content:'¶';display:block;font-size:14px;text-align:center}body{background-image:url(/avatar-bg-min.svg);background-position:-30px -14px;background-repeat:no-repeat;background-size:110px}.site-index{background-position:-56px -46px;background-size:auto}.site-index .site-main{margin-top:10px;margin-left:60px}.site-avatar{border:2px solid #fff;border-radius:50%;width:56px;height:56px;position:absolute;margin-top:-11px;margin-left:-68px}.site-nav{display:flex;flex-wrap:wrap;letter-spacing:.3em;padding-bottom:36px;margin-top:10px;margin-left:60px}.site-nav a,.site-nav span{margin-right:.6em;letter-spacing:0}.site-nav-item-active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}@media screen and (max-width:600px){.site-avatar{width:48px;height:48px;margin-left:-64px}.site-nav{padding-bottom:5px}}.site-content{font-size:19px;max-width:940px}.site-content img{max-width:100%;max-width:calc(100vw - 15px)}.site-content pre{max-width:calc(100vw - 1em);overflow:visible;overflow-x:scroll}@media screen and (min-width:900px){.site-content pre{max-width:calc(100vw - 4em);overflow-x:visible}}.site-footer{font-size:14px;margin:50px 0 0}.site-footer a{color:var(--text-color);text-decoration-color:inherit;text-decoration-color:var(--text-underline-color)}.main-head{display:flex;align-items:baseline;gap:8px;margin-bottom:-.7em}.main-head-meta{font-size:16px;margin:0;padding:0}.main-head-meta a{color:var(--text-color);text-decoration-color:inherit;text-decoration-color:var(--text-underline-color);margin:0 5px 0 0}.main-head-meta a:hover,.main-head-meta a:active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}.article{margin:0 0 50px}.article:last-child{margin-bottom:0}.section-head{font-size:28px}.section-head h1,.section-head h2{font-size:1em;margin-top:1em}.section-head h2{margin-bottom:0}.snippet{margin:0 0 40px}.snippet:last-of-type{margin:0}.snippet p{margin:0 0 .3em}.snippet-head h2{font-size:21px;margin:1em 0 .2em}.meta{font-size:14px;line-height:1;padding:5px 0 0}.tag{color:var(--tag-color);text-decoration-color:var(--tag-underline-color);margin:0 0 0 7px;text-transform:lowercase}.meta-topics-list{line-height:1.4;padding:34px 0 0}.meta-topics-list .tag{display:inline-block;margin:0 1ex 0 0}.pagination{display:flex;flex-wrap:nowrap}.page-item{display:inline-block;line-height:32px;margin-right:1em}.glitch:before{background:var(--background-color);position:absolute;content:attr(data-text);clip:rect(0,900px,0,0);animation:glitch-anim 2s infinite linear alternate-reverse;margin-left:-5px;text-shadow:1px 0 red}@media(prefers-reduced-motion){.glitch:before{display:none}}@keyframes glitch-anim{0%{clip:rect(3px,9999px,93px,0)}5%{clip:rect(53px,9999px,78px,0)}10%{clip:rect(10px,9999px,75px,0)}15%{clip:rect(32px,9999px,40px,0)}20%{clip:rect(65px,9999px,62px,0)}25%{clip:rect(31px,9999px,14px,0)}30%{clip:rect(94px,9999px,87px,0)}35%{clip:rect(81px,9999px,41px,0)}40%{clip:rect(45px,9999px,50px,0)}45%{clip:rect(82px,9999px,41px,0)}50%{clip:rect(71px,9999px,3px,0)}55%{clip:rect(75px,9999px,60px,0)}60%{clip:rect(20px,9999px,49px,0)}65%{clip:rect(67px,9999px,92px,0)}70%{clip:rect(47px,9999px,55px,0)}75%{clip:rect(63px,9999px,90px,0)}80%{clip:rect(70px,9999px,92px,0)}85%{clip:rect(41px,9999px,60px,0)}90%{clip:rect(56px,9999px,79px,0)}95%{clip:rect(21px,9999px,68px,0)}100%{clip:rect(15px,9999px,72px,0)}}</style></head><body><nav class=site-nav><a href=/ class=glitch data-text="Vladimir Varankin"><img class=site-avatar src=/v.jpg>
Vladimir Varankin
</a><a href=/notes/ class=site-nav-item-active>Notes</a>
<a href=/publications/>Publications</a>
<span>· </span><a href=https://github.com/narqo>GitHub</a>
<a href=https://bsky.app/profile/vladimir.varank.in>Bluesky</a>
<a href=https://t.me/varankinv>Telegram</a></nav><main class=site-content><header class=section-head><h1>[]byte to string conversion</h1></header><p>Go has an old wiki page, titled &ldquo;<a href=https://github.com/golang/go/wiki/CompilerOptimizations>Compiler And Runtime Optimizations</a>&rdquo;.</p><p>The part I like most there is different cases where compiler doesn&rsquo;t allocate memory for <code>string</code> to <code>[]byte</code> conversions:</p><blockquote><p>For a map m of type <code>map[string]T</code> and <code>[]byte b</code>, <code>m[string(b)]</code> doesn&rsquo;t allocate (the temporary string copy of the byte slice isn&rsquo;t made)</p></blockquote><p>Turned out, since this wiki page was written, more similar optimisations were added to the compiler.</p><p>As it&rsquo;s in Go 1.12+ the following cases are also listed in <a href=https://github.com/golang/go/blob/release-branch.go1.12/src/runtime/string.go#L128-L153><code>runtime/string.go</code></a>:</p><ul><li>Strings comcatenation</li></ul><p>For the case <code>"&lt;" + string(b) + ">"</code>, where <code>b</code> is <code>[]byte</code> no extra copying of <code>b</code> is needed.</p><ul><li>Comparison</li></ul><pre tabindex=0><code>if string(b) == &#34;foo&#34; { ··· }
</code></pre><p>In the code above, <code>b []byte</code> also won&rsquo;t be copied.</p><hr><p>There are still cases where compiler can&rsquo;t optimise the code for us. In some of those cases
it&rsquo;s fine to do string to bytes conversion using a so called &ldquo;<code>unsafe</code> trick&rdquo; (accessing string&rsquo;s underling
data directly, with out copying the data from string to bytes and vice versa). One can find several
ways of performing the trick, but none of them seems &ldquo;the one that must be used&rdquo;.</p><p>After years of episodic discussions, a collegue of mine assembled the list of different conserns and about
the proper way of doing it (<em>see &ldquo;<a href=https://groups.google.com/d/topic/golang-nuts/Zsfk-VMd_fU/discussion>unsafe conversion between string &lt;-> []byte</a>&rdquo; topic on golang-nuts forum</em>).
Thanks to replies from Go team, our most valid way of doing it is following:</p><pre tabindex=0><code>// Refer to github.com/fmstephe/unsafeutil

type stringHeader struct {
	data      unsafe.Pointer
	stringLen int
}

type sliceHeader struct {
	data     unsafe.Pointer
	sliceLen int
	sliceCap int
}

func StringToBytes(s string) (b []byte) {
	stringHeader := (*stringHeader)(unsafe.Pointer(&amp;s))
	sliceHeader := (*sliceHeader)(unsafe.Pointer(&amp;b))
	sliceHeader.data = stringHeader.data
	sliceHeader.sliceLen = len(s)
	sliceHeader.sliceCap = len(s)
	return b
}

func BytesToString(b []byte) (s string) {
	sliceHeader := (*sliceHeader)(unsafe.Pointer(&amp;b))
	stringHeader := (*stringHeader)(unsafe.Pointer(&amp;s))
	stringHeader.data = sliceHeader.data
	stringHeader.stringLen = len(b)
	return s
}
</code></pre><footer class=meta><time datetime=2019-10-08T12:00:00Z>October 8, 2019</time><a class=tag href=/notes/go/>Go</a><a class=tag href=/notes/%CE%BC-benchmarks/>Μ-Benchmarks</a></footer><section class="meta meta-topics-list"><header class=meta-topics-list-title><h3>All topics</h3></header><a class=tag href=https://vladimir.varank.in/notes/apple/>Apple</a><a class=tag href=https://vladimir.varank.in/notes/arduino/>Arduino</a><a class=tag href=https://vladimir.varank.in/notes/arm64/>Arm64</a><a class=tag href=https://vladimir.varank.in/notes/askme/>Askme</a><a class=tag href=https://vladimir.varank.in/notes/aws/>Aws</a><a class=tag href=https://vladimir.varank.in/notes/berlin/>Berlin</a><a class=tag href=https://vladimir.varank.in/notes/bookmarks/>Bookmarks</a><a class=tag href=https://vladimir.varank.in/notes/buildkit/>Buildkit</a><a class=tag href=https://vladimir.varank.in/notes/cgo/>Cgo</a><a class=tag href=https://vladimir.varank.in/notes/coffee/>Coffee</a><a class=tag href=https://vladimir.varank.in/notes/continuous-profiling/>Continuous Profiling</a><a class=tag href=https://vladimir.varank.in/notes/covid-19/>COVID-19</a><a class=tag href=https://vladimir.varank.in/notes/design/>Design</a><a class=tag href=https://vladimir.varank.in/notes/docker/>Docker</a><a class=tag href=https://vladimir.varank.in/notes/dynamodb/>Dynamodb</a><a class=tag href=https://vladimir.varank.in/notes/e-paper/>E-Paper</a><a class=tag href=https://vladimir.varank.in/notes/english/>English</a><a class=tag href=https://vladimir.varank.in/notes/enum/>Enum</a><a class=tag href=https://vladimir.varank.in/notes/esp8266/>Esp8266</a><a class=tag href=https://vladimir.varank.in/notes/firefox/>Firefox</a><a class=tag href=https://vladimir.varank.in/notes/github-actions/>Github Actions</a><a class=tag href=https://vladimir.varank.in/notes/go/>Go</a><a class=tag href=https://vladimir.varank.in/notes/google/>Google</a><a class=tag href=https://vladimir.varank.in/notes/graphql/>Graphql</a><a class=tag href=https://vladimir.varank.in/notes/homelab/>Homelab</a><a class=tag href=https://vladimir.varank.in/notes/ipv6/>IPv6</a><a class=tag href=https://vladimir.varank.in/notes/k3s/>K3s</a><a class=tag href=https://vladimir.varank.in/notes/kubernetes/>Kubernetes</a><a class=tag href=https://vladimir.varank.in/notes/linux/>Linux</a><a class=tag href=https://vladimir.varank.in/notes/macos/>Macos</a><a class=tag href=https://vladimir.varank.in/notes/material-design/>Material Design</a><a class=tag href=https://vladimir.varank.in/notes/mdns/>MDNS</a><a class=tag href=https://vladimir.varank.in/notes/music/>Music</a><a class=tag href=https://vladimir.varank.in/notes/ndppd/>Ndppd</a><a class=tag href=https://vladimir.varank.in/notes/neondatabase/>Neondatabase</a><a class=tag href=https://vladimir.varank.in/notes/objective-c/>Objective-C</a><a class=tag href=https://vladimir.varank.in/notes/passkeys/>Passkeys</a><a class=tag href=https://vladimir.varank.in/notes/postgresql/>PostgreSQL</a><a class=tag href=https://vladimir.varank.in/notes/pprof/>Pprof</a><a class=tag href=https://vladimir.varank.in/notes/profefe/>Profefe</a><a class=tag href=https://vladimir.varank.in/notes/random/>Random</a><a class=tag href=https://vladimir.varank.in/notes/raspberry-pi/>Raspberry Pi</a><a class=tag href=https://vladimir.varank.in/notes/rust/>Rust</a><a class=tag href=https://vladimir.varank.in/notes/travis-ci/>Travis Ci</a><a class=tag href=https://vladimir.varank.in/notes/vs-code/>Vs Code</a><a class=tag href=https://vladimir.varank.in/notes/waveshare/>Waveshare</a><a class=tag href=https://vladimir.varank.in/notes/%CE%BC-benchmarks/>Μ-Benchmarks</a></section></main><footer class=site-footer>#НетВойне<br><a href=mailto:vladimir@varank.in>vladimir@varank.in</a></footer><img src=https://c.varank.in/hello/*https://vladimir.varank.in/notes/2019/10/go-bytes-string-conversion/ style=position:absolute;left:-9999px decoding=async alt></body></html>