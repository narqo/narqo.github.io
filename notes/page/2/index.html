<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Notes - Vladimir Varankin</title><link rel=canonical href=https://vladimir.varank.in/notes/><link rel=alternate type=application/rss+xml href=https://vladimir.varank.in/notes/index.xml title="Notes from Vladimir Varankin"><meta property="og:title" content="Notes"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://vladimir.varank.in/notes/"><style>:root{--background-color:#fff;--text-color:rgb(19, 19, 19);--text-underline-color:rgba(19, 19, 19, 0.5);--header-color:#111;--hr-color:rgb(143, 150, 163);--link-color:rgb(0, 16, 161);--link-underline-color:rgba(0, 16, 161, 0.3);--link-active-color:rgb(231, 19, 19);--link-active-underline-color:rgba(231, 19, 19, 0.7);--tag-color:rgb(85, 63, 63);--tag-underline-color:rgba(85, 63, 63, 0.5)}html{font-size:16px;height:100%;margin:0;padding:0}body{background:var(--background-color);color:var(--text-color);display:grid;grid-template-rows:auto 1fr auto;font-family:Charter,Georgia,serif;font-size:1.1rem;line-height:1.3;margin:5px 1%;margin:5px max(7px,1%);margin:5px clamp(7px,1.5vw,14px);min-height:calc(100vh - 10px)}h1,h2,h3,h4,h5,h6{color:var(--header-color);font-family:Athelas,Georgia,serif;line-height:1;margin:1.5em 0 .7em}h1{font-size:40px;margin:.5em 0 .2em}a{color:#0010a1;color:var(--link-color);text-decoration-color:var(--link-underline-color);text-decoration-thickness:.04em;text-underline-offset:.1em}a:hover,a:active{color:#be0000;color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}ul,ol{box-sizing:border-box;max-width:760px;padding:0}ol{padding-left:1.2em}ul>li{list-style:none;margin:.5em 0}figure{margin:0;margin-block-start:1em;margin-block-end:1em;padding:0}figcaption{font-size:16px;font-style:italic}pre{line-height:1.1}code{font-family:sf mono,Menlo,Consolas,monospace;font-size:16px}pre code{font-size:14px;tab-size:2}@media screen and (min-device-width:900px){pre{margin:2em 1em}pre code{font-size:15px;tab-size:4}}hr{color:var(--hr-color);border:none;margin:.5em 0;width:90%}hr::after{content:'¶';display:block;font-size:14px;text-align:center}.site-nav{display:flex;flex-wrap:wrap;letter-spacing:.3em;padding-bottom:16px}.site-nav a,.site-nav span{margin-right:.6em;letter-spacing:0}.site-nav-item-active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}.site-content{font-size:19px;max-width:940px}.site-content img{max-width:100%;max-width:calc(100vw - 15px)}.site-content pre{max-width:calc(100vw - 1em);overflow:visible;overflow-x:scroll}@media screen and (min-width:900px){.site-content pre{max-width:calc(100vw - 4em);overflow-x:visible}}.site-footer{font-size:14px;margin:50px 0 0}.site-footer a{color:var(--text-color);text-decoration-color:inherit;text-decoration-color:var(--text-underline-color)}.main-head{display:flex;align-items:baseline;gap:8px}.main-head-meta{font-size:16px;margin:0;padding:0}.main-head-meta a{color:var(--text-color);text-decoration-color:inherit;text-decoration-color:var(--text-underline-color);margin:0 5px 0 0}.main-head-meta a:hover,.main-head-meta a:active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}.article{margin:0 0 50px}.article:last-child{margin-bottom:0}.section-head{font-size:28px}.section-head h1,.section-head h2{font-size:1em;margin-top:1em}.section-head h2{margin-bottom:0}.snippet{margin:0 0 40px}.snippet:last-of-type{margin:0}.snippet p{margin:0 0 .3em}.snippet-head h2{font-size:21px;margin:1em 0 .2em}.meta{font-size:14px;line-height:1;padding:5px 0 0}.tag{color:var(--tag-color);text-decoration-color:var(--tag-underline-color);margin:0 0 0 7px;text-transform:lowercase}.meta-topics-list{line-height:1.4;padding:34px 0 0}.meta-topics-list .tag{display:inline-block;margin:0 1ex 0 0}.pagination{display:flex;flex-wrap:nowrap}.page-item{display:inline-block;line-height:32px;margin-right:1em}.glitch:before{background:var(--background-color);position:absolute;content:attr(data-text);clip:rect(0,900px,0,0);animation:glitch-anim 2s infinite linear alternate-reverse;margin-left:-5px;text-shadow:1px 0 red}@media(prefers-reduced-motion){.glitch:before{display:none}}@keyframes glitch-anim{0%{clip:rect(3px,9999px,93px,0)}5%{clip:rect(53px,9999px,78px,0)}10%{clip:rect(10px,9999px,75px,0)}15%{clip:rect(32px,9999px,40px,0)}20%{clip:rect(65px,9999px,62px,0)}25%{clip:rect(31px,9999px,14px,0)}30%{clip:rect(94px,9999px,87px,0)}35%{clip:rect(81px,9999px,41px,0)}40%{clip:rect(45px,9999px,50px,0)}45%{clip:rect(82px,9999px,41px,0)}50%{clip:rect(71px,9999px,3px,0)}55%{clip:rect(75px,9999px,60px,0)}60%{clip:rect(20px,9999px,49px,0)}65%{clip:rect(67px,9999px,92px,0)}70%{clip:rect(47px,9999px,55px,0)}75%{clip:rect(63px,9999px,90px,0)}80%{clip:rect(70px,9999px,92px,0)}85%{clip:rect(41px,9999px,60px,0)}90%{clip:rect(56px,9999px,79px,0)}95%{clip:rect(21px,9999px,68px,0)}100%{clip:rect(15px,9999px,72px,0)}}</style></head><body><nav class=site-nav><a href=/ class=glitch data-text="Vladimir Varankin">Vladimir Varankin</a>
<a href=/notes/ class=site-nav-item-active>Notes</a>
<a href=/publications/>Publications</a>
<span>·</span>
<a href=https://github.com/narqo>GitHub</a>
<a href=https://twitter.com/tvii>Twitter</a>
<a href=https://t.me/varankinv>Telegram</a>
<a href=https://keybase.io/varankinv>Keybase</a></nav><main class=site-content><header class=main-head><h1>Notes</h1>/ <menu class=main-head-meta><a href=/notes/berlin/>Berlin</a>
<a href=/notes/go/>Go</a>
<a href=/notes/homelab/>Homelab</a>
<a href=/notes/kubernetes/>Kubernetes</a>
<a href=/notes/all/>Everything</a></menu></header><article class=article data-weight=0 data-word-count=400 data-reading-time=2><header class=section-head><h2><a href=/notes/2021/10/good-coffee-places-in-berlin/>Good coffee places in Berlin</a></h2></header><p>My definition of &ldquo;good coffee places&rdquo; includes, although, by no mean limited by, offering a &ldquo;not too fruity&rdquo; (sometimes &ldquo;chocolaty&rdquo;) Filter coffee or a decent Americano.</p><p><a href=/notes/2021/10/good-coffee-places-in-berlin/>Keep reading…</a></p><footer class=meta><time datetime=2021-10-10T12:00:00Z>October 10, 2021</time><a class=tag href=/notes/berlin/>berlin</a><a class=tag href=/notes/coffee/>coffee</a></footer></article><article class=article data-weight=0 data-word-count=800 data-reading-time=4><header class=section-head><h2><a href=/notes/2021/09/making-sense-of-requests-for-cpu-resources-in-kubernetes/>Making sense of requests for CPU resources in Kubernetes</a></h2></header><p>Kubernetes allows a container to request several resource types:</p><pre tabindex=0><code>apiVersion: v1
kind: Pod
metadata:
  name: my-app
spec:
  containers:
  - name: my-app
    image: images.example/my-app
    resources:
      requests:
        cpu: &#34;100m&#34;
        memory: &#34;64Mi&#34;
      limits:
        cpu: &#34;500m&#34;
        memory: &#34;128Mi&#34;
</code></pre><p>One particularly confusing type of the resource for me was <code>cpu</code>. For example, in the manifest above, the <code>my-app</code> container declares a request for &ldquo;100m&rdquo; of the CPU. What does that mean?</p><p><a href=/notes/2021/09/making-sense-of-requests-for-cpu-resources-in-kubernetes/>Keep reading…</a></p><footer class=meta><time datetime=2021-09-26T12:00:00Z>September 26, 2021</time><a class=tag href=/notes/kubernetes/>kubernetes</a><a class=tag href=/notes/docker/>docker</a></footer></article><article class=article data-weight=0 data-word-count=500 data-reading-time=2><header class=section-head><h2><a href=/notes/2021/08/one-step-closer-to-tabless-workflow/>One step closer to "Tabless" workflow</a></h2></header><p>Many years ago I embraced &ldquo;tabless&rdquo; development workflow: I use buffers, when I&rsquo;m in Vim; I also switch tabs off in both Goland and VS Code, as the first thing after I install the IDEs to a new laptop.</p><p>I&rsquo;m trying the same with Firefox web-browser now:</p><figure><img src=/images/2021/firefox-91-2021-a.jpg alt="Tabless Firefox 91" width=1100></figure><ol><li><p>Enable <code>toolkit.legacyUserProfileCustomizations.stylesheets</code> switch in Firefox&rsquo;s config (via <code>about:config</code> page or inside <code>user.js</code>).</p></li><li><p>Place the styles below into <code>%PROFILE%/chrome/userChrome.css</code> (I pick the actual path to the profile directory from Firefox&rsquo;s <code>about:support</code> page).</p></li></ol><pre tabindex=0><code>// Hide the tabs.
// Beware that hidding the tabs with &#34;display: none&#34; will ruine you browser&#39;s recent history,
// I&#39;ve learned that in a hard way ;)
#TabsToolbar &gt; .toolbar-items {
    opacity: 0;
    pointer-events: none;
}

// Pull the navigation bar up, on top of the empty space, that left after we&#39;d hidden the tabs.
#nav-bar {
    margin-top: calc((7px + var(--tab-min-height)) * -1);
}

// On macOS, when not in full screen, shift the urlbar&#39;s panel to the right,
// after close-minimise-expand buttons.
:root:not([inFullscreen]) #nav-bar-customization-target {
    margin-left: 65px;
}
</code></pre><p>I looked at <a href=https://searchfox.org/mozilla-central/source/browser/base/content>mozilla-central/··/navigator-toolbox.inc.xhtml</a> to get the structure of Firefox&rsquo;s UI.</p><ol start=3><li><p>Pick some nice and clean theme. My kudos to <a href=https://addons.mozilla.org/en-GB/firefox/addon/safari-macos-monterey-light/>Safari - MacOS Monterey Light</a> by a person nicknamed <a href=https://addons.mozilla.org/en-GB/firefox/user/16761237/>notcat</a>.</p></li><li><p>(<em>Optional</em>) In Firefox&rsquo;s &ldquo;General&rdquo; preferences, switch off &ldquo;Ctrl+Tab circles through tabs&rdquo;. With that, pressing Ctrl+Tab exposes all currently open pages (similar to how on macOS or other OS one switches between the opened applications with ⌘+Tab).</p></li></ol><hr><p>Overall I&rsquo;m fairly happy with how it ended up. Although, some things aren&rsquo;t quite ideal yet (might add more as I use this setup):</p><p>I wish there was a shortkey to enter a &ldquo;modal mode&rdquo;, where I could filter the list of open pages, to search for a particular page, and to switch to this page. Something similar to <code>:ls</code> command in Vim, or ⌘+E in Goland. I can use Firefox&rsquo;s &ldquo;Search amongst Tabs&rdquo; for that (press ⌘+L to focus into the URL bar, and querying with &ldquo;%[space]&rdquo;) but that requires some getting used to.</p><p>Firefox has &ldquo;Show all tabs&rdquo; button (Ctrl+Shift+Tab) but the way it works, at least in Firefox 91, is very confusing and random. It seems to me, its behaviour is tightly coupled to the browser&rsquo;s Tab UI.</p><p><strong>Update (2022-12-16)</strong> I&rsquo;ve found <a href=https://addons.mozilla.org/en-GB/firefox/addon/panorama-tab-groups/>Panorama Tab Groups</a> extension, which exposes the opened pages, and it works pretty well for me. One very minor thing is that I have to use Cmd+Shift+E because Cmd+E is locked in Firefox.</p><footer class=meta><time datetime=2021-08-23T12:00:00Z>August 23, 2021</time><a class=tag href=/notes/design/>design</a><a class=tag href=/notes/firefox/>firefox</a></footer></article><article class=article data-weight=0 data-word-count=500 data-reading-time=3><header class=section-head><h2><a href=/notes/2021/07/self-signed-certificates-with-k3s-and-cert-manager/>Self-signed certificates with k3s and cert-manager</a></h2></header><p>At least for now, my homelab cluster (<a href=/notes/2020/01/raspi-ubuntu-arm64-k3s/>4x Raspberry Pi, k3s, etc</a>) is available only for the devices <a href=/notes/2021/04/wireless-to-ethernet-island-for-homelab-cluster-ipv6-ndp-proxy-and-mdns-reflector/>on my local network</a>, inside a custom DNS zone <code>k8s.pi.home</code>. I don&rsquo;t think there are practical reasons to run anything with HTTPS in that setup, but there are cases, like browser extensions, where it&rsquo;s required.</p><p>Turned out, in 2021, it&rsquo;s fairly straight forward to set up a Certificate Authority (CA), that will issue TLS certificates to &ldquo;secure&rdquo; the ingress resources. At least, it&rsquo;s way simpler comparing to how I remember it was back in the days. All thanks to <a href=https://cert-manager.io>cert-manager</a> and some YAML.</p><p>First thing is to install cert-manager to the cluster. <a href=https://rancher.com/docs/k3s/latest/en/helm/>k3s comes with helm-controller</a>, that gives us a way to manage helm charts with Custom Resource Definitions (CRD). The following manifest defines a new namespace, and a resource of a kind <code>HelmChart</code>, to install cert-manager inside this namespace:</p><pre tabindex=0><code>apiVersion: v1
kind: Namespace
metadata:
  name: cert-manager

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: cert-manager
  namespace: kube-system
spec:
  chart: cert-manager
  repo: https://charts.jetstack.io
  targetNamespace: cert-manager
  valuesContent: |-
    installCRDs: true
    prometheus:
      enabled: true
      servicemonitor:
        enabled: true
</code></pre><p>After applying the manifest above — <code>kubectl apply -f cert-manager.yml</code> — define a self-signed certificate, which is used to bootstrap a CA:</p><pre tabindex=0><code>apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-cluster-issuer
spec:
  selfSigned: {}

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: selfsigned-ca
spec:
  isCA: true
  commonName: selfsigned-ca
  secretName: selfsigned-ca-root-secret
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: selfsigned-cluster-issuer
    kind: ClusterIssuer
    group: cert-manager.io

---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: selfsigned-issuer
spec:
  ca:
    secretName: selfsigned-ca-root-secret
</code></pre><p>And now, I can use <code>selfsigned-issuer</code> to issue TLS certificates for the ingress resources (<em>Traefik ingress in the k3s&rsquo;s case</em>). E.g. to play around, I run an open-source version of <a href=https://languagetool.org/dev>LanguageTool</a> server. The ingress manifests for the server looks like as following:</p><pre tabindex=0><code>apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: languagetool-server
  annotations:
    kubernetes.io/ingress.class: traefik
    cert-manager.io/issuer: selfsigned-issuer
spec:
  rules:
  - host: languagetool.k8s.pi.home
    http:
      paths:
      - path: /
        pathType: ImplementationSpecific
        backend:
          service:
            name: languagetool-server
            port:
              number: 8010
  tls:
  - hosts: [languagetool.k8s.pi.home]
    secretName: languagetool-server-cert
</code></pre><p>Of course, any certificate signed by my CA won&rsquo;t be automatically trusted by anyone, including my own system. If I try to access <code>https://languagetool.k8s.pi.home</code>, any HTTP client will raise a &ldquo;failed to verify the legitimacy of the server&rdquo; issue. I don&rsquo;t know if there is a better way to solve that, but I can hack that around by installing the cluster&rsquo;s root CA certificate into the system&rsquo;s keychain, and telling the system, that it should &ldquo;trust&rdquo; the certificate:</p><pre tabindex=0><code>$ kubectl get secret/selfsigned-ca-root-secret -o json \
  | jq -r &#39;.data[&#34;ca.crt&#34;]&#39; \
  | base64 -D &gt; ~/tmp/selfsigned-root-ca.crt
$ open ~/tmp/selfsigned-root-ca.crt
</code></pre><p>Choose &ldquo;Always trust&rdquo; the certificate in the keychain&rsquo;s certificate settings. The server looks <em>legitimate</em> now!</p><footer class=meta><time datetime=2021-07-10T12:00:00Z>July 10, 2021</time><a class=tag href=/notes/homelab/>homelab</a><a class=tag href=/notes/raspberry-pi/>raspberry pi</a><a class=tag href=/notes/k3s/>k3s</a></footer></article><article class=article data-weight=0 data-word-count=1600 data-reading-time=8><header class=section-head><h2><a href=/notes/2021/04/wireless-to-ethernet-island-for-homelab-cluster-ipv6-ndp-proxy-and-mdns-reflector/>Wireless-to-Ethernet island for homelab cluster: IPv6, NDP proxy and mDNS reflector</a></h2></header><p>Initially, when I assembled <a href=/notes/2020/01/raspi-ubuntu-arm64-k3s/>a homelab cluster of Raspberry Pis</a>, everything was directly connected to my Wi-Fi router with the Ethernet cables. This worked fine but this &ldquo;stack of boards&rdquo; behind the sofa in the centre of our small flat bugged me a bit.</p><p>Last year I decided to reorganise the cluster, turning it into a <em>wireless-to-wired island</em>, which I could relocate anywhere within the flat, without doing any special cable management, while staying cheap and avoid stacking the appartment with even more gadgets. After going through a number of trials and errors, the final setup looks as the following:</p><figure><img src=/images/2021/homelab-pi-net-1.png alt="Homelab cluster as a wireless-to-ethernet island (2021)" width=820></figure><p>Different colours contour the connections between two logical subnets — more on that later. Here what we have on the schema (top to bottom):</p><p><a href=/notes/2021/04/wireless-to-ethernet-island-for-homelab-cluster-ipv6-ndp-proxy-and-mdns-reflector/>Keep reading…</a></p><footer class=meta><time datetime=2021-04-26T12:00:00Z>April 26, 2021</time><a class=tag href=/notes/homelab/>homelab</a><a class=tag href=/notes/raspberry-pi/>raspberry pi</a><a class=tag href=/notes/ipv6/>IPv6</a><a class=tag href=/notes/mdns/>mDNS</a><a class=tag href=/notes/ndppd/>ndppd</a></footer></article><article class=article data-weight=0 data-word-count=100 data-reading-time=1><header class=section-head><h2><a href=/notes/2021/04/development-environment-in-2020/>Development environment in 2020</a></h2></header><figure><img src=/images/2021/state-of-dev-2020-1.png alt="Development environment in 2020" width=600></figure><p><em>Last year I made this one, after involving myself into <a href=https://twitter.com/tvii/status/1343243854183604226>a very random discussion on Twitter</a>, about the unnecessary complexity and none-sense of modern days&rsquo; development environments.</em></p><footer class=meta><time datetime=2021-04-05T12:00:00Z>April 5, 2021</time><a class=tag href=/notes/random/>random</a></footer></article><article class=article data-weight=0 data-word-count=700 data-reading-time=3><header class=section-head><h2><a href=/notes/2021/03/little-things-of-go-http-handlers/>Little things of Go HTTP handlers</a></h2></header><p>Every time I sketch an HTTP API in Go, I wrap the code of request handlers around these small but very convenient bits.</p><p>My handlers are methods or functions, that serve a request and, either write a (<em>positive</em>) response or return an error.</p><pre tabindex=0><code>// HandlerFunc is an HTTP handler function, that handles an HTTP request.
// It writes the response to http.ResponseWriter or returns an error.
type HandlerFunc func(w http.ResponseWriter, r *http.Request) error

// Handler is an adaptor for HandlerFunc, that converts the handler into http.Handler.
// It makes sure all errors returned from h are handled in a consistent manner.
func Handler(h HandlerFunc) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        err := h(w, r)
        if err != nil {
            handleError(w, r, err)
        }
    })
}
</code></pre><p>An error returned from <code>HandlerFunc</code> can be an indicator of a failure in request processing, <code>statusError</code>, or a general &ldquo;something didn&rsquo;t work&rdquo;-error. The later can contain the internal details, that the API must never expose to the user.</p><pre tabindex=0><code>// StatusError wraps an error err and contains the suggestion regarding to
// how the error should be communicated to the user.
//
// code must be a valid HTTP status code; text is the message to reply to user.
func StatusError(code int, text string, err error) error {
    return &amp;statusError{
        Code: code,
        Text: text,
        Err:  err,
    }
}

type statusError struct {
    Code int
    Text string
    Err  error
}

func (s statusError) Error() string {
    return s.Text
}

func (s statusError) Unwrap() error {
    return s.Err
}
</code></pre><p><code>handleError</code> is a helper function, which makes sure all errors returned from <code>HandlerFunc</code> are handled and replied to the user consistently. The internal details — the cause of the error — aren&rsquo;t exposed to the user, but the helper can provide a unified logging and metrics, which would be convenient when debugging the error later:</p><pre tabindex=0><code>var ErrNotFound = StatusError(http.StatusNotFound, &#34;Nothing found&#34;, nil)

func handleError(w http.ResponseWriter, r *http.Request, err error) {
    var statusErr *statusError
    if !errors.As(err, &amp;statusErr) {
        statusErr = &amp;statusError{Code: http.StatusInternalServerError, Text: &#34;Internal server error&#34;, Err: err}
    }

    rid := RequestIDFromContext(r.Context())
    resp := errResponse{
        RequestID: rid,
        Error:     statusErr.Text,
    }
    replyJSON(w, resp, statusErr.Code)

    // underlying error can be nil, as a special case, when the error is a client-side problem
    if err := errors.Unwrap(statusErr); err != nil {
        log.Errorw(&#34;request failed&#34;, &#34;request-id&#34;, rid, &#34;uri&#34;, r.RequestURI, &#34;error&#34;, err)
    }
}
</code></pre><p><code>replyJSON</code> is a helper function, which writes a JSON string to <code>http.ResponseWriter</code>, setting the proper HTTP headers.</p><pre tabindex=0><code>func replyJSON(w http.ResponseWriter, v interface{}, code int) {
    w.Header().Set(&#34;Content-Type&#34;, &#34;application/json&#34;)
    w.WriteHeader(code)
    err := json.NewEncoder(w).Encode(v)
    if err != nil {
        io.WriteString(w, `{&#34;code&#34;:500,&#34;error&#34;:`+strconv.Quote(err.Error())+`}`)
    }
}
</code></pre><p>How does it look in practice?</p><p>Below is an extract from a hypothetical API, with one single route <code>/api/login</code>, that takes an email, and replies with JSON, that contains this account&rsquo;s ID.</p><pre tabindex=0><code>func setupRoutes(mux *http.ServeMux) {
    authHandler := NewAuthHandler(···)
    mux.Handle(&#34;/api/login&#34;, Handler(authHandler.HandleLogin))
}

type AuthHandler {
    // internal dependencies
}

func (h *AuthHandler) HandleLogin(w http.ResponseWriter, r *http.Request) error {
    ctx := r.Context()

    req, err := DecodeLoginRequest(r)
    if err != nil {
        return fmt.Errorf(&#34;decode login request: %w&#34;, err)
    }
    if req.Email == &#34;&#34; {
        return StatusError(http.StatusBadRequest, &#34;email is required&#34;, nil)
    }

    accID, err := h.datastore.GetAccountByEmail(ctx, req.Email)
    if errors.Is(err, ErrNotExists) {
        return StatusError(http.StatusForbidden, &#34;account does not exist&#34;, err)
    }
    if err != nil {
        return fmt.Errorf(&#34;get account for %q: %w&#34;, req.Email, err)
    }

    resp := struct {
        ID string `json:&#34;id&#34;`
    }{
        ID: accID,
    }
    // ReplyJSON is a wrapper around internal replyJSON, that always responses with http.StatusOK
    ReplyJSON(w, resp)

    return nil
}
</code></pre><p><em>Do you have your own little things, that help you to lay out the boilerplate? Discuss this note on <a href=https://twitter.com/tvii/status/1377358308193935361>Twitter</a> or <a href=https://www.reddit.com/r/golang/comments/mhf04c/little_things_of_go_http_handlers/>Reddit</a>.</em></p><footer class=meta><time datetime=2021-03-31T12:00:00Z>March 31, 2021</time><a class=tag href=/notes/go/>Go</a></footer></article><article class=article data-weight=0 data-word-count=700 data-reading-time=3><header class=section-head><h2><a href=/notes/2021/01/you-dont-insert-unicode-null-character-as-postgres-jsonb/>(You don't) Insert unicode NULL character as Postgres jsonb</a></h2></header><p>With JSON data type it’s easy to treat Postgres as a document database, which doesn’t need strong schema. One can define a table, that has a field of a type <code>jsonb</code> and insert any valid JSON string (a “document”).</p><p>I’ve learned lately, that Postgres’s <code>jsonb</code> prohibits insertion of a valid JSON string if the string contains NULL (<code>U+0000</code>) character. Postgres’s own <a href=https://www.postgresql.org/docs/10/datatype-json.html>docs on JSON Types</a> says:</p><blockquote><p>RFC 7159 permits JSON strings to contain Unicode escape sequences denoted by \uXXXX. In the input function for the json type, Unicode escapes are allowed regardless of the database encoding, and are checked only for syntactic correctness. However, the input function for <code>jsonb</code> is stricter: it disallows Unicode escapes for non-ASCII characters (those above U+007F) unless the database encoding is UTF8. The <code>jsonb</code> type also rejects \u0000 (because that cannot be represented in PostgreSQL&rsquo;s text type), and it insists that any use of Unicode surrogate pairs to designate characters outside the Unicode Basic Multilingual Plane be correct.</p></blockquote><p>In my case, a Go backend inserts tracing logs to Postgres. A trace consists of multiple “spans”, some of which can contain the reply from an external API. As we found out, sometimes, in the event of a failure, the API replies with an empty GIF &lt;<em>facepalm/</em>>. Our backend converts the response to a string, marshals it to a JSON and later tries to insert the JSON into a Postgres table.</p><p>Consider the following Go code:</p><pre tabindex=0><code>// data is an empty GIF
var data = []byte{
    0x47, 0x49, 0x46, 0x38, 0x39, 0x61, 0x01, 0x00,
    0x01, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xff, 0xff, 0xff, 0x21, 0xf9, 0x04, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x01, 0x00, 0x00, 0x02, 0x01, 0x44,
    0x00, 0x3b,
}

func main() {
    v, _ := json.Marshal(struct {
        Resp interface{} `json:&#34;resp,omitempty&#34;`
    }{
        Resp: string(data),
    })
    fmt.Printf(&#34;%s\n&#34;, v)
    // Output (truncated for readability):
    // {&#34;resp&#34;:&#34;GIF89a\u0001\u0000\u0001\u0000\ufffd\···\u0001D\u0000;&#34;}
}
</code></pre><p>Above, <code>json.Marshal</code> produces a perfectly valid JSON. But if I try to insert it into a Postgres table as <code>jsonb</code>, the insert fails with “unsupported Unicode escape sequence”:</p><pre tabindex=0><code>= CREATE TABLE logs (data jsonb);
= INSERT INTO logs VALUES (&#39;{&#34;resp&#34;:&#34;GIF89a\u0001\u0000\u0001\u0000\ufffd\···\u0001D\u0000;&#34;}&#39;);

ERROR:  unsupported Unicode escape sequence
LINE 1: insert into logs values (&#39;{&#34;resp&#34;:&#34;GIF89a\u0001\u0000\u0001\...
                                 ^
DETAIL:  \u0000 cannot be converted to text.
CONTEXT:  JSON data, line 1: {&#34;resp&#34;:...
</code></pre><p>Because in my code, there were only a couple of places where I didn&rsquo;t control the actual data, that went into a span, the way I’ve chosen to handle that was by introducing a wrapper type, that implements <code>json.Marshaller</code>. The wrapper checks the value is a valid UTF-8 sequence and doesn’t contain <code>NULL</code> character before it marshals the value into a JSON string. If the value is not a valid UTF-8, the marshaller sees it as a binary data and base64-encodes it.</p><pre tabindex=0><code>// RawText handles invalid UTF-8 and NULL-bytes, encoding them as base64-string.
// Because we have to make sure the resulting JSON will be compatible with Postgres&#39;s jsonb,
// we must use RawText when we don&#39;t control the data, e.g. when log the error from an external API.
// Refer to https://www.postgresql.org/docs/10/datatype-json.html
type RawText []byte

func (v RawText) MarshalEasyJSON(w *Writer) {
    if utf8.Valid(v) &amp;&amp; !bytes.ContainsRune(v, &#39;\u0000&#39;) {
        // &#34;valid&#34; text is marshalled as string
        w.String(string(v))
    } else {
        // &#34;invalid&#34; text is marshalled as binary data
        w.Raw(json.Marshal([]byte(v)))
    }
}
</code></pre><p>Note, the code above is a marshaller for <a href=https://github.com/mailru/easyjson>github.com/mailru/easyjson</a>, which we use in the project.</p><p>Here is how it looks in practice:</p><pre tabindex=0><code>func main() {
    v, _ := json.Marshal(struct {
        Resp1 interface{} `json:&#34;resp1,omitempty&#34;`
        Resp2 interface{} `json:&#34;resp2,omitempty&#34;`
    }{
        Resp1: RawText(bin),             // wrap the bin data into RawText
        Rest2: RawText(&#34;normal string&#34;), // wrap (copy) a string into RawText
    })
    fmt.Printf(&#34;%s\n&#34;, v)
    // Output:
    // {
    // &#34;resp1&#34;:&#34;R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7&#34;,
    // &#34;resp2&#34;:&#34;normal string&#34;
    // }
}
</code></pre><footer class=meta><time datetime=2021-01-14T12:00:00Z>January 14, 2021</time><a class=tag href=/notes/postgresql/>postgresql</a><a class=tag href=/notes/go/>Go</a></footer></article><article class=article data-weight=0 data-word-count=600 data-reading-time=3><header class=section-head><h2><a href=/notes/2020/12/2020-what-a-year/>2020, what a year</a></h2></header><p>2020 was (technically, still is) an extraordinary year. For many people, this was the worst, the weirdest, the most depressing year; the year we wish was a bad dream. With all the respect for the terrible things, lots of people went through, for me, it was a year to remember.</p><p>In 2020 I learned how to work from home. It’s still not super fun, but it’s possible. As I look at that now, there are obvious benefits: I can start and end my day much more freely; I currently don’t feel much pressure when willing to go for a walk or a run at 11:00, or when I finish my workday at 16:00 (I tend to start around 8:30 while at home). But that being said, I still don’t consider staying full-remote and I want to go back to the office, co-working, or a random coffee bar.</p><p>In 2020 I bought a bicycle. After three years in Berlin, I’m with “all of those people” now :) Can’t say I’m super excited about the purchase. Mostly because I live in the walking distance from the office. With the bicycle, my “commute” is only five or seven minutes shorter. I have to wait at the traffic lights a lot; plus I have to spend extra minutes to lock/unlock the bicycle.</p><p>In 2020 I walked, on average, one kilometre per day more, than in the previous year (5.5 km vs 4.2 km). A bit of surprise but, overall this year, I walked less than I did in 2019. I bet that’s because this year we, obviously, didn’t travel much, so we didn’t have a chance to spend weeks walking around a new city, neither in Spring, nor on Christmas and New Year.</p><p>In 2020 we adopted a cat. The CAT, who’s now called Gagarin! He came to us from the middle of “nowhere-Russia” as a frightened little kitten and spent the first month under our bed, avoiding walking under the light. And now, after four months, he comes to have a nap on our pillow (and on my head) at 7:00, as his way to signal that it’s time to feed him.</p><p>In 2020 I assembled my four nodes Raspberry Pi Kubernetes cluster, but I haven’t made much use of it yet. As promised to myself in December 2019, during the year I learned and touched some new Kubernetes details, and I have tons of things I still want to get my hands into to understand on a more in-depth level of details.</p><p>In 2020 I started to learn Rust. I tried learning it in 2018 and in 2019. But this year, I actually spent a month or two writing code, not only reading/watching/listening to/following the content. It feels refreshing. Programming for embedded devices and game-dev are the most attractive fields that I want to explore further with Rust.</p><p>In 2020 I had two job interviews. None of them were successful for me, although I tend to believe that I’ve passed both. I have plans to draft a note about the essential questions one must ask the HR during the first call, somewhere later.</p><p>In 2020 I did and learned, and read, and listened to, and watched, and thought about a bunch of things.</p><p>In 2021 I will do even better.</p><footer class=meta><time datetime=2020-12-29T12:00:00Z>December 29, 2020</time></footer></article><article class=article data-weight=0 data-word-count=200 data-reading-time=1><header class=section-head><h2><a href=/notes/2020/12/on-code-reviews/>On code-reviews</a></h2></header><p><em>This is another thought experiment, this time on the importance of my feedback in the code-reviews.</em></p><p>Providing you’re working on a project maintained by a set team of N people. What would happen with the codebase if, for six months, in code-reviews, you started to accept changes for which, you generally leave feedback?</p><p>&ldquo;Variables, struct or function names are named poorly&rdquo; — accept. &ldquo;We already have a package, that solves a similar problem&rdquo; — accept. &ldquo;A change brings inconsistency to the codebase&rdquo; — accept. &ldquo;The pattern doesn’t belong here&rdquo; — accept.</p><p>Go is a famously opinionated programming language. But does being opinionated help and scale outside of the language and its standard library?</p><p><em>Do you have the answer? Discuss this note on <a href=https://www.reddit.com/r/golang/comments/k7aqxw/a_thought_experiment_on_importance_of_your/>r/golang Reddit</a> or share your thoughts on <a href=https://twitter.com/tvii/status/1335303528064094210>Twitter</a>.</em></p><footer class=meta><time datetime=2020-12-05T12:00:00Z>December 5, 2020</time><a class=tag href=/notes/random/>random</a></footer></article><article class=article data-weight=0 data-word-count=200 data-reading-time=1><header class=section-head><h2><a href=/notes/2020/11/a-thought-experiment-on-apple-m1/>A thought experiment on Apple M1</a></h2></header><p>With Apple&rsquo;s new M1 Macs showing (<em>reportedly</em>) huge performance improvement, compared to &ldquo;old&rdquo;, Intel-based Macs, I wonder what would hold Qualcomm (Snapdragon CPU) and others from doing &ldquo;the same&rdquo; and moving into laptop/desktop territory?</p><p>Microsoft already has Surface Pro X — an ARM-based Windows computer. They also have a version of Win10 for ARM, that one can even run on Raspberry Pi (still beta quality, I believe). Could 2021 become the year of ARM on desktop?</p><p>Even more interesting, Amazon&rsquo;s Graviton is showing (<em>again, reportedly</em>) an excellent performance, while staying at reasonably low cost. What would stop Google/Microsoft from moving into ARM-based CPU territory for their clouds?</p><footer class=meta><time datetime=2020-11-24T12:00:00Z>November 24, 2020</time><a class=tag href=/notes/random/>random</a></footer></article><article class=article data-weight=0 data-word-count=200 data-reading-time=1><header class=section-head><h2><a href=/notes/2020/09/vscode-font-variant/>Alternative font-variant in VS Code</a></h2></header><p>I&rsquo;m not a big fun of the aesthetics of <a href=https://code.visualstudio.com/>VS Code</a>, at least not on macOS. In particular, I don&rsquo;t like the way how its code editor renders fonts. But today I learned!</p><p>To make the fonts look better — I&rsquo;m on macOS — set an alternative font-variant, e.g. &ldquo;Comic Code Ligatures Medium&rdquo; instead of &ldquo;Regular&rdquo;, in the editor&rsquo;s settings. To specify font-variant, remove spaces in between the name of the font and pass the variant after the hyphen. That is, instead of <code>'Comic Code Ligatures'</code>, set the following:</p><pre tabindex=0><code>&#34;editor.fontFamily&#34;: &#34;&#39;ComicCodeLigatures-Medium&#39;, monospace&#34;
</code></pre><hr><p><em>Full disclosure, my IDE of choice is <a href=https://www.jetbrains.com/go/>GoLand</a>, and it has been so since it was only a plugin for IntelliJ IDEA. Even though I can comfortably use VS Code or Vim when I need to make a small change or look something up in the code, I need the IDE to effectively work on a large codebase.</em></p><p>The backstory for this note is that I&rsquo;m working on a small TypeScript/React application in my spare time this month. For something that small, VS Code works <del>great</del> fine. In fact, I&rsquo;m writing this particular note in VS Code too ;)</p><footer class=meta><time datetime=2020-09-09T12:00:00Z>September 9, 2020</time><a class=tag href=/notes/vs-code/>vs code</a></footer></article><article class=article data-weight=0 data-word-count=100 data-reading-time=1><header class=section-head><h2><a href=/notes/2020/09/one-year-in-production/>One year in production</a></h2></header><p>It&rsquo;s one year since I posted the very first note here. Unbelivable! Despite my own concerns I did published random posts over the course of the previous twelve months.</p><p>For the next round I came up with some personal goals:</p><ol><li>Keep posting.</li><li>Work on your grammar.</li><li>Add &ldquo;Archive&rdquo; and &ldquo;Tags&rdquo; sections.</li><li>Find a better approach for managing drafts.</li><li>Bring back the dark theme but figure out what to do with the illustrations.</li><li>Keep posting ;)</li></ol><footer class=meta><time datetime=2020-09-01T12:00:00Z>September 1, 2020</time></footer></article><article class=article data-weight=0 data-word-count=600 data-reading-time=3><header class=section-head><h2><a href=/notes/2020/08/does-profefe-prefers-push-over-pull/>Does profefe prefers "push" over "pull"?</a></h2></header><p>The main component of <a href=https://github.com/profefe/profefe>profefe, a system for continuous profiling</a>, is <em>profefe-collector</em> — a service that receives profiling data, taken from an application and persists the data in collector’s storage (<a href=https://github.com/profefe/profefe/blob/master/DESIGN.md>design document</a> describes it in more details). Receiving data from an external source (for example, <em>profefe-agent</em>), indicates that profefe, as an observability system, prefers &ldquo;push&rdquo; model. Why not &ldquo;pulling&rdquo; the profiles directly from the application?</p><p>Both push and pull models have their benefits and drawbacks.</p><p>A collector that pulls profiling data from running applications could simplify integration into existing infrastructure because there would be no need in making changes in the applications that already exposed pprof HTTP endpoint. Making sure that every application integrated and configured profefe-agent would be a challenging job in a large organisation.</p><p>On the other hand, pull model requires pprof servers to be exposed and available for the collector, so it could fetch (<em>pull</em>) profiling data. That can also be challenging in the deployments, where applications are collocated on the bare-metal machines. Every application (application&rsquo;s instance) would have to communicate a unique TCP port for its pprof server.</p><p>To work as a pull-system, the collector must be able to discover the pprof servers, thus it requires a mechanism for service discovery (SD), to be usable at scale. Unfortunately, there isn&rsquo;t a universal SD protocol or a provider, an observability system could be built upon.</p><p>Prometheus, the best example of an open-source system, which uses pull model for data collection, have to support several different SD systems in their code base. At some point they <a href=https://prometheus.io/blog/2018/07/05/implementing-custom-sd/>ended up introducing their own general protocol</a>, that expects a &ldquo;middle-man-service&rdquo;, which translates the data from a SD system into a list of Prometheus targets (<em>Update, <a href="https://www.reddit.com/r/golang/comments/idwi4d/does_profefe_a_system_for_continuous_profiling/g2by237/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3">this comment from u/bbrazil</a> does a better job explaining the state of SD in Prometheus</em>). There is no clear way for an open-source system to be both flexible and don&rsquo;t end up being a pile of &ldquo;plugins&rdquo;, that no one is willing to maintain or break.</p><p>From the start of profefe project, several years ago, I had the idea that translating push into pull would be easier for an end-user. That is if a small deployment already exposes a pprof server, writing an external job that pulls the profiles from the applications, annotates them with meta-data, and pushes the data into the collector, can be as easy as spawning a cronjob in a sidecar. <a href=https://github.com/profefe/kube-profefe>kube-profefe</a> solves that nicely for deployments running in Kubernetes. At some point, I hoped to come up with something similar for Nomad+Consul if the experiments ended successfully.</p><p>Translating pull into push is a similarly possible but because profefe didn’t have to support any SD mechanisms from the start, that simplified the overall code base and allowed us to focus on the collector and the <a href=https://github.com/profefe/profefe#http-api>API for profiles quering</a>.</p><p>profefe-collector does uses push model. But one can deploy profefe so it reflected the use cases your organisation has.</p><p>Do you use continuous profiling? Let me know about your experience. Share your thoughts <a href=https://twitter.com/tvii/status/1296796503781122049>on Twitter</a> or <a href=https://www.reddit.com/r/golang/comments/idwi4d/does_profefe_a_system_for_continuous_profiling/>discuss on r/golang</a>.</p><footer class=meta><time datetime=2020-08-21T12:00:00Z>August 21, 2020</time><a class=tag href=/notes/profefe/>profefe</a><a class=tag href=/notes/continuous-profiling/>continuous profiling</a><a class=tag href=/notes/go/>Go</a><a class=tag href=/notes/pprof/>pprof</a></footer></article><article class=article data-weight=0 data-word-count=100 data-reading-time=1><header class=section-head><h2><a href=/notes/2020/08/how-to-design-a-good-api/>How to design a good API</a></h2></header><p>A good API is designed around the use-case. A poorly designed, around the API&rsquo;s implementation details.</p><footer class=meta><time datetime=2020-08-14T12:00:00Z>August 14, 2020</time><a class=tag href=/notes/random/>random</a></footer></article><article class=article data-weight=0 data-word-count=300 data-reading-time=2><header class=section-head><h2><a href=/notes/2020/07/whats-in-your-main-dot-go/>What's in your main-dot-go? (aka Go Project boilerplate)</a></h2></header><p>Sometimes I write small services in Go from scratch. And every time <code>main.go</code> ends up looking almost the same:</p><pre tabindex=0><code>func main() {
	ctx, cancel := context.WithCancel(context.Background())
	defer cancel()

	sigs := make(chan os.Signal, 2)
	signal.Notify(sigs, os.Interrupt, syscall.SIGTERM)

	go func() {
		&lt;-sigs
		signal.Stop(sigs)
		cancel()
	}()

	if err := run(ctx, os.Args[1:]); err != nil {
		log.Fatalln(err)
	}
}

type Config struct {
	HTTPAddr            string
	HTTPShutdownTimeout time.Duration
}

func run(ctx context.Context, args []string) error {
	flags := flag.NewFlagSet(&#34;&#34;, flag.ExitOnError)

	var conf Config
	flags.StringVar(&amp;conf.HTTPAddr, &#34;http-addr&#34;, &#34;127.0.0.1:10080&#34;, &#34;address to listen on&#34;)
	flags.DurationVar(&amp;conf.HTTPShutdownTimeout, &#34;http-shutdown-timeout&#34;, 5*time.Second, &#34;server shutdown timeout&#34;)

	if err := flags.Parse(args); err != nil {
		return err
	}

	// TODO: define the handler, the routing, and wire the dependencies with the main context
	mux := http.NewServeMux()
	server := &amp;http.Server{
		Addr:    conf.HTTPAddr,
		Handler: mux,
	}

	errs := make(chan error, 1)
	go func() {
		log.Printf(&#34;starting: addr %s&#34;, server.Addr)
		errs &lt;- server.ListenAndServe()
	}()

	select {
	case &lt;-ctx.Done():
		log.Println(&#34;exiting...&#34;)
	case err := &lt;-errs:
		return err
	}

	// create new context because top-most one is already canceled
	ctx, cancel := context.WithTimeout(context.Background(), conf.HTTPShutdownTimeout)
	defer cancel()

	return server.Shutdown(ctx)
}
</code></pre><p>Of course, not every service requires an HTTP server, but the general idea stands.</p><hr><p>When Go will introduce <a href=https://github.com/golang/go/issues/37255><code>signal.NotifyContext()</code></a>, the signals handling in <code>main()</code> function will be much smaller (we&rsquo;re at go1.15rc1 as I&rsquo;m writing that and the change hasn&rsquo;t landed into the release yet).</p><p>I love how transparent is the flow here and how everything is scoped inside <code>run()</code> function. This structure forces you to eliminate global state, making unit or integration testing <em>almost trivial</em> — at least, in theory ;)</p><p>It might feel like too much of boilerplate code for a &ldquo;small&rdquo; service. In practice, though, I don&rsquo;t recall any time this caused any real troubles to me. The beauty of Go is in explicitness.</p><footer class=meta><time datetime=2020-07-31T12:00:00Z>July 31, 2020</time><a class=tag href=/notes/go/>Go</a></footer></article><article class=article data-weight=0 data-word-count=200 data-reading-time=1><header class=section-head><h2><a href=/notes/2020/07/waveshare-esp8266-driver-board-pins-mapping/>Waveshare ESP8266 Driver Board Pins Mapping</a></h2></header><p>I&rsquo;ve been playing with an <a href=https://www.waveshare.com/product/iot-communication/short-range-wireless/wifi/e-paper-esp8266-driver-board.htm>e-paper ESP866 Driver Board</a>, and a <a href=https://www.waveshare.com/2.7inch-e-Paper.htm>2.7" E-Ink display</a> from Waveshare. Arduino C++ looks manageable. One strange thing, though. In both board’s documentation and <a href=https://github.com/ZinggJM/GxEPD2>GxEPD2</a> library’s examples, they say the display is connected to pins as BUSY → GPIO16, RST → GPIO5, DC → GPIO4, CS → GPIO15. This mapping seems wrong.</p><p>After digging through the code examples from <a href=https://github.com/ZinggJM/GxEPD2>Waveshare’s Wiki</a>, the correct mapping is the following:</p><p>BUSY → GPIO5,
RST → GPIO2,
DC → GPIO4,
CS → GPIO15</p><p>That&rsquo;s how the initialisation of the main <code>GxEPD2</code> class for my 2.7" display looks like now:</p><pre tabindex=0><code>#define ENABLE_GxEPD2_GFX 0
#include &lt;GxEPD2_BW.h&gt;

// mapping of Waveshare e-Paper ESP8266 Driver Board
GxEPD2_BW&lt;GxEPD2_270, GxEPD2_270::HEIGHT&gt; display(GxEPD2_270(/*CS=15*/ SS, /*DC=4*/ 4, /*RST=2*/ 2, /*BUSY=5*/ 5));
</code></pre><footer class=meta><time datetime=2020-07-14T12:00:00Z>July 14, 2020</time><a class=tag href=/notes/homelab/>homelab</a><a class=tag href=/notes/waveshare/>waveshare</a><a class=tag href=/notes/esp8266/>esp8266</a><a class=tag href=/notes/e-paper/>e-paper</a><a class=tag href=/notes/arduino/>arduino</a></footer></article><article class=article data-weight=0 data-word-count=300 data-reading-time=2><header class=section-head><h2><a href=/notes/2020/06/sticky-headers/>Sticky headers? Please don't</a></h2></header><p>Sticky (or &ldquo;<em>fixed</em>&rdquo;) headers are everywhere. It feels that, nowadays, every web designer’s first attempt to site&rsquo;s navigation starts with a sticky header. I hate this.</p><p><a href=/notes/2020/06/sticky-headers/>Keep reading, the note has images…</a></p><footer class=meta><time datetime=2020-06-17T12:00:00Z>June 17, 2020</time><a class=tag href=/notes/design/>design</a><a class=tag href=/notes/random/>random</a></footer></article><article class=article data-weight=0 data-word-count=300 data-reading-time=2><header class=section-head><h2><a href=/notes/2020/04/owner-of-logging-context/>Owner of Logging Context</a></h2></header><p>There’s the late-night dilemma&mldr;</p><p><strong>Who should be in charge of logging context: a component&rsquo;s owner or the component itself?</strong></p><pre tabindex=0><code>type Logger interface {
	With(...kvpairs) Logger
}

type Storage struct {
	logger Logger
}

// OPTION 1: component&#39;s owner defines the context of component&#39;s logger
func main() {
	_ = NewStorage(logger.With(&#34;component&#34;, &#34;storage&#34;))
}

// OPTION 2: component itself is in charge of its logging context
func NewStorage(logger Logger) (st *Storage) {
	return &amp;Storage{
		logger: logger.With(&#34;component&#34;, &#34;storage&#34;),
	}
}
</code></pre><p>Fun fact: a couple months back, we ruined the team&rsquo;s Friday, by debating about a similar topic in the context of (Graphite) metrics namespaces. It has become even more intricate since then :/</p><p><strong>Update (2020-04-15)</strong></p><p>Many people <a href=https://twitter.com/tvii/status/1250166077235048449>on Twitter</a> suggest that <em>Option 1</em> is an obvious choice because only application knows how to name the components. I totally agree with that.</p><p>As I <a href=https://twitter.com/tvii/status/1250298527814529026>wrote later</a>, the <em>real</em> dilemma is not about &ldquo;application and component&rdquo; but about &ldquo;owner of the component&rdquo;. Function <code>main</code>, in the example above, was a silly example, that tried (and failed) to illustrate the question in a code.</p><p>Let&rsquo;s try another (<em>silly</em>) example:</p><pre tabindex=0><code>// there are buch of different handlers (maybe ten) in this application
type Handler1 struct { logger Logger }

func (h *Handler1) ServeHTTP(w http.ResponseWriter, r *http.Request) {
	// OPTION 1
	req := NewRequst(h.logger.With(&#34;component&#34;, &#34;request&#34;), r)
}

type Handler2 struct { logger Logger }

func (h *Handler2) ServeHTTP(w http.ResponseWriter, r *http.Request) {
	// OPTION 1, still
	req := NewRequst(h.logger.With(&#34;component&#34;, &#34;request&#34;), r)
}

type Request struct {
	logger Logger
}

// OPTION 2
func NewRequst(logger Logger, *r http.Request) *Request {
	return &amp;Request{
		logger: logger.With(&#34;component&#34;, &#34;request&#34;),
	}
}
</code></pre><p>We want to have a consistent nomenclature across the application&rsquo;s logs.</p><p>Is the choice still obvious? ;)</p><p><em>Do you have an opinion? Share it with me <a href=https://twitter.com/tvii/status/1250166077235048449>on Twitter</a></em>.</p><footer class=meta><time datetime=2020-04-14T12:00:00Z>April 14, 2020</time></footer></article><article class=article data-weight=0 data-word-count=1100 data-reading-time=5><header class=section-head><h2><a href=/notes/2020/03/go-osx-core-location/>Retrieve Location of macOS Device from Go</a></h2></header><p>Participating in self-isolation is more fun when you have toys to play. As a fun weekend project, I wanted to look at how one accesses macOS Location Services and get the geographic location of the device from Go.</p><p>To obtain the geographic location of a device on macOS, we use <a href="https://developer.apple.com/documentation/corelocation?language=objc">Apple’s Core Location</a> framework. The framework is part of the OS, but it requires writting Objective-C (<em>or Swift</em>). Thanks to Go&rsquo;s cgo and because Objective-C is from the family of C languages, we can write a bridge between Objective-C and Go.</p><p><a href=/notes/2020/03/go-osx-core-location/>Keep reading…</a></p><footer class=meta><time datetime=2020-03-30T12:00:00Z>March 30, 2020</time><a class=tag href=/notes/go/>Go</a><a class=tag href=/notes/cgo/>cgo</a><a class=tag href=/notes/objective-c/>objective-c</a><a class=tag href=/notes/macos/>macos</a></footer></article><nav class=pagination><a class=page-item href=/notes/ aria-label="Page 1">1</a>
<span class="page-item page-item-active" aria-current=page aria-label="Page 2">2</span>
<a class=page-item href=/notes/page/3/ aria-label="Page 3">3</a></nav></main><footer class=site-footer>#НетВойне<br><a href=mailto:vladimir@varank.in>vladimir@varank.in</a></footer><img src=https://c.varank.in/hello/*https://vladimir.varank.in/notes/ style=position:absolute;left:-9999px decoding=async alt></body></html>