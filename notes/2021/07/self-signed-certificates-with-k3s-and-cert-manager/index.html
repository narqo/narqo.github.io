<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/x-icon href=/favicon.ico><title>Self-signed certificates with k3s and cert-manager - Vladimir Varankin</title><link rel=canonical href=https://vladimir.varank.in/notes/2021/07/self-signed-certificates-with-k3s-and-cert-manager/><meta property="og:url" content="https://vladimir.varank.in/notes/2021/07/self-signed-certificates-with-k3s-and-cert-manager/"><meta property="og:site_name" content="Vladimir Varankin"><meta property="og:title" content="Self-signed certificates with k3s and cert-manager"><meta property="og:description" content="At least for now, my homelab cluster (4x Raspberry Pi, k3s, etc) is available only for the devices on my local network, inside a custom DNS zone k8s.pi.home. I don’t think there are practical reasons to run anything with HTTPS in that setup, but there are cases, like browser extensions, where it’s required.
Turned out, in 2021, it’s fairly straight forward to set up a Certificate Authority (CA), that will issue TLS certificates to “secure” the ingress resources. At least, it’s way simpler comparing to how I remember it was back in the days. All thanks to cert-manager and some YAML.
First thing is to install cert-manager to the cluster. k3s comes with helm-controller, that gives us a way to manage helm charts with Custom Resource Definitions (CRD). The following manifest defines a new namespace, and a resource of a kind HelmChart, to install cert-manager inside this namespace:
apiVersion: v1 kind: Namespace metadata: name: cert-manager --- apiVersion: helm.cattle.io/v1 kind: HelmChart metadata: name: cert-manager namespace: kube-system spec: chart: cert-manager repo: https://charts.jetstack.io targetNamespace: cert-manager valuesContent: |- installCRDs: true prometheus: enabled: true servicemonitor: enabled: true After applying the manifest above — kubectl apply -f cert-manager.yml — define a self-signed certificate, which is used to bootstrap a CA:
apiVersion: cert-manager.io/v1 kind: ClusterIssuer metadata: name: selfsigned-cluster-issuer spec: selfSigned: {} --- apiVersion: cert-manager.io/v1 kind: Certificate metadata: name: selfsigned-ca spec: isCA: true commonName: selfsigned-ca secretName: selfsigned-ca-root-secret privateKey: algorithm: ECDSA size: 256 issuerRef: name: selfsigned-cluster-issuer kind: ClusterIssuer group: cert-manager.io --- apiVersion: cert-manager.io/v1 kind: Issuer metadata: name: selfsigned-issuer spec: ca: secretName: selfsigned-ca-root-secret And now, I can use selfsigned-issuer to issue TLS certificates for the ingress resources (Traefik ingress in the k3s’s case). E.g. to play around, I run an open-source version of LanguageTool server. The ingress manifests for the server looks like as following:
apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: languagetool-server annotations: kubernetes.io/ingress.class: traefik cert-manager.io/issuer: selfsigned-issuer spec: rules: - host: languagetool.k8s.pi.home http: paths: - path: / pathType: ImplementationSpecific backend: service: name: languagetool-server port: number: 8010 tls: - hosts: [languagetool.k8s.pi.home] secretName: languagetool-server-cert Of course, any certificate signed by my CA won’t be automatically trusted by anyone, including my own system. If I try to access https://languagetool.k8s.pi.home, any HTTP client will raise a “failed to verify the legitimacy of the server” issue. I don’t know if there is a better way to solve that, but I can hack that around by installing the cluster’s root CA certificate into the system’s keychain, and telling the system, that it should “trust” the certificate:
$ kubectl get secret/selfsigned-ca-root-secret -o json \ | jq -r '.data[&#34;ca.crt&#34;]' \ | base64 -D > ~/tmp/selfsigned-root-ca.crt $ open ~/tmp/selfsigned-root-ca.crt Choose “Always trust” the certificate in the keychain’s certificate settings. The server looks legitimate now!"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2021-07-10T00:00:00+00:00"><meta property="article:modified_time" content="2021-07-10T00:00:00+00:00"><meta property="article:tag" content="Homelab"><meta property="article:tag" content="Raspberry Pi"><meta property="article:tag" content="K3s"><style>:root{--background-color:#fff;--text-color:rgb(19, 19, 19);--text-underline-color:rgba(19, 19, 19, 0.5);--header-color:#111;--hr-color:rgb(143, 150, 163);--link-color:rgb(0, 16, 161);--link-underline-color:rgba(0, 16, 161, 0.3);--link-active-color:rgb(231, 19, 19);--link-active-underline-color:rgba(231, 19, 19, 0.7);--tag-color:rgb(85, 63, 63);--tag-underline-color:rgba(85, 63, 63, 0.5)}html{font-size:16px;height:100%;margin:0;padding:0}body{background:var(--background-color);color:var(--text-color);display:grid;grid-template-rows:auto 1fr auto;font-family:Charter,Georgia,serif;font-size:1.1rem;line-height:1.3;margin:5px 2%;margin:5px clamp(7px,1.5vw,25px);min-height:calc(100vh - 10px)}h1,h2,h3,h4,h5,h6{color:var(--header-color);font-family:Athelas,Georgia,serif;line-height:1.1;margin:1.5em 0 .7em}h1{font-size:40px;margin:.5em 0 .2em}a{color:#0010a1;color:var(--link-color);text-decoration-color:var(--link-underline-color);text-decoration-thickness:.04em;text-underline-offset:.1em}a:hover,a:active{color:#be0000;color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}ul,ol{box-sizing:border-box;max-width:760px;padding:0}ol{padding-left:1.2em}ul>li{list-style:none;margin:.5em 0}figure{margin:0;margin-block-start:1em;margin-block-end:1em;padding:0}figcaption{font-size:16px;font-style:italic}pre{line-height:1.1}code{font-family:sf mono,Menlo,Consolas,monospace;font-size:16px}pre code{font-size:14px;tab-size:2}@media screen and (min-width:900px){pre{margin:2em 1em}pre code{font-size:15px;tab-size:4}}hr{color:var(--hr-color);border:none;margin:.5em 0;width:90%}hr::after{content:'¶';display:block;font-size:14px;text-align:center}body{background-image:url(/avatar-bg-min.svg);background-position:-30px -14px;background-repeat:no-repeat;background-size:110px}.site-index{background-image:none}.site-avatar{border:2px solid #fff;border-radius:50%;width:56px;height:56px;position:absolute;margin-top:-11px;margin-left:-68px}.site-nav{display:flex;flex-wrap:wrap;letter-spacing:.3em;padding-bottom:36px;margin-top:10px;margin-left:60px}.site-nav a,.site-nav span{margin-right:.6em;letter-spacing:0}.site-nav-item-active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}@media screen and (max-width:600px){.site-avatar{width:48px;height:48px;margin-left:-64px}.site-nav{padding-bottom:5px}}.site-content{font-size:19px;max-width:940px}.site-content img{max-width:100%;max-width:calc(100vw - 15px)}.site-content pre{max-width:calc(100vw - 1em);overflow:visible;overflow-x:scroll}@media screen and (min-width:900px){.site-content pre{max-width:calc(100vw - 4em);overflow-x:visible}}.site-footer{font-size:14px;margin:50px 0 0}.site-footer a{color:var(--text-color);text-decoration-color:inherit;text-decoration-color:var(--text-underline-color)}.main-head{display:flex;align-items:baseline;gap:8px;margin-bottom:-.7em}.main-head-meta{font-size:16px;margin:0;padding:0}.main-head-meta a{color:var(--text-color);text-decoration-color:inherit;text-decoration-color:var(--text-underline-color);margin:0 5px 0 0}.main-head-meta a:hover,.main-head-meta a:active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}.article{margin:0 0 50px}.article:last-child{margin-bottom:0}.section-head{font-size:28px}.section-head h1,.section-head h2{font-size:1em;margin-top:1em}.section-head h2{margin-bottom:0}.snippet{margin:0 0 40px}.snippet:last-of-type{margin:0}.snippet p{margin:0 0 .3em}.snippet-head h2{font-size:21px;margin:1em 0 .2em}.meta{font-size:14px;line-height:1;padding:5px 0 0}.tag{color:var(--tag-color);text-decoration-color:var(--tag-underline-color);margin:0 0 0 7px;text-transform:lowercase}.meta-topics-list{line-height:1.4;padding:34px 0 0}.meta-topics-list .tag{display:inline-block;margin:0 1ex 0 0}.pagination{display:flex;flex-wrap:nowrap}.page-item{display:inline-block;line-height:32px;margin-right:1em}.glitch:before{background:var(--background-color);position:absolute;content:attr(data-text);clip:rect(0,900px,0,0);animation:glitch-anim 2s infinite linear alternate-reverse;margin-left:-5px;text-shadow:1px 0 red}@media(prefers-reduced-motion){.glitch:before{display:none}}@keyframes glitch-anim{0%{clip:rect(3px,9999px,93px,0)}5%{clip:rect(53px,9999px,78px,0)}10%{clip:rect(10px,9999px,75px,0)}15%{clip:rect(32px,9999px,40px,0)}20%{clip:rect(65px,9999px,62px,0)}25%{clip:rect(31px,9999px,14px,0)}30%{clip:rect(94px,9999px,87px,0)}35%{clip:rect(81px,9999px,41px,0)}40%{clip:rect(45px,9999px,50px,0)}45%{clip:rect(82px,9999px,41px,0)}50%{clip:rect(71px,9999px,3px,0)}55%{clip:rect(75px,9999px,60px,0)}60%{clip:rect(20px,9999px,49px,0)}65%{clip:rect(67px,9999px,92px,0)}70%{clip:rect(47px,9999px,55px,0)}75%{clip:rect(63px,9999px,90px,0)}80%{clip:rect(70px,9999px,92px,0)}85%{clip:rect(41px,9999px,60px,0)}90%{clip:rect(56px,9999px,79px,0)}95%{clip:rect(21px,9999px,68px,0)}100%{clip:rect(15px,9999px,72px,0)}}</style></head><body><nav class=site-nav><a href=/ class=glitch data-text="Vladimir Varankin"><img class=site-avatar src=/v.jpg>
Vladimir Varankin
</a><a href=/notes/ class=site-nav-item-active>Notes</a>
<a href=/publications/>Publications</a>
<span>· </span><a href=https://github.com/narqo>GitHub</a>
<a href=https://bsky.app/profile/vladimir.varank.in>Bluesky</a>
<a href=https://t.me/varankinv>Telegram</a></nav><main class=site-content><header class=section-head><h1>Self-signed certificates with k3s and cert-manager</h1></header><p>At least for now, my homelab cluster (<a href=/notes/2020/01/raspi-ubuntu-arm64-k3s/>4x Raspberry Pi, k3s, etc</a>) is available only for the devices <a href=/notes/2021/04/wireless-to-ethernet-island-for-homelab-cluster-ipv6-ndp-proxy-and-mdns-reflector/>on my local network</a>, inside a custom DNS zone <code>k8s.pi.home</code>. I don&rsquo;t think there are practical reasons to run anything with HTTPS in that setup, but there are cases, like browser extensions, where it&rsquo;s required.</p><p>Turned out, in 2021, it&rsquo;s fairly straight forward to set up a Certificate Authority (CA), that will issue TLS certificates to &ldquo;secure&rdquo; the ingress resources. At least, it&rsquo;s way simpler comparing to how I remember it was back in the days. All thanks to <a href=https://cert-manager.io>cert-manager</a> and some YAML.</p><p>First thing is to install cert-manager to the cluster. <a href=https://rancher.com/docs/k3s/latest/en/helm/>k3s comes with helm-controller</a>, that gives us a way to manage helm charts with Custom Resource Definitions (CRD). The following manifest defines a new namespace, and a resource of a kind <code>HelmChart</code>, to install cert-manager inside this namespace:</p><pre tabindex=0><code>apiVersion: v1
kind: Namespace
metadata:
  name: cert-manager

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: cert-manager
  namespace: kube-system
spec:
  chart: cert-manager
  repo: https://charts.jetstack.io
  targetNamespace: cert-manager
  valuesContent: |-
    installCRDs: true
    prometheus:
      enabled: true
      servicemonitor:
        enabled: true
</code></pre><p>After applying the manifest above — <code>kubectl apply -f cert-manager.yml</code> — define a self-signed certificate, which is used to bootstrap a CA:</p><pre tabindex=0><code>apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-cluster-issuer
spec:
  selfSigned: {}

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: selfsigned-ca
spec:
  isCA: true
  commonName: selfsigned-ca
  secretName: selfsigned-ca-root-secret
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: selfsigned-cluster-issuer
    kind: ClusterIssuer
    group: cert-manager.io

---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: selfsigned-issuer
spec:
  ca:
    secretName: selfsigned-ca-root-secret
</code></pre><p>And now, I can use <code>selfsigned-issuer</code> to issue TLS certificates for the ingress resources (<em>Traefik ingress in the k3s&rsquo;s case</em>). E.g. to play around, I run an open-source version of <a href=https://languagetool.org/dev>LanguageTool</a> server. The ingress manifests for the server looks like as following:</p><pre tabindex=0><code>apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: languagetool-server
  annotations:
    kubernetes.io/ingress.class: traefik
    cert-manager.io/issuer: selfsigned-issuer
spec:
  rules:
  - host: languagetool.k8s.pi.home
    http:
      paths:
      - path: /
        pathType: ImplementationSpecific
        backend:
          service:
            name: languagetool-server
            port:
              number: 8010
  tls:
  - hosts: [languagetool.k8s.pi.home]
    secretName: languagetool-server-cert
</code></pre><p>Of course, any certificate signed by my CA won&rsquo;t be automatically trusted by anyone, including my own system. If I try to access <code>https://languagetool.k8s.pi.home</code>, any HTTP client will raise a &ldquo;failed to verify the legitimacy of the server&rdquo; issue. I don&rsquo;t know if there is a better way to solve that, but I can hack that around by installing the cluster&rsquo;s root CA certificate into the system&rsquo;s keychain, and telling the system, that it should &ldquo;trust&rdquo; the certificate:</p><pre tabindex=0><code>$ kubectl get secret/selfsigned-ca-root-secret -o json \
  | jq -r &#39;.data[&#34;ca.crt&#34;]&#39; \
  | base64 -D &gt; ~/tmp/selfsigned-root-ca.crt
$ open ~/tmp/selfsigned-root-ca.crt
</code></pre><p>Choose &ldquo;Always trust&rdquo; the certificate in the keychain&rsquo;s certificate settings. The server looks <em>legitimate</em> now!</p><footer class=meta><time datetime=2021-07-10T12:00:00Z>July 10, 2021</time><a class=tag href=/notes/homelab/>Homelab</a><a class=tag href=/notes/raspberry-pi/>Raspberry Pi</a><a class=tag href=/notes/k3s/>K3s</a></footer><section class="meta meta-topics-list"><header class=meta-topics-list-title><h3>All topics</h3></header><a class=tag href=https://vladimir.varank.in/notes/apple/>Apple</a><a class=tag href=https://vladimir.varank.in/notes/arduino/>Arduino</a><a class=tag href=https://vladimir.varank.in/notes/arm64/>Arm64</a><a class=tag href=https://vladimir.varank.in/notes/askme/>Askme</a><a class=tag href=https://vladimir.varank.in/notes/aws/>Aws</a><a class=tag href=https://vladimir.varank.in/notes/berlin/>Berlin</a><a class=tag href=https://vladimir.varank.in/notes/bookmarks/>Bookmarks</a><a class=tag href=https://vladimir.varank.in/notes/buildkit/>Buildkit</a><a class=tag href=https://vladimir.varank.in/notes/cgo/>Cgo</a><a class=tag href=https://vladimir.varank.in/notes/coffee/>Coffee</a><a class=tag href=https://vladimir.varank.in/notes/continuous-profiling/>Continuous Profiling</a><a class=tag href=https://vladimir.varank.in/notes/covid-19/>COVID-19</a><a class=tag href=https://vladimir.varank.in/notes/design/>Design</a><a class=tag href=https://vladimir.varank.in/notes/docker/>Docker</a><a class=tag href=https://vladimir.varank.in/notes/dynamodb/>Dynamodb</a><a class=tag href=https://vladimir.varank.in/notes/e-paper/>E-Paper</a><a class=tag href=https://vladimir.varank.in/notes/english/>English</a><a class=tag href=https://vladimir.varank.in/notes/enum/>Enum</a><a class=tag href=https://vladimir.varank.in/notes/esp8266/>Esp8266</a><a class=tag href=https://vladimir.varank.in/notes/firefox/>Firefox</a><a class=tag href=https://vladimir.varank.in/notes/github-actions/>Github Actions</a><a class=tag href=https://vladimir.varank.in/notes/go/>Go</a><a class=tag href=https://vladimir.varank.in/notes/google/>Google</a><a class=tag href=https://vladimir.varank.in/notes/graphql/>Graphql</a><a class=tag href=https://vladimir.varank.in/notes/homelab/>Homelab</a><a class=tag href=https://vladimir.varank.in/notes/ipv6/>IPv6</a><a class=tag href=https://vladimir.varank.in/notes/k3s/>K3s</a><a class=tag href=https://vladimir.varank.in/notes/kubernetes/>Kubernetes</a><a class=tag href=https://vladimir.varank.in/notes/linux/>Linux</a><a class=tag href=https://vladimir.varank.in/notes/macos/>Macos</a><a class=tag href=https://vladimir.varank.in/notes/material-design/>Material Design</a><a class=tag href=https://vladimir.varank.in/notes/mdns/>MDNS</a><a class=tag href=https://vladimir.varank.in/notes/music/>Music</a><a class=tag href=https://vladimir.varank.in/notes/ndppd/>Ndppd</a><a class=tag href=https://vladimir.varank.in/notes/neondatabase/>Neondatabase</a><a class=tag href=https://vladimir.varank.in/notes/objective-c/>Objective-C</a><a class=tag href=https://vladimir.varank.in/notes/passkeys/>Passkeys</a><a class=tag href=https://vladimir.varank.in/notes/postgresql/>PostgreSQL</a><a class=tag href=https://vladimir.varank.in/notes/pprof/>Pprof</a><a class=tag href=https://vladimir.varank.in/notes/profefe/>Profefe</a><a class=tag href=https://vladimir.varank.in/notes/random/>Random</a><a class=tag href=https://vladimir.varank.in/notes/raspberry-pi/>Raspberry Pi</a><a class=tag href=https://vladimir.varank.in/notes/rust/>Rust</a><a class=tag href=https://vladimir.varank.in/notes/travis-ci/>Travis Ci</a><a class=tag href=https://vladimir.varank.in/notes/vs-code/>Vs Code</a><a class=tag href=https://vladimir.varank.in/notes/waveshare/>Waveshare</a><a class=tag href=https://vladimir.varank.in/notes/%CE%BC-benchmarks/>Μ-Benchmarks</a></section></main><footer class=site-footer>#НетВойне<br><a href=mailto:vladimir@varank.in>vladimir@varank.in</a></footer><img src=https://c.varank.in/hello/*https://vladimir.varank.in/notes/2021/07/self-signed-certificates-with-k3s-and-cert-manager/ style=position:absolute;left:-9999px decoding=async alt></body></html>