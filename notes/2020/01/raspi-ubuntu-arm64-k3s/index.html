<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=x-ua-compatible content="ie=edge"><title>k3s with Ubuntu Server (arm64) on Raspberry Pi 4 - Vladimir Varankin</title><link rel=canonical href=https://vladimir.varank.in/notes/2020/01/raspi-ubuntu-arm64-k3s/><meta property="og:title" content="k3s with Ubuntu Server (arm64) on Raspberry Pi 4"><meta property="og:description" content="I'm updating my Raspberry Pi's to Ubuntu Server 19.10 (arm64)."><meta property="og:type" content="article"><meta property="og:url" content="https://vladimir.varank.in/notes/2020/01/raspi-ubuntu-arm64-k3s/"><meta property="article:published_time" content="2020-01-11T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-11T00:00:00+00:00"><style>:root{--background-color: #fff;--text-color: #131313;--header-color: #111;--link-color: rgb(0, 16, 161);--link-underline-color: rgba(0, 16, 161, 0.3);--link-active-color: rgb(231, 19, 19);--link-active-underline-color: rgba(231, 19, 19, 0.7)}html{font-size:16px;height:100%;margin:0;padding:0}body{background:var(--background-color);color:var(--text-color);display:grid;grid-template-rows:auto 1fr auto;font-family:Charter,Georgia,serif;font-size:1.1rem;line-height:1.4;margin:5px 1%;margin:5px max(7px,1%);min-height:calc(100vh - 10px)}h1,h2,h3,h4,h5,h6{color:var(--header-color);font-family:Athelas,Georgia,serif;line-height:1;margin:1.5em 0 .7em}h1{font-size:40px;margin:.5em 0 .2em}a{color:#0010a1;color:var(--link-color);text-decoration-color:var(--link-underline-color)}a:hover,a:active{color:#be0000;color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}ul,ol{box-sizing:border-box;max-width:760px;padding:0}ol{padding-left:1.2em}ul>li{list-style:none;margin:.5em 0}pre{line-height:1.4;margin:1em 1.5em}code{font-family:Menlo,Consolas,monospace;font-size:15px}pre code{font-size:14px}hr{border:none;border-bottom:1px solid;width:90%}.main-nav{display:flex;flex-wrap:wrap;letter-spacing:.3em;padding-bottom:16px}.main-nav a,.main-nav span{margin-right:.6em;letter-spacing:0}.main-nav-item-active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}.main-content{max-width:940px}.main-footer{font-size:14px;margin:50px 0 0}.article{margin:0 0 50px}.article:last-child{margin-bottom:0}.article-head{font-size:28px}.article-head h1,.article-head h2{font-size:1em;margin-top:1em}.article-head h2{margin-bottom:0}.article-meta{font-size:14px;line-height:1;padding:5px 0 0}.tag{margin:0 0 0 7px}</style></head><body><nav class=main-nav><a href=/>Vladimir Varankin</a>
<a href=/notes/ class=main-nav-item-active>Notes</a>
<a href=/publications/>Publications</a>
<a href=https://github.com/narqo>GitHub</a>
<a href=https://twitter.com/tvii>Twitter</a>
<a href=https://keybase.io/varankinv>Keybase</a></nav><main class=main-content><header class=article-head><h1>k3s with Ubuntu Server (arm64) on Raspberry Pi 4</h1></header><p>As I&rsquo;ve <a href="https://twitter.com/tvii/status/1215927299557797893?s=20">twitted</a> recently, I&rsquo;m updating one of my Raspberry Pis to <a href=https://ubuntu.com/download/raspberry-pi>Ubuntu Server 19.10 (arm64)</a>.</p><h2 id=one-of-raspberry-pis>&ldquo;One of Raspberry Pis&rdquo;?</h2><p>My home cluster is four <a href="https://www.raspberrypi.org/products/raspberry-pi-4-model-b/?variant=raspberry-pi-4-model-b-2gb">Raspberry Pis 4 (2GB)</a>; all connected to my internet router through ethernet and
powered with <a href="https://www.amazon.de/gp/product/B00PTLSH9G/ref=ppx_yo_dt_b_asin_title_o03_s00?ie=UTF8&psc=1">60W 6 USB-ports charger</a>. All Pis build a small kubernetes cluster that runs with <a href=https://k3s.io/>k3s</a>.</p><p>All by one Pis run on <a href=https://www.raspberrypi.org/downloads/raspbian/>Raspbian Buster Lite</a> and this setup&rsquo;s been working pretty well until I&rsquo;ve found out,
<a href=https://www.aerospike.com/>Aerospike</a>, a database I required to run for a testing lab, only works on a 64-bit OS.</p><p>Luckily, <a href=https://ubuntu.com/download/raspberry-pi>Ubuntu Server has an arm64 version</a> built for Raspberry Pi. Thus, my working plan is to switch one Pi
to Ubuntu, compile and run a single-instance Aerospike server (<em>and any other components, that require a 64-bit OS</em>) on this Pi, and provide a kubernetes service in front of the DB, so other components in the cluster could access it as if it was
fully managed by kubernetes.</p><h2 id=the-setup>The Setup</h2><p>Setting up Ubuntu Server on a Pi was smooth. All I did was flushing the image with 19.10 OS to an SD card, as described in <a href=https://ubuntu.com/download/iot/installation-media>Ubuntu wiki</a>. That is, the headless setup worked out of the box, and after I inserted the card into the PI and connected it to the router, I managed to SSH into the system:</p><pre><code>$ ssh ubuntu@192.168.10.18
</code></pre><p>The default password for <code>ubuntu</code> user is <code>ubuntu</code>. The system asks to change the password on the first login.</p><p>The first thing to do after installing the system:</p><pre><code>$ sudo apt-get update
$ sudo apt-get upgrade -y
</code></pre><p>Disable &ldquo;message of the day&rdquo; (<code>motd</code>) to speed SSH login.
For that I commented out the following lines in <code>/etc/pam.d/login</code> and <code>/etc/pam.d/sshd</code>:</p><pre><code>#session    optional     pam_motd.so  motd=/run/motd.dynamic
#session    optional     pam_motd.so noupdate
</code></pre><p>Reduce GPU memory split. <em>I truly don&rsquo;t know if that even makes sense, tbh; read about memory split on <a href=https://www.raspberrypi.org/documentation/configuration/config-txt/memory.md>Raspberry PI config-txt wiki</a>.</em> I added the following to <code>/boot/firmware/usercfg.txt</code>:</p><pre><code>gpu_mem=16
</code></pre><p>To run Kubernetes or Docker, the kernel needs some cgroup options. On Ubuntu Server, the configuration is in <code>/boot/firmware/nobtcmd.txt</code> (<em>refer to <code>cmdline=nobtcmd.txt</code> in <code>/boot/firmware/nobtcfg.txt</code></em>). Add the following to the end of the file:</p><pre><code>cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1
</code></pre><p>Reboot the Pi, re-login, and all is ready to <a href=https://rancher.com/docs/k3s/latest/en/installation/>install k3s-agent</a>:</p><pre><code>$ curl -sfL https://get.k3s.io  | K3S_URL=&quot;https://&lt;k3s-master-pi&gt;:6443&quot; K3S_TOKEN=&quot;&lt;k3s-token&gt;&quot; sh -
</code></pre><p>After the agent installed and running, check the Pi was added to kubernetes cluster:</p><pre><code>pi@pi-1:~ $ sudo kubectl get node -o wide
NAME   ROLES    AGE   VERSION         INTERNAL-IP     OS-IMAGE                         KERNEL-VERSION      CONTAINER-RUNTIME
pi-1   master   30d   v1.17.0+k3s.1   192.168.10.16   Raspbian GNU/Linux 10 (buster)   4.19.75-v7l+        containerd://1.3.0-k3s.5
pi-2   &lt;none&gt;   47h   v1.17.0+k3s.1   192.168.10.14   Raspbian GNU/Linux 10 (buster)   4.19.75-v7l+        containerd://1.3.0-k3s.5
pi-3   &lt;none&gt;   47h   v1.17.0+k3s.1   192.168.10.15   Raspbian GNU/Linux 10 (buster)   4.19.75-v7l+        containerd://1.3.0-k3s.5
pi-4   &lt;none&gt;   10h   v1.17.0+k3s.1   192.168.10.18   Ubuntu 19.10                     5.3.0-1014-raspi2   containerd://1.3.0-k3s.5
</code></pre><p>That is for today. The next steps are to figure out how to <a href=https://github.com/aerospike/aerospike-server/pull/6>build Aerospike on arm64</a>, but this is a story for another day.</p><h3 id=update-2020-01-15>Update (2020-01-15)</h3><p>I&rsquo;ve managed to build and run Aerospike server for arm64! See <a href=https://github.com/narqo/aerospike-server/tree/make-arm64v8>make-arm64v8 branch</a>
in my fork of aerospike-server and <a href=https://gist.github.com/narqo/98e95760852cee9a64c3557026b3fe4a>the gist</a> with my systemd services and configs.</p><h3 id=update-2020-02-13>Update (2020-02-13)</h3><p>A week ago I tried to install Ubuntu Server 18.04.3 on Pi 4 and didn&rsquo;t even get to the login shell in the headless mode.
Now <a href=https://ubuntu.com/download/raspberry-pi>Ubuntu Server 18.04.4 LTS</a> is out and it works exactly as described in this note:</p><pre><code>$ kubectl get node -o wide
NAME   ROLES    AGE     VERSION        INTERNAL-IP     OS-IMAGE                         KERNEL-VERSION      CONTAINER-RUNTIME
pi-1   master   63d     v1.17.2+k3s1   192.168.10.16   Raspbian GNU/Linux 10 (buster)   4.19.93-v7l+        containerd://1.3.3-k3s1
pi-2   &lt;none&gt;   35d     v1.17.2+k3s1   192.168.10.14   Raspbian GNU/Linux 10 (buster)   4.19.93-v7l+        containerd://1.3.3-k3s1
pi-3   &lt;none&gt;   14m     v1.17.2+k3s1   192.168.10.20   Ubuntu 18.04.4 LTS               5.3.0-1017-raspi2   containerd://1.3.3-k3s1
pi-4   &lt;none&gt;   4d23h   v1.17.2+k3s1   192.168.10.19   Ubuntu 19.10                     5.3.0-1017-raspi2   containerd://1.3.3-k3s1
</code></pre><h3 id=update-2020-06-01>Update (2020-06-01)</h3><p>Ubuntu Server 20.04 is the recommended version of Ubuntu for Ri 4. It works perfectly fine:</p><pre><code>$ kubectl get node -o wide
NAME   ROLES    AGE     VERSION        INTERNAL-IP     OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME
pi-1   master   172d    v1.18.2+k3s1   192.168.10.41   Raspbian GNU/Linux 10 (buster)   4.19.118-v7l+      containerd://1.3.3-k3s2
pi-2   &lt;none&gt;   57d     v1.17.4+k3s1   192.168.10.42   Raspbian GNU/Linux 10 (buster)   4.19.118-v7l+      containerd://1.3.3-k3s2
pi-3   &lt;none&gt;   38d     v1.17.4+k3s1   192.168.10.43   Ubuntu 20.04 LTS                 5.4.0-1011-raspi   containerd://1.3.3-k3s2
pi-4   &lt;none&gt;   3d19h   v1.18.2+k3s1   192.168.10.44   Ubuntu 20.04 LTS                 5.4.0-1011-raspi   containerd://1.3.3-k3s2
</code></pre><p>Also Raspberry Pi OS (<em>ex-Raspbian</em>) for arm64 is currently in beta.</p><footer class=article-meta><time datetime=2020-01-11T12:00:00Z>January 11, 2020</time><span class=tag>raspberry pi</span><span class=tag>arm64</span><span class=tag>aarch64</span><span class=tag>k3s</span><span class=tag>kubernetes</span></footer></main><footer class=main-footer>© 2020 #SocialDistancing</footer><div><img src=https://raw.githubusercontent.com/narqo/narqo.github.io/master/1.gif style=position:absolute;left:-9999px alt></div></body></html>