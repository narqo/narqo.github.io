<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Does profefe prefers "push" over "pull"? - Vladimir Varankin</title><link rel=canonical href=https://vladimir.varank.in/notes/2020/08/does-profefe-prefers-push-over-pull/><meta property="og:title" content="Does profefe prefers &#34;push&#34; over &#34;pull&#34;?"><meta property="og:description" content="The main component of profefe, a system for continuous profiling, is profefe-collector — a service that receives profiling data, taken from an application and persists the data in collector’s storage (design document describes it in more details). Receiving data from an external source (for example, profefe-agent), indicates that profefe, as an observability system, prefers &ldquo;push&rdquo; model. Why not &ldquo;pulling&rdquo; the data direcly from the application?
Both push and pull models have their benefits and drawbacks.
A collector that pulls profiling data from running applications could simplify integration into existing infrastructure because there would be no need in making changes in the applications that already exposed pprof HTTP endpoint. Making sure that every application integrated and configured profefe-agent would be a challenging job in a large organisation.
On the other hand, pull model requires all applications to have a pprof server to be exposed and available for the collector, so it could fetch (pull) profiling data. This can also be challenging in the deployments, where applications are collocated on the bare-metal machines. Each application (application&rsquo;s instance) would have to communicate a unique TCP port for its pprof server. profefe started with the intent to collect profiling data in the production, where hundreds of instances of offline processes written in Go, were deployed on each of the hundreds of beefy, bare-metal hosts (and this deployment had its reasons to exist).
To work as a pull-system, the collector must being able to discover the pprof servers, thus it requires a mechanism for service discovery (SD) to be usable at scale. Unfortunately, there isn&rsquo;t a universal SD protocol or a provider, an observability system could be built upon.
Prometheus, the best example of a open-source system, which uses pull model for data collection, have to support many different SD systems in their code base. At some point they ended up introducing their own general protocol, that expects a &ldquo;middle-man-service&rdquo;, which translates the data from a SD system into a list of Prometheus targets (Update, this comment from u/bbrazil does a better job explaining the state of SD in Prometheus). There is no clear way for an open-source system to be both flexible and didn’t end up being a pile of &ldquo;plugins&rdquo;, that no one is willing to maintain or break.
From the start of profefe project, several years ago, I had the idea that translating push into pull would be easier for an end-user. That is if a small deployment already exposes a pprof server, writing an external job that pulls the profiles from the applications, annotes them with meta-data, and pushes the data into the collector can be as easy as spawning a cronjob in a sidecar. kube-profefe solves that nicely for deployments running in Kubernetes. At some point, I hoped to come up with something similar for Nomad+Consul if the experiments ended successfully.
Translating pull into push is a similarly possible but because profefe didn’t have to support any SD mechanisms from the start, that simplified the overall code surface and allowed us to focus on the collector and the API for profiles quering.
profefe-collector does prefer push over pull. But one can still deploy profefe so it reflected the use cases your organisation has.
Do you use continuous profiling? Let me know about your experience. Share your thoughts on Twitter or discuss on r/golang."><meta property="og:type" content="article"><meta property="og:url" content="https://vladimir.varank.in/notes/2020/08/does-profefe-prefers-push-over-pull/"><meta property="article:published_time" content="2020-08-21T00:00:00+00:00"><meta property="article:modified_time" content="2020-08-21T00:00:00+00:00"><style>:root{--background-color: #fff;--text-color: #111;--header-color: #111;--link-color: rgb(0, 16, 161);--link-underline-color: rgba(0, 16, 161, 0.3);--link-active-color: rgb(231, 19, 19);--link-active-underline-color: rgba(231, 19, 19, 0.7)}body{background:var(--background-color);color:var(--text-color);font-family:Charter,Georgia,serif;font-size:16px;line-height:1.5;margin:5px 12px}h1,h2,h3,h4,h5,h6{color:var(--header-color);font-family:Athelas,Georgia,serif;line-height:1;margin:1.5em 0 .7em}h1{font-size:40px;margin:.5em 0 .2em}a{color:#0010a1;color:var(--link-color);text-decoration-color:var(--link-underline-color)}a:hover,a:active{color:#be0000;color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}ul,ol{max-width:840px;padding:0}ul>li{list-style:none;margin:.5em 0}pre{line-height:1.4;margin:1em 1.5em}code{font-family:Menlo,Consolas,monospace;font-size:14px}pre code{font-size:13px}hr{border:none;border-bottom:1px solid;width:90%}.main-nav{display:flex;letter-spacing:.3em;padding-bottom:16px}.main-nav a,.main-nav span{margin-right:.6em;letter-spacing:0}.main-nav-item-active{color:var(--link-active-color);text-decoration-color:var(--link-active-underline-color)}.main-content{max-width:900px}.main-footer{margin:50px 0 0}.article{margin:0 0 50px}.article-head{font-size:28px}.article-head h1,.article-head h2{font-size:1em;margin-top:1em}.article-head h2{margin-bottom:0}.article-meta{font-size:14px;line-height:1;padding:5px 0 0}.tag{margin:0 0 0 7px}</style></head><body><nav class=main-nav><a href=/>Vladimir Varankin</a>
<a href=/notes/ class=main-nav-item-active>Notes</a>
<a href=/publications/>Publications</a>
<a href=https://github.com/narqo>GitHub</a>
<a href=https://twitter.com/tvii>Twitter</a>
<a href=https://keybase.io/varankinv>Keybase</a></nav><main class=main-content><header class=article-head><h1>Does profefe prefers "push" over "pull"?</h1></header><p>The main component of <a href=https://github.com/profefe/profefe>profefe, a system for continuous profiling</a>, is <em>profefe-collector</em> — a service that receives profiling data, taken from an application and persists the data in collector’s storage (<a href=https://github.com/profefe/profefe/blob/master/DESIGN.md>design document</a> describes it in more details). Receiving data from an external source (for example, <em>profefe-agent</em>), indicates that profefe, as an observability system, prefers &ldquo;push&rdquo; model. Why not &ldquo;pulling&rdquo; the data direcly from the application?</p><p>Both push and pull models have their benefits and drawbacks.</p><p>A collector that pulls profiling data from running applications could simplify integration into existing infrastructure because there would be no need in making changes in the applications that already exposed pprof HTTP endpoint. Making sure that every application integrated and configured profefe-agent would be a challenging job in a large organisation.</p><p>On the other hand, pull model requires all applications to have a pprof server to be exposed and available for the collector, so it could fetch (pull) profiling data. This can also be challenging in the deployments, where applications are collocated on the bare-metal machines. Each application (application&rsquo;s instance) would have to communicate a unique TCP port for its pprof server. profefe started with the intent to collect profiling data in the production, where hundreds of instances of offline processes written in Go, were deployed on each of the hundreds of beefy, bare-metal hosts (<em>and this deployment had its reasons to exist</em>).</p><p>To work as a pull-system, the collector must being able to discover the pprof servers, thus it requires a mechanism for service discovery (SD) to be usable at scale. Unfortunately, there isn&rsquo;t a universal SD protocol or a provider, an observability system could be built upon.</p><p>Prometheus, the best example of a open-source system, which uses pull model for data collection, have to support many different SD systems in their code base. At some point they <a href=https://prometheus.io/blog/2018/07/05/implementing-custom-sd/>ended up introducing their own general protocol</a>, that expects a &ldquo;middle-man-service&rdquo;, which translates the data from a SD system into a list of Prometheus targets (<em>Update, <a href="https://www.reddit.com/r/golang/comments/idwi4d/does_profefe_a_system_for_continuous_profiling/g2by237/?utm_source=reddit&utm_medium=web2x&context=3">this comment from u/bbrazil</a> does a better job explaining the state of SD in Prometheus</em>). There is no clear way for an open-source system to be both flexible and didn’t end up being a pile of &ldquo;plugins&rdquo;, that no one is willing to maintain or break.</p><p>From the start of profefe project, several years ago, I had the idea that translating push into pull would be easier for an end-user. That is if a small deployment already exposes a pprof server, writing an external job that pulls the profiles from the applications, annotes them with meta-data, and pushes the data into the collector can be as easy as spawning a cronjob in a sidecar. <a href=https://github.com/profefe/kube-profefe>kube-profefe</a> solves that nicely for deployments running in Kubernetes. At some point, I hoped to come up with something similar for Nomad+Consul if the experiments ended successfully.</p><p>Translating pull into push is a similarly possible but because profefe didn’t have to support any SD mechanisms from the start, that simplified the overall code surface and allowed us to focus on the collector and the <a href=https://github.com/profefe/profefe#http-api>API for profiles quering</a>.</p><p>profefe-collector does prefer push over pull. But one can still deploy profefe so it reflected the use cases your organisation has.</p><p>Do you use continuous profiling? Let me know about your experience. Share your thoughts <a href=https://twitter.com/tvii/status/1296796503781122049>on Twitter</a> or <a href=https://www.reddit.com/r/golang/comments/idwi4d/does_profefe_a_system_for_continuous_profiling/>discuss on r/golang</a>.</p><footer class=article-meta><time datetime=2020-08-21T12:00:00Z>August 21, 2020</time><span class=tag>profefe</span><span class=tag>go</span><span class=tag>pprof</span></footer></main><footer class=main-footer>© 2020 #SocialDistancing</footer><div><img src=https://raw.githubusercontent.com/narqo/narqo.github.io/master/1.gif style=position:absolute;left:-9999px alt></div></body></html>